<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Diagnostico Neoplasie Cerebrali v3.10.1 â€” Gliomi & Meningiomi | Pannello Diatech Extended</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:ital,wght@0,400;0,600;0,700;1,400&display=swap');

        :root {
            --bg: #f0f2f5;
            --surface: #ffffff;
            --surface2: #f7f8fa;
            --border: #dde1e9;
            --border-bright: #b0bcd0;
            --text: #1a2030;
            --text-dim: #5a6478;
            --text-bright: #0d1420;
            --blue: #1a5cc8;
            --blue-dim: #e4edfb;
            --green: #1a9954;
            --green-dim: #e4f5ec;
            --amber: #c07010;
            --amber-dim: #fef3e0;
            --red: #c02828;
            --red-dim: #fdeaea;
            --purple: #6b35cc;
            --purple-dim: #f0ebfc;
            --teal: #0d8a94;
            --teal-dim: #e0f5f7;
            --pink: #b0308a;
            --font-mono: 'IBM Plex Mono', monospace;
            --font-sans: 'IBM Plex Sans', sans-serif;

            /* Column accent colors - vivid for light bg */
            --col-clinica: #1a5cc8;
            --col-isto: #c02828;
            --col-ihc: #c07010;
            --col-ngs: #1a9954;
            --col-cnv: #0d8a94;
            --col-fusions: #6b35cc;
            --col-msi: #b0308a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1700px;
            margin: 0 auto;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, #1a3a78 0%, #2a1a6a 100%);
            border-bottom: 1px solid var(--border);
            padding: 24px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }

        .header-left h1 {
            font-family: var(--font-mono);
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            letter-spacing: -0.5px;
        }

        .header-left p {
            font-size: 12px;
            color: rgba(255,255,255,0.65);
            margin-top: 4px;
        }

        .header-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 4px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .badge-blue   { background: #dceeff; color: #1a4a9a; border: 1px solid #aaccee; }
        .badge-green  { background: #dcf5ea; color: #0d6635; border: 1px solid #99ddbb; }
        .badge-amber  { background: #fff0d0; color: #8a5000; border: 1px solid #ddbb77; }
        .badge-purple { background: #eedeff; color: #4a1a99; border: 1px solid #cc99ee; }
        .badge-teal   { background: #d8f5f7; color: #0a5f66; border: 1px solid #88ccdd; }

        /* CASE LOADER */
        .case-loader {
            background: #eef1f6;
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .case-loader label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .case-loader select {
            font-family: var(--font-sans);
            font-size: 12px;
            background: white;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 6px 10px;
            flex: 1;
            min-width: 200px;
        }

        .btn-load {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            background: var(--blue-dim);
            color: var(--blue);
            border: 1px solid #aaccee;
            border-radius: 4px;
            padding: 6px 14px;
            cursor: pointer;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .btn-load:hover { background: var(--blue); color: white; }

        .btn-reset-case {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            background: white;
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 6px 14px;
            cursor: pointer;
            letter-spacing: 0.5px;
            transition: all 0.2s;
        }
        .btn-reset-case:hover { background: var(--red-dim); color: var(--red); border-color: #f0bbbb; }

        /* MAIN GRID */
        .workflow-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            border-bottom: 1px solid var(--border);
            background: var(--border);
        }

        @media (max-width: 1400px) { .workflow-container { grid-template-columns: repeat(4, 1fr); } }
        @media (max-width: 900px) { .workflow-container { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .workflow-container { grid-template-columns: 1fr; } }

        .column {
            border-right: none;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .column:last-child { border-right: none; }

        .col-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2px;
        }

        .col-header h3 {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .col-accent {
            width: 3px;
            height: 16px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .col-clinica .col-accent  { background: var(--col-clinica); }
        .col-isto .col-accent     { background: var(--col-isto); }
        .col-ihc .col-accent      { background: var(--col-ihc); }
        .col-ngs-core .col-accent { background: var(--col-ngs); }
        .col-cnv .col-accent      { background: var(--col-cnv); }
        .col-fusions .col-accent  { background: var(--col-fusions); }
        .col-msi .col-accent      { background: var(--col-msi); }

        /* Column top-border color coding */
        .col-clinica  { border-top: 3px solid var(--col-clinica); }
        .col-isto     { border-top: 3px solid var(--col-isto); }
        .col-ihc      { border-top: 3px solid var(--col-ihc); }
        .col-ngs-core { border-top: 3px solid var(--col-ngs); }
        .col-cnv      { border-top: 3px solid var(--col-cnv); }
        .col-fusions  { border-top: 3px solid var(--col-fusions); }
        .col-msi      { border-top: 3px solid var(--col-msi); }

        /* Column background tints for visual separation */
        .col-clinica  { background: #f5f7fc; }
        .col-isto     { background: #fdf5f5; }
        .col-ihc      { background: #fdf8f0; }
        .col-ngs-core { background: #f3faf6; }
        .col-cnv      { background: #f0fafb; }
        .col-fusions  { background: #f7f3fe; }
        .col-msi      { background: #fdf0f8; }

        .col-clinica .col-header  { background: rgba(26,92,200,0.07); border-radius: 4px; padding: 6px 8px; margin: -4px -4px 6px; }
        .col-isto .col-header     { background: rgba(192,40,40,0.07); border-radius: 4px; padding: 6px 8px; margin: -4px -4px 6px; }
        .col-ihc .col-header      { background: rgba(192,112,16,0.07); border-radius: 4px; padding: 6px 8px; margin: -4px -4px 6px; }
        .col-ngs-core .col-header { background: rgba(26,153,84,0.07); border-radius: 4px; padding: 6px 8px; margin: -4px -4px 6px; }
        .col-cnv .col-header      { background: rgba(13,138,148,0.07); border-radius: 4px; padding: 6px 8px; margin: -4px -4px 6px; }
        .col-fusions .col-header  { background: rgba(107,53,204,0.07); border-radius: 4px; padding: 6px 8px; margin: -4px -4px 6px; }
        .col-msi .col-header      { background: rgba(176,48,138,0.07); border-radius: 4px; padding: 6px 8px; margin: -4px -4px 6px; }

        /* FORM FIELDS */
        .field-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .field-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .field-label span.new-tag {
            background: var(--teal-dim);
            color: var(--teal);
            font-size: 8px;
            padding: 1px 4px;
            border-radius: 2px;
            margin-left: 4px;
            border: 1px solid #88ccdd;
        }

        select, input[type="number"] {
            font-family: var(--font-sans);
            font-size: 11px;
            background: white;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 5px 8px;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(26,92,200,0.12);
        }

        .help-text {
            font-size: 9px;
            color: var(--text-dim);
            font-style: italic;
            line-height: 1.4;
        }

        .diatech-note {
            font-size: 9px;
            color: var(--teal);
            background: var(--teal-dim);
            padding: 3px 6px;
            border-radius: 3px;
            border-left: 2px solid var(--teal);
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .checkbox-row input[type="checkbox"] {
            width: auto;
            accent-color: var(--blue);
        }

        .checkbox-row label {
            font-size: 11px;
            color: var(--text);
            cursor: pointer;
        }

        .section-divider {
            font-family: var(--font-mono);
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 4px 0 2px;
            border-top: 1px dashed var(--border);
            margin-top: 4px;
        }

        /* ACTIONS */
        .actions-bar {
            padding: 16px 24px;
            background: #eef1f6;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            padding: 10px 20px;
            border-radius: 4px;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #1a3a78;
            color: white;
            border-color: #1a3a78;
        }
        .btn-primary:hover { background: #1a5cc8; }

        .btn-secondary {
            background: white;
            color: var(--text-dim);
            border-color: var(--border);
        }
        .btn-secondary:hover { border-color: var(--text-dim); color: var(--text); }

        .btn-export {
            background: var(--green-dim);
            color: var(--green);
            border-color: #99ddbb;
        }
        .btn-export:hover { background: var(--green); color: white; }

        /* DIAGNOSIS OUTPUT */
        .diagnosis-section {
            padding: 24px;
            background: white;
        }

        #report-container { margin-top: 16px; }

        .alert {
            font-size: 12px;
            padding: 10px 14px;
            border-radius: 4px;
            margin-bottom: 8px;
            border-left: 3px solid;
            font-family: var(--font-sans);
            line-height: 1.5;
        }

        .alert-warning  { background: #fff8e8; border-color: var(--amber); color: #7a4a00; }
        .alert-success  { background: #edfaf4; border-color: var(--green); color: #0d5530; }
        .alert-info     { background: #eef4ff; border-color: var(--blue);  color: #1a3a78; }
        .alert-critical { background: #fdeaea; border-color: var(--red);   color: #8a1a1a; }
        .alert-actionable { background: #f4eeff; border-color: var(--purple); color: #3a1a7a; }

        .diagnosis-box {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
        }

        .diagnosis-box h3 {
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .diagnosis-entity {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-bright);
            line-height: 1.3;
            margin-bottom: 6px;
        }

        .diagnosis-grade {
            font-family: var(--font-mono);
            font-size: 14px;
            color: var(--amber);
            margin-bottom: 4px;
        }

        .scoring-container {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
        }

        .scoring-container h3 {
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }

        .scoring-row { margin-bottom: 14px; }

        .scoring-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .scoring-bar-bg {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .scoring-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .summary-table td {
            padding: 7px 10px;
            border-bottom: 1px solid var(--border);
        }

        .summary-table td:first-child {
            font-weight: 600;
            color: var(--text-dim);
            width: 45%;
            font-family: var(--font-mono);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .summary-table td:last-child { color: var(--text-bright); }

        .actionable-banner {
            background: linear-gradient(90deg, #f0eaff, #eaf0ff);
            border: 1px solid #c0aaee;
            border-radius: 6px;
            padding: 12px 16px;
            margin: 8px 0;
        }

        .actionable-banner .title {
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
            color: var(--purple);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .actionable-banner .content {
            font-size: 12px;
            color: var(--text);
        }

        /* MSI BADGE */
        .msi-high {
            display: inline-block;
            background: var(--green-dim);
            color: var(--green);
            border: 1px solid #1a5a36;
            font-family: var(--font-mono);
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 3px;
        }

        /* BIBLIOGRAPHY */
        .biblio-section {
            padding: 24px;
            background: #f7f8fa;
            border-top: 1px solid var(--border);
        }

        .biblio-section h3 {
            font-family: var(--font-mono);
            font-size: 12px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }

        .biblio-category {
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 10px;
            overflow: hidden;
            transition: border-color 0.3s;
        }

        .biblio-category.has-relevant { border-color: var(--amber); box-shadow: 0 2px 8px rgba(192,112,16,0.1); }

        .biblio-category-header {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface2);
        }

        .biblio-category-header:hover { background: var(--border); }

        .biblio-category-title {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .biblio-category-toggle {
            font-size: 12px;
            color: var(--text-dim);
            transition: transform 0.3s;
        }

        .biblio-category.expanded .biblio-category-toggle { transform: rotate(180deg); }

        .biblio-category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .biblio-category.expanded .biblio-category-content { max-height: 3000px; }

        .biblio-reference {
            padding: 14px 16px;
            border-top: 1px solid var(--border);
            transition: background 0.2s;
        }

        .biblio-reference.relevant {
            background: #fffbf0;
            border-left: 3px solid var(--amber);
        }

        .biblio-reference-authors {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-bright);
            margin-bottom: 4px;
        }

        .biblio-reference-title {
            font-size: 11px;
            color: var(--text);
            margin-bottom: 4px;
            line-height: 1.5;
        }

        .biblio-reference-journal {
            font-size: 10px;
            color: var(--text-dim);
            font-style: italic;
            margin-bottom: 8px;
        }

        .biblio-reference-abstract {
            background: var(--surface2);
            padding: 8px 10px;
            border-radius: 4px;
            font-size: 10px;
            color: var(--text-dim);
            line-height: 1.6;
            margin-bottom: 8px;
            display: none;
        }

        .biblio-reference.show-abstract .biblio-reference-abstract { display: block; }

        .biblio-reference-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .biblio-doi-link, .biblio-pmid-link {
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 3px;
            text-decoration: none;
            transition: all 0.2s;
        }

        .biblio-doi-link  { background: var(--blue-dim); color: var(--blue); border: 1px solid #aaccee; }
        .biblio-doi-link:hover { background: var(--blue); color: white; }

        .biblio-pmid-link { background: var(--green-dim); color: var(--green); border: 1px solid #99ddbb; }
        .biblio-pmid-link:hover { background: var(--green); color: white; }

        .biblio-relevance-badge {
            font-family: var(--font-mono);
            font-size: 9px;
            font-weight: 600;
            padding: 2px 6px;
            background: var(--amber-dim);
            color: var(--amber);
            border: 1px solid #ddbb77;
            border-radius: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .biblio-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .biblio-tag {
            font-family: var(--font-mono);
            font-size: 9px;
            padding: 2px 6px;
            background: var(--surface2);
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 2px;
        }

        .abstract-toggle {
            font-family: var(--font-mono);
            font-size: 10px;
            background: none;
            border: none;
            color: var(--blue);
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
            text-transform: none;
            letter-spacing: 0;
        }

        #relevance-badge {
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 3px;
            background: var(--amber-dim);
            color: var(--amber);
            border: 1px solid #ddbb77;
        }

        .disclaimer {
            font-size: 10px;
            color: #8a1a1a;
            background: #fdeaea;
            border: 1px solid #f0bbbb;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 12px;
        }

        /* ============================================================
           TUMOR SELECTOR
        ============================================================ */
        .tumor-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
            align-items: center;
        }
        .tumor-selector label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-right: 6px;
        }
        .tumor-btn {
            padding: 7px 18px;
            border-radius: 6px;
            border: 1.5px solid var(--border);
            background: var(--surface2);
            color: var(--text-dim);
            font-family: var(--font-sans);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .tumor-btn:hover { border-color: var(--blue); color: var(--blue); }
        .tumor-btn.active-glioma { background: #e4edfb; border-color: var(--blue); color: var(--blue); }
        .tumor-btn.active-meningioma { background: #e8f5f0; border-color: #0a7c5c; color: #0a7c5c; }

        /* ============================================================
           MENINGIOMA MODULE
        ============================================================ */
        #meningioma-section { display: none; }
        #glioma-section { display: block; }

        .men-col-clinica  { border-top: 3px solid #0a7c5c; background: #f2faf7; }
        .men-col-isto     { border-top: 3px solid #b5451b; background: #fdf6f3; }
        .men-col-ihc      { border-top: 3px solid #c07010; background: #fdf8f0; }
        .men-col-mol      { border-top: 3px solid #6b35cc; background: #f7f3fe; }

        .men-col-clinica .col-header  { background: rgba(10,124,92,0.07); border-radius: 4px; padding: 6px 8px; margin: -4px -4px 6px; }
        .men-col-isto .col-header     { background: rgba(181,69,27,0.07); border-radius: 4px; padding: 6px 8px; margin: -4px -4px 6px; }
        .men-col-ihc .col-header      { background: rgba(192,112,16,0.07); border-radius: 4px; padding: 6px 8px; margin: -4px -4px 6px; }
        .men-col-mol .col-header      { background: rgba(107,53,204,0.07); border-radius: 4px; padding: 6px 8px; margin: -4px -4px 6px; }

        .mol-toggle {
            font-size: 11px;
            color: var(--purple);
            background: var(--purple-dim);
            border: 1px solid var(--purple);
            border-radius: 4px;
            padding: 3px 10px;
            cursor: pointer;
            margin-top: 4px;
            display: inline-block;
        }
        .mol-optional { display: none; }
        .mol-optional.visible { display: block; }

        .criteria-counter {
            font-size: 11px;
            font-family: var(--font-mono);
            background: var(--amber-dim);
            color: var(--amber);
            border: 1px solid var(--amber);
            border-radius: 4px;
            padding: 4px 10px;
            margin: 8px 0 4px;
            display: inline-block;
        }
        /* ============================================================
           MODAL CONSENSO + CONFIRMATION GATE
        ============================================================ */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(10,16,30,0.75);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }
        .modal-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 32px 36px;
            max-width: 560px;
            width: 90%;
            box-shadow: 0 24px 60px rgba(0,0,0,0.25);
        }
        .modal-box h2 { font-size: 18px; color: var(--red); margin-bottom: 8px; }
        .modal-box p { font-size: 13px; color: var(--text); line-height: 1.65; margin-bottom: 14px; }
        .modal-box .modal-checks { background: var(--surface2); border-radius: 8px; padding: 16px; margin-bottom: 18px; }
        .modal-check-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; font-size: 13px; color: var(--text); cursor: pointer; line-height: 1.5; }
        .modal-check-row:last-child { margin-bottom: 0; }
        .modal-check-row input[type=checkbox] { margin-top: 2px; accent-color: var(--blue); flex-shrink: 0; }
        .modal-btn-enter {
            width: 100%; padding: 12px; border-radius: 8px;
            background: var(--blue); color: #fff; border: none;
            font-family: var(--font-sans); font-size: 14px; font-weight: 700;
            cursor: pointer; opacity: 0.4; pointer-events: none; transition: all 0.2s;
        }
        .modal-btn-enter.active { opacity: 1; pointer-events: all; }
        .modal-btn-enter.active:hover { background: #1448a0; }

        /* Pre-generate gate */
        .generate-gate {
            background: var(--amber-dim); border: 1px solid var(--amber);
            border-radius: 8px; padding: 10px 14px; font-size: 12px;
            color: var(--amber); margin-bottom: 8px; display: none;
        }
        .generate-gate.visible { display: block; }

    </style>
</head>
<body>

<!-- ============================================================
     MODAL CONSENSO â€” bloccante al primo avvio
============================================================ -->
<div class="modal-overlay" id="consent-modal">
    <div class="modal-box">
        <h2>âš  Prima di accedere allo strumento</h2>
        <p>Questo tool Ã¨ un <strong>ausilio didattico per la formazione in neuropatologia</strong>. Esegue pattern matching su regole WHO CNS5 2021 â€” non Ã¨ un sistema diagnostico certificato e non sostituisce il giudizio clinico-patologico.</p>
        <div class="modal-checks">
            <label class="modal-check-row">
                <input type="checkbox" id="chk1" onchange="checkConsent()">
                Sono un professionista sanitario, studente di medicina o ricercatore che utilizza questo strumento <strong>esclusivamente a scopo didattico</strong>.
            </label>
            <label class="modal-check-row">
                <input type="checkbox" id="chk2" onchange="checkConsent()">
                Comprendo che l'output non costituisce diagnosi, non Ã¨ validato clinicamente e <strong>non deve essere usato per refertazione o decisioni terapeutiche</strong> su pazienti reali.
            </label>
            <label class="modal-check-row">
                <input type="checkbox" id="chk3" onchange="checkConsent()">
                So che ogni risultato richiede correlazione con morfologia EE, contesto clinico-radiologico e giudizio di un neuropatologo certificato.
            </label>
        </div>
        <button class="modal-btn-enter" id="consent-btn" onclick="acceptConsent()">Accetto â€” Entra nello strumento</button>
    </div>
</div>

<div class="container">

    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <h1>ðŸ§  NEOPLASIE CEREBRALI // v3.10.1</h1>
            <p>WHO CNS5 2021 Â· Gliomi & Meningiomi Â· Workflow integrato morfologia â†’ IHC â†’ NGS Â· Pannello Diatech Pharmacogenetics</p>
        </div>
        <div class="header-badges">
            <span class="badge badge-blue">WHO CNS5</span>
            <span class="badge badge-green">SNV / InsDEL</span>
            <span class="badge badge-teal">CNV</span>
            <span class="badge badge-purple">Fusioni</span>
            <span class="badge badge-amber">MSI</span>
        </div>
    </div>

    <!-- TUMOR SELECTOR -->
    <div class="tumor-selector">
        <label>Tipo tumore:</label>
        <button class="tumor-btn active-glioma" id="btn-glioma" onclick="switchTumor('glioma')">ðŸ§¬ Gliomi / PCNSL</button>
        <button class="tumor-btn" id="btn-meningioma" onclick="switchTumor('meningioma')">ðŸ”µ Meningiomi</button>
    </div>

    <!-- ============================================================
         GLIOMA SECTION (existing)
    ============================================================ -->
    <div id="glioma-section">
    <div class="case-loader">
        <label>Caso precaricato:</label>
        <select id="case-select">
            <option value="">-- Seleziona --</option>
            <option value="case1">Caso 1 â€” Astrocitoma IDH-mutato Gr.3</option>
            <option value="case2">Caso 2 â€” Oligodendroglioma IDH-mut 1p/19q-codel</option>
            <option value="case3">Caso 3 â€” GBM IDH-wt con EGFR amp + PTEN loss</option>
            <option value="case4">Caso 4 â€” Glioma linea mediana pediatrico H3K27M</option>
            <option value="case5">Caso 5 â€” Glioma NTRK-fusion (actionable)</option>
        </select>
        <button class="btn-load" onclick="loadCase()">Carica</button>
        <button class="btn-reset-case" onclick="resetForm()">â†º Nuovo caso</button>
    </div>

    <!-- WORKFLOW GRID -->
    <div class="workflow-container">

        <!-- COL 1: CLINICA -->
        <div class="column col-clinica">
            <div class="col-header">
                <div class="col-accent"></div>
                <h3>ðŸ‘¤ Clinica</h3>
            </div>
            <div class="field-group">
                <div class="field-label">EtÃ  (anni)</div>
                <input type="number" id="age" placeholder="es. 45" min="0" max="100">
            </div>
            <div class="field-group">
                <div class="field-label">Sede</div>
                <select id="location">
                    <option value="">â€”</option>
                    <option value="emisfero">Emisfero</option>
                    <option value="linea-mediana">Linea mediana/ponte</option>
                    <option value="midline">Midline (III ventricolo)</option>
                    <option value="cervelletto">Cervelletto/fossa post.</option>
                    <option value="spinale">Midollo spinale</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">MRI Pattern</div>
                <select id="imaging">
                    <option value="">â€”</option>
                    <option value="not-done">N.E.</option>
                    <option value="enhancement">Enhancement omogeneo</option>
                    <option value="heterogeneous">Enhancement eterogeneo</option>
                    <option value="ring">Anello + necrosi</option>
                    <option value="diffuse">Infiltrante diffuso</option>
                    <option value="midline-diffuse">Diffuso linea mediana</option>
                </select>
            </div>
        </div>

        <!-- COL 2: ISTOLOGIA -->
        <div class="column col-isto">
            <div class="col-header">
                <div class="col-accent"></div>
                <h3>ðŸ”¬ Istologia EE</h3>
            </div>
            <div class="field-group">
                <div class="field-label">CellularitÃ </div>
                <select id="cellularity">
                    <option value="">â€”</option>
                    <option value="low">Bassa</option>
                    <option value="moderate">Moderata</option>
                    <option value="high">Alta</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">Atipia nucleare</div>
                <select id="atypia">
                    <option value="">â€”</option>
                    <option value="scarse">Scarse</option>
                    <option value="moderate">Moderate</option>
                    <option value="numerose">Numerose</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">Mitosi / 10 HPF</div>
                <input type="number" id="mitosis" placeholder="es. 5" min="0" max="100">
                <div class="help-text">Gr.2 &lt;4 | Gr.3 4-9 | Gr.4 â‰¥10</div>
            </div>
            <div class="field-group">
                <div class="field-label">Pattern cellulare</div>
                <select id="celltype">
                    <option value="">â€”</option>
                    <option value="astrocytic">Astrocitario</option>
                    <option value="oligodendroglial">Oligodendroglia</option>
                    <option value="mixed">Misto</option>
                    <option value="glioblastic">Glioblastico</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">Architettura</div>
                <div class="checkbox-row"><input type="checkbox" id="hist-necrosis"><label for="hist-necrosis">Necrosi</label></div>
                <div class="checkbox-row"><input type="checkbox" id="hist-microvascular"><label for="hist-microvascular">Prolif. microvascolare</label></div>
            </div>
        </div>

        <!-- COL 3: IHC -->
        <div class="column col-ihc">
            <div class="col-header">
                <div class="col-accent"></div>
                <h3>ðŸ”µ IHC</h3>
            </div>
            <div class="field-group">
                <div class="field-label">IDH1 R132H</div>
                <select id="idh-ihc">
                    <option value="">â€”</option>
                    <option value="positive">Positivo</option>
                    <option value="negative">Negativo</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">ATRX</div>
                <select id="atrx">
                    <option value="">â€”</option>
                    <option value="retained">Conservato (wt)</option>
                    <option value="lost">Perso (mut)</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">p53 (%)</div>
                <input type="number" id="p53" placeholder="0-100" min="0" max="100">
                <div class="help-text">&gt;10% = accumulo (suggestivo mut TP53)</div>
            </div>
            <div class="field-group">
                <div class="field-label">OLIG2</div>
                <select id="olig2">
                    <option value="">â€”</option>
                    <option value="positive">Positivo</option>
                    <option value="negative">Negativo</option>
                    <option value="partial">Focale</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">H3K27me3</div>
                <select id="h3k27me3">
                    <option value="">â€”</option>
                    <option value="retained">Conservato</option>
                    <option value="lost">Perso (H3K27-alt)</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">GFAP</div>
                <select id="gfap">
                    <option value="">â€”</option>
                    <option value="positive">Positivo</option>
                    <option value="negative">Negativo</option>
                    <option value="partial">Focale</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">Ki-67 (%)</div>
                <input type="number" id="ki67" placeholder="0-100" min="0" max="100">
            </div>
        </div>

        <!-- COL 4: NGS CORE -->
        <div class="column col-ngs-core">
            <div class="col-header">
                <div class="col-accent"></div>
                <h3>ðŸ§¬ NGS â€” Core</h3>
            </div>
            <div class="field-group">
                <div class="field-label">IDH1/2 (NGS)</div>
                <select id="idh-ngs">
                    <option value="">â€”</option>
                    <option value="mut-r132h">Mutato: IDH1 R132H</option>
                    <option value="mut-idh2">Mutato: IDH2</option>
                    <option value="mut-other">Mutato: altra mut.</option>
                    <option value="wildtype">Wild-type</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">TP53</div>
                <select id="tp53-ngs">
                    <option value="">â€”</option>
                    <option value="mutato">Mutato</option>
                    <option value="wildtype">Wild-type</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">1p/19q (NGS/FISH)</div>
                <select id="1p19q">
                    <option value="">â€”</option>
                    <option value="codeleted">Codeleted</option>
                    <option value="not-codeleted">Non codeleted</option>
                    <option value="partial">Parziale/ambiguo</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">TERT promoter</div>
                <select id="tert">
                    <option value="">â€”</option>
                    <option value="mutato">Mutato (C228T/C250T)</option>
                    <option value="wildtype">Wild-type</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">H3F3A</div>
                <select id="h3f3a">
                    <option value="">â€”</option>
                    <option value="k27m">K27M</option>
                    <option value="g34r">G34R</option>
                    <option value="g34w">G34W</option>
                    <option value="wildtype">Wild-type</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">CDKN2A/B</div>
                <select id="cdkn2a">
                    <option value="">â€”</option>
                    <option value="homozygous-del">Del. omozigote (â†’Gr.4)</option>
                    <option value="heterozygous-del">Del. eterozigote</option>
                    <option value="wildtype">Wild-type</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="section-divider">Pathway PI3K / mTOR</div>
            <div class="field-group">
                <div class="field-label">PIK3CA <span class="new-tag">NEW</span></div>
                <select id="pik3ca">
                    <option value="">â€”</option>
                    <option value="mutato">Mutato</option>
                    <option value="wildtype">Wild-type</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">PTEN <span class="new-tag">NEW</span></div>
                <select id="pten">
                    <option value="">â€”</option>
                    <option value="loss">Loss / mutato</option>
                    <option value="wildtype">Wild-type</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">PTEN loss: frequentemente associato a GBM IDH-wt mesenchimale (non deterministico)</div>
            </div>
            <div class="field-group">
                <div class="field-label">NF1 <span class="new-tag">NEW</span></div>
                <select id="nf1">
                    <option value="">â€”</option>
                    <option value="mutato">Mutato</option>
                    <option value="wildtype">Wild-type</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">NF1 loss â†’ Mesenchymal subtype GBM</div>
            </div>
            <div class="field-group">
                <div class="field-label">MTOR <span class="new-tag">NEW</span></div>
                <select id="mtor">
                    <option value="">â€”</option>
                    <option value="mutato">Mutato (gain-of-function)</option>
                    <option value="wildtype">Wild-type</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="section-divider">Predittivi</div>
            <div class="field-group">
                <div class="field-label">MGMT metilazione</div>
                <select id="mgmt">
                    <option value="">â€”</option>
                    <option value="not-done">N.E.</option>
                    <option value="methylated">Metilato</option>
                    <option value="unmethylated">Non metilato</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">POLE / POLD1 <span class="new-tag">NEW</span></div>
                <select id="pole">
                    <option value="">â€”</option>
                    <option value="mutato">Mutato (ultramutator)</option>
                    <option value="wildtype">Wild-type</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">POLE mut â†’ ultramutator / TMB molto alta â†’ candidato immunoterapia (anche se MSS)</div>
            </div>
        </div>

        <!-- COL 5: CNV -->
        <div class="column col-cnv">
            <div class="col-header">
                <div class="col-accent"></div>
                <h3>ðŸ“ˆ CNV <span class="badge badge-teal" style="font-size:8px; padding:2px 6px;">Diatech</span></h3>
            </div>
            <div class="diatech-note">Pannello Diatech: EGFR Â· ERBB2 Â· MET</div>
            <div class="field-group">
                <div class="field-label">EGFR (CNV)</div>
                <select id="egfr-cnv">
                    <option value="">â€”</option>
                    <option value="amplified">Amplificato (â‰¥6 copie)</option>
                    <option value="gain">Gain (3-5 copie)</option>
                    <option value="normal">Normale</option>
                    <option value="loss">Loss</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">Amp + IDH-wt + TERT mut = GBM molecolare (cIMPACT-NOW)</div>
            </div>
            <div class="field-group">
                <div class="field-label">EGFR mut (SNV)</div>
                <select id="egfr-snv">
                    <option value="">â€”</option>
                    <option value="vIII">EGFRvIII (exon 2-7 del)</option>
                    <option value="other-mut">Altra mut. EGFR</option>
                    <option value="wildtype">Wild-type</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">ERBB2 (CNV) <span class="new-tag">NEW</span></div>
                <select id="erbb2-cnv">
                    <option value="">â€”</option>
                    <option value="amplified">Amplificato</option>
                    <option value="gain">Gain</option>
                    <option value="normal">Normale</option>
                    <option value="loss">Loss</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">Raro nei gliomi; piÃ¹ frequente in GBM pediatrico</div>
            </div>
            <div class="field-group">
                <div class="field-label">MET (CNV) <span class="new-tag">NEW</span></div>
                <select id="met-cnv">
                    <option value="">â€”</option>
                    <option value="amplified">Amplificato (alta amp.)</option>
                    <option value="gain">Gain (bassa amp.)</option>
                    <option value="normal">Normale</option>
                    <option value="loss">Loss</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">MET amp â†’ prognosi infausta in GBM; target sperimentale</div>
            </div>
            <div class="section-divider">Chr +7 / -10 pattern</div>
            <div class="field-group">
                <div class="field-label">+7 / -10 <span class="new-tag">NEW</span></div>
                <select id="chr7-10">
                    <option value="">â€”</option>
                    <option value="present">Presente (+7 gain / -10 loss)</option>
                    <option value="partial">Parziale</option>
                    <option value="absent">Assente</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">+7/-10 + IDH-wt + TERT mut â†’ GBM molecolare anche senza necrosi</div>
            </div>
            <div class="section-divider">BRAF (pediatric LGG)</div>
            <div class="field-group">
                <div class="field-label">BRAF <span class="new-tag">NEW</span></div>
                <select id="braf">
                    <option value="">â€”</option>
                    <option value="v600e">V600E mut</option>
                    <option value="fusion">BRAF-KIAA1549 fusion</option>
                    <option value="other">Altra mut/fusione</option>
                    <option value="wildtype">Wild-type</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">BRAF-KIAA fusion â†’ Pilocytic Astrocytoma Gr.1 | V600E â†’ target dabrafenib</div>
            </div>
        </div>

        <!-- COL 6: FUSIONI -->
        <div class="column col-fusions">
            <div class="col-header">
                <div class="col-accent"></div>
                <h3>ðŸ”€ Fusioni <span class="badge badge-purple" style="font-size:8px; padding:2px 6px;">Diatech</span></h3>
            </div>
            <div class="diatech-note">Pannello Diatech: ALK Â· FGFR1/2/3 Â· MET Â· NRG1 Â· NTRK1/2/3 Â· PPARG Â· RET Â· ROS1</div>
            <div class="field-group">
                <div class="field-label">NTRK1/2/3 fusion <span class="new-tag">ACTIONABLE</span></div>
                <select id="ntrk-fusion">
                    <option value="">â€”</option>
                    <option value="ntrk1">NTRK1 fusion</option>
                    <option value="ntrk2">NTRK2 fusion</option>
                    <option value="ntrk3">NTRK3 fusion</option>
                    <option value="negative">Negativo</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">Target: larotrectinib / entrectinib (approvati tumor-agnostic)</div>
            </div>
            <div class="field-group">
                <div class="field-label">RET fusion <span class="new-tag">ACTIONABLE</span></div>
                <select id="ret-fusion">
                    <option value="">â€”</option>
                    <option value="positive">Positivo</option>
                    <option value="negative">Negativo</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">Target: selpercatinib / pralsetinib (off-label SNC)</div>
            </div>
            <div class="field-group">
                <div class="field-label">ROS1 fusion <span class="new-tag">ACTIONABLE</span></div>
                <select id="ros1-fusion">
                    <option value="">â€”</option>
                    <option value="positive">Positivo</option>
                    <option value="negative">Negativo</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">Target: entrectinib / crizotinib</div>
            </div>
            <div class="field-group">
                <div class="field-label">ALK fusion</div>
                <select id="alk-fusion">
                    <option value="">â€”</option>
                    <option value="positive">Positivo</option>
                    <option value="negative">Negativo</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">Raro in gliomi. Target: alectinib/lorlatinib</div>
            </div>
            <div class="field-group">
                <div class="field-label">NRG1 fusion <span class="new-tag">NEW</span></div>
                <select id="nrg1-fusion">
                    <option value="">â€”</option>
                    <option value="positive">Positivo</option>
                    <option value="negative">Negativo</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">NRG1-fused gliomas: entitÃ  emergente (WHO CNS5 review pending)</div>
            </div>
            <div class="field-group">
                <div class="field-label">FGFR fusion</div>
                <select id="fgfr-fusion">
                    <option value="">â€”</option>
                    <option value="fgfr1-tacc1">FGFR1-TACC1</option>
                    <option value="fgfr3-tacc3">FGFR3-TACC3</option>
                    <option value="other">Altra fusione FGFR</option>
                    <option value="negative">Negativo</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">FGFR-TACC: frequente in GBM IDH-wt (~3%); target sperimentale</div>
            </div>
            <div class="field-group">
                <div class="field-label">MET fusion / exon skip</div>
                <select id="met-fusion">
                    <option value="">â€”</option>
                    <option value="fusion">MET fusion</option>
                    <option value="exon14">Exon 14 skipping</option>
                    <option value="negative">Negativo</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
        </div>

        <!-- COL 7: MSI -->
        <div class="column col-msi">
            <div class="col-header">
                <div class="col-accent"></div>
                <h3>ðŸ” MSI <span class="badge badge-amber" style="font-size:8px; padding:2px 6px;">Diatech</span></h3>
            </div>
            <div class="diatech-note">Pannello Bethesda esteso: BAT25 Â· BAT26 Â· CAT25 + 118 marker mononucleotidici</div>
            <div class="field-group">
                <div class="field-label">Stato MSI</div>
                <select id="msi-status">
                    <option value="">â€”</option>
                    <option value="msi-h">MSI-H (alta instabilitÃ )</option>
                    <option value="msi-l">MSI-L (bassa instabilitÃ )</option>
                    <option value="mss">MSS (stabile)</option>
                    <option value="not-done">N.E.</option>
                </select>
                <div class="help-text">MSI-H nei gliomi: raro, considerare MMR-deficient glioma o sindrome Lynch</div>
            </div>
            <div class="field-group">
                <div class="field-label">MMR (IHC)</div>
                <select id="mmr-ihc">
                    <option value="">â€”</option>
                    <option value="intact">Intatto (MLH1/MSH2/MSH6/PMS2)</option>
                    <option value="mlh1-loss">MLH1 loss</option>
                    <option value="msh2-loss">MSH2 loss</option>
                    <option value="msh6-loss">MSH6 loss</option>
                    <option value="pms2-loss">PMS2 loss</option>
                    <option value="multi-loss">Loss multipla</option>
                    <option value="not-done">N.E.</option>
                </select>
            </div>
            <div class="field-group">
                <div class="field-label">TMB (mut/Mb)</div>
                <input type="number" id="tmb" placeholder="es. 10" min="0" max="200">
                <div class="help-text">TMB-H: â‰¥10 mut/Mb | Cut-off FDA pembrolizumab</div>
            </div>
            <div class="section-divider">Lynch / germline</div>
            <div class="field-group">
                <div class="field-label">Sospetto Lynch</div>
                <select id="lynch">
                    <option value="">â€”</option>
                    <option value="yes">SÃ¬ (storia familiare / etÃ )</option>
                    <option value="no">No</option>
                    <option value="not-assessed">Non valutato</option>
                </select>
                <div class="help-text">Gliomi in Lynch: MLH1/MSH2 most common. Counseling genetico</div>
            </div>
        </div>

    </div><!-- end workflow-container -->

    <!-- ACTIONS -->
    <div class="actions-bar">
        <div id="glioma-gate" class="generate-gate"></div>
        <button class="btn btn-primary" onclick="guardedGenerate()">â–¶ Genera ipotesi classificativa</button>
        <button class="btn btn-secondary" onclick="resetForm()">â†º Reset</button>
        <button class="btn btn-export" onclick="exportPDF()">â†“ Esporta PDF</button>
    </div>

    <!-- OUTPUT -->
    <div class="diagnosis-section">
        <div id="report-container"></div>
    </div>

    </div><!-- /glioma-section -->

    <!-- ============================================================
         MENINGIOMA SECTION
    ============================================================ -->
    <div id="meningioma-section">

        <!-- CASE LOADER MENINGIOMA -->
        <div class="case-loader">
            <label>Caso precaricato:</label>
            <select id="men-case-select">
                <option value="">-- Seleziona --</option>
                <option value="men1">Caso M1 â€” Meningioma Gr.1 classico</option>
                <option value="men2">Caso M2 â€” Meningioma atipico (Gr.2)</option>
                <option value="men3">Caso M3 â€” Meningioma anaplastico (Gr.3)</option>
                <option value="men4">Caso M4 â€” Meningioma rhabdoide â†’ Gr.3 implicito</option>
                <option value="men5">Caso M5 â€” Upgrade molecolare TERT + CDKN2A</option>
            </select>
            <button class="btn-load" onclick="loadMenCase()">Carica</button>
            <button class="btn-reset-case" onclick="resetMenForm()">â†º Nuovo caso</button>
        </div>

        <!-- MENINGIOMA WORKFLOW GRID -->
        <div class="workflow-container" style="grid-template-columns: repeat(4, 1fr);">

            <!-- COL 1: CLINICA -->
            <div class="column men-col-clinica">
                <div class="col-header"><div class="col-accent"></div><h3>ðŸ‘¤ Clinica</h3></div>
                <div class="field-group">
                    <div class="field-label">EtÃ  (anni)</div>
                    <input type="number" id="men-age" placeholder="es. 58" min="0" max="100">
                </div>
                <div class="field-group">
                    <div class="field-label">Sede</div>
                    <select id="men-location">
                        <option value="">â€”</option>
                        <option value="convessita">ConvessitÃ </option>
                        <option value="falx">Falx / parasagittale</option>
                        <option value="base-cranica">Base cranica</option>
                        <option value="ala-sfenoidale">Ala sfenoidale</option>
                        <option value="fossa-posteriore">Fossa posteriore</option>
                        <option value="spinale">Spinale</option>
                        <option value="intraventricolare">Intraventricolare</option>
                        <option value="altro">Altra sede</option>
                    </select>
                </div>
                <div class="field-group">
                    <div class="field-label">Sesso</div>
                    <select id="men-sex">
                        <option value="">â€”</option>
                        <option value="F">F</option>
                        <option value="M">M</option>
                    </select>
                    <div class="help-text">Maschio giovane â†’ escludere NF2 sindromico</div>
                </div>
                <div class="field-group">
                    <div class="field-label">NF2 sindromico</div>
                    <select id="men-nf2-clinical">
                        <option value="">â€”</option>
                        <option value="no">No</option>
                        <option value="sospetto">Sospetto</option>
                        <option value="confermato">Confermato</option>
                    </select>
                </div>
                <div class="field-group">
                    <div class="field-label">Recidiva</div>
                    <select id="men-recurrence">
                        <option value="">Prima diagnosi</option>
                        <option value="I">I recidiva</option>
                        <option value="II">II+ recidiva</option>
                    </select>
                    <div class="help-text">Recidiva aumenta rischio upgrading</div>
                </div>
            </div>

            <!-- COL 2: ISTOLOGIA + SOTTOTIPO -->
            <div class="column men-col-isto">
                <div class="col-header"><div class="col-accent"></div><h3>ðŸ”¬ Istologia</h3></div>
                <div class="field-group">
                    <div class="field-label">Sottotipo WHO CNS5</div>
                    <select id="men-subtype" onchange="updateMenSubtypeHint()">
                        <option value="">â€” Non specificato â€”</option>
                        <optgroup label="Grade 1 implicito">
                            <option value="meningoteliomatoso">Meningoteliomatoso</option>
                            <option value="fibroso">Fibroso</option>
                            <option value="transizionale">Transizionale</option>
                            <option value="psammomatoso">Psammomatoso</option>
                            <option value="angiomatoso">Angiomatoso</option>
                            <option value="microcistico">Microcistico</option>
                            <option value="secretorio">Secretorio</option>
                            <option value="linfoplasmacitoide">Linfoplasmacitoide</option>
                            <option value="metaplastico">Metaplastico</option>
                        </optgroup>
                        <optgroup label="Grade 2 implicito (WHO CNS5)">
                            <option value="cordoide">Cordoide â˜…</option>
                            <option value="clear-cell">Clear cell â˜…</option>
                        </optgroup>
                        <optgroup label="Grade 3 implicito (WHO CNS5)">
                            <option value="rhabdoide">Rhabdoide â˜…</option>
                            <option value="papillare">Papillare â˜…</option>
                        </optgroup>
                    </select>
                    <div id="men-subtype-hint" class="help-text"></div>
                </div>
                <div class="field-group">
                    <div class="field-label">Mitosi / 10 HPF</div>
                    <input type="number" id="men-mitosis" placeholder="0" min="0" max="100">
                    <div class="help-text">â‰¥4 â†’ criterio Gr.2 | â‰¥20 â†’ criterio Gr.3</div>
                </div>
                <div class="field-group">
                    <div class="field-label">Invasione cerebrale</div>
                    <select id="men-brain-invasion">
                        <option value="">â€”</option>
                        <option value="assente">Assente</option>
                        <option value="present">Presente (confermata)</option>
                        <option value="sospetta">Sospetta / campione limitato</option>
                    </select>
                    <div class="help-text">Criterio Gr.2 isolato (WHO CNS5)</div>
                </div>
                <div class="field-group">
                    <div class="field-label">Necrosi spontanea</div>
                    <select id="men-necrosis">
                        <option value="">â€”</option>
                        <option value="assente">Assente</option>
                        <option value="presente">Presente</option>
                    </select>
                    <div class="help-text">Criterio minore atipico</div>
                </div>
                <div style="margin: 10px 0 6px; font-size: 11px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em;">Criteri minori (â‰¥3 = Gr.2)</div>
                <label style="display:flex;gap:8px;align-items:center;margin-bottom:4px;font-size:12px;cursor:pointer">
                    <input type="checkbox" id="men-hypercell"> IpercellularitÃ 
                </label>
                <label style="display:flex;gap:8px;align-items:center;margin-bottom:4px;font-size:12px;cursor:pointer">
                    <input type="checkbox" id="men-small-cells"> Piccole cellule / alto N:C
                </label>
                <label style="display:flex;gap:8px;align-items:center;margin-bottom:4px;font-size:12px;cursor:pointer">
                    <input type="checkbox" id="men-nucleoli"> Nucleoli prominenti
                </label>
                <label style="display:flex;gap:8px;align-items:center;margin-bottom:4px;font-size:12px;cursor:pointer">
                    <input type="checkbox" id="men-sheet"> Pattern sheet-like
                </label>
                <div id="men-minor-count" class="criteria-counter">Criteri minori: 0/4</div>
                <div class="field-group" style="margin-top:10px">
                    <div class="field-label">Morfologia maligna franca</div>
                    <select id="men-frank-malignancy">
                        <option value="">â€”</option>
                        <option value="assente">Assente</option>
                        <option value="carcinoma-like">Carcinoma-like</option>
                        <option value="sarcoma-like">Sarcoma-like</option>
                        <option value="melanoma-like">Melanoma-like</option>
                    </select>
                    <div class="help-text">Criterio Gr.3 indipendente</div>
                </div>
            </div>

            <!-- COL 3: IHC -->
            <div class="column men-col-ihc">
                <div class="col-header"><div class="col-accent"></div><h3>ðŸ”´ IHC</h3></div>
                <div class="field-group">
                    <div class="field-label">Ki67 / MIB-1 (%)</div>
                    <input type="number" id="men-ki67" placeholder="es. 5" min="0" max="100">
                    <div class="help-text">&lt;4% Gr.1 | 4â€“20% Gr.2 | &gt;20% Gr.3 (orientativo, non criterio WHO)</div>
                </div>
                <div class="field-group">
                    <div class="field-label">EMA</div>
                    <select id="men-ema">
                        <option value="">â€”</option>
                        <option value="positive">Positivo</option>
                        <option value="partial">Parziale / focale</option>
                        <option value="negative">Negativo</option>
                    </select>
                </div>
                <div class="field-group">
                    <div class="field-label">PR (Progesterone R.)</div>
                    <select id="men-pr">
                        <option value="">â€”</option>
                        <option value="positive">Positivo</option>
                        <option value="negative">Negativo</option>
                    </select>
                    <div class="help-text">Loss correlata a grading crescente; tipicamente assente in Gr.3</div>
                </div>
                <div class="field-group">
                    <div class="field-label">p53</div>
                    <select id="men-p53">
                        <option value="">â€”</option>
                        <option value="wild">WT (&lt;10%)</option>
                        <option value="overexp">Overespresso (&gt;10%)</option>
                        <option value="null">Pattern null</option>
                    </select>
                    <div class="help-text">Overespressione in atipico/anaplastico</div>
                </div>
                <div class="field-group">
                    <div class="field-label">SSTR2A</div>
                    <select id="men-sstr2a">
                        <option value="">â€”</option>
                        <option value="positive">Positivo (2+/3+)</option>
                        <option value="weak">Debole (1+)</option>
                        <option value="negative">Negativo</option>
                    </select>
                    <div class="help-text">Positivo â†’ eligibile PRRT / dotatate PET. NegativitÃ  atipica in Gr.3</div>
                </div>
                <div class="field-group">
                    <div class="field-label">H3K27me3</div>
                    <select id="men-h3k27me3">
                        <option value="">â€”</option>
                        <option value="retained">Retained</option>
                        <option value="lost">Lost</option>
                    </select>
                    <div class="help-text">Loss associata a Gr.2/3 e maggior rischio recidiva (diverso da gliomi)</div>
                </div>
            </div>

            <!-- COL 4: MOLECOLARE (opzionale) -->
            <div class="column men-col-mol">
                <div class="col-header"><div class="col-accent"></div><h3>ðŸ§¬ Molecolare</h3></div>
                <div style="margin-bottom:8px">
                    <span class="mol-toggle" id="mol-toggle-btn" onclick="toggleMolecolare()">â–¶ Espandi molecolare (opzionale)</span>
                </div>
                <div id="men-mol-fields" class="mol-optional">
                    <div class="field-group">
                        <div class="field-label">TERT promoter</div>
                        <select id="men-tert">
                            <option value="">â€”</option>
                            <option value="wildtype">Wildtype</option>
                            <option value="mutato">Mutato (C228T / C250T)</option>
                            <option value="not-done">N.E.</option>
                        </select>
                        <div class="help-text">Mut â†’ upgrading Gr.2 anche in morfologia borderline</div>
                    </div>
                    <div class="field-group">
                        <div class="field-label">CDKN2A/B</div>
                        <select id="men-cdkn2a">
                            <option value="">â€”</option>
                            <option value="wildtype">Wildtype</option>
                            <option value="heterozygous">Del eterozigote</option>
                            <option value="homozygous-del">Del omozigote</option>
                            <option value="not-done">N.E.</option>
                        </select>
                        <div class="help-text">Hom-del â†’ Gr.3 automatico (WHO CNS5)</div>
                    </div>
                    <div class="field-group">
                        <div class="field-label">NF2</div>
                        <select id="men-nf2">
                            <option value="">â€”</option>
                            <option value="wildtype">Wildtype</option>
                            <option value="mutato">Mutato / loss</option>
                            <option value="not-done">N.E.</option>
                        </select>
                        <div class="help-text">Mut comune in fibrosi/transizionali; NF2-wt in base-cranica</div>
                    </div>
                    <div class="field-group">
                        <div class="field-label">BAP1</div>
                        <select id="men-bap1">
                            <option value="">â€”</option>
                            <option value="retained">Retained (IHC)</option>
                            <option value="lost">Lost (IHC)</option>
                            <option value="mutato">Mutato (NGS)</option>
                            <option value="not-done">N.E.</option>
                        </select>
                        <div class="help-text">Loss/mut â†’ rischio elevato recidiva; frequente in rhabdoide</div>
                    </div>
                    <div class="field-group">
                        <div class="field-label">Chr22q</div>
                        <select id="men-chr22q">
                            <option value="">â€”</option>
                            <option value="intact">Intatto</option>
                            <option value="loss">Loss (monosomia 22)</option>
                            <option value="not-done">N.E.</option>
                        </select>
                        <div class="help-text">Loss correlata a NF2 mut (~40â€“50% meningiomi)</div>
                    </div>
                </div>
                <div style="margin-top:16px">
                <div id="menin-gate" class="generate-gate"></div>
                <button class="btn btn-primary" onclick="guardedGenerateMen()" style="width:100%">â–¶ Genera ipotesi classificativa</button>
                    <button class="btn btn-secondary" onclick="resetMenForm()" style="width:100%; margin-top:6px">â†º Reset</button>
                </div>
            </div>

        </div><!-- /meningioma workflow-container -->

        <!-- REPORT MENINGIOMA -->
        <div id="men-report-container" style="margin-top:18px"></div>

    </div><!-- /meningioma-section -->

    <!-- BIBLIOGRAPHY (shared) -->
    <div class="biblio-section">
        <h3 style="display:flex; align-items:center; gap:10px;">
            ðŸ“š Riferimenti bibliografici â€” WHO CNS5 2021
            <span id="relevance-badge" style="display:none;"></span>
        </h3>
        <div style="font-size:11px; color:var(--text-dim); margin-bottom:16px;">
            Dopo aver generato la diagnosi, i riferimenti pertinenti vengono evidenziati automaticamente.
        </div>
        <div id="biblio-container"></div>
    </div>

</div><!-- end container -->

<script>
// ============================================================
// BIBLIOGRAPHY DATABASE
// ============================================================
const bibliography = {
    "who_classification": {
        title: "Classificazione WHO & Grading",
        icon: "ðŸ“–",
        references: [
            { id: "louis2021", authors: "Louis DN, Perry A, Wesseling P, et al.", year: 2021, title: "The 2021 WHO Classification of Tumors of the CNS: a summary", journal: "Neuro Oncol. 2021;23(8):1231-1251", doi: "10.1093/neuonc/noab106", pmid: "34185076", abstract: "WHO CNS5 2021: integrazione molecolare obbligatoria. Grading dinamico basato su CDKN2A/B homozygous deletion.", tags: ["WHO", "GRADING", "IDH", "1P/19Q", "CDKN2A"] },
            { id: "brat2020", authors: "Brat DJ, Aldape K, Colman H, et al.", year: 2020, title: "cIMPACT-NOW update 6: new entity and diagnostic principle recommendations", journal: "Brain Pathol. 2020;30(4):844-856", doi: "10.1111/bpa.12832", pmid: "32307792", abstract: "Raccomandazioni cIMPACT-NOW: grading integrato morfologia-molecolare, ruolo CDKN2A/B deletion.", tags: ["GRADING", "CDKN2A", "MOLECULAR"] },
            { id: "brat2018", authors: "Brat DJ, Aldape K, Colman H, et al.", year: 2018, title: "cIMPACT-NOW update 3: IDH-wildtype diffuse astrocytic glioma with molecular features of glioblastoma WHO grade IV", journal: "Acta Neuropathol. 2018;136(5):805-810", doi: "10.1007/s00401-018-1913-0", pmid: "30259105", abstract: "cIMPACT-NOW: glioma astrocitario IDH-wt con EGFR amp, +7/-10, TERT mut = Grade 4 molecolare anche senza features istologiche GBM.", tags: ["GRADING", "IDH", "EGFR", "TERT", "GLIOBLASTOMA"] }
        ]
    },
    "idh_astrocytoma": {
        title: "Astrocytoma IDH-mutated",
        icon: "ðŸ§¬",
        references: [
            { id: "reuss2015", authors: "Reuss DE, Sahm F, Schrimpf D, et al.", year: 2015, title: "ATRX and IDH1-R132H IHC with subsequent copy number analysis: integrated diagnostic approach", journal: "Acta Neuropathol. 2015;129(1):133-146", doi: "10.1007/s00401-014-1370-3", pmid: "25427834", abstract: "Workflow diagnostico integrato IHCâ†’molecolare per gliomi adulti. ATRX loss + IDH mutation = astrocytoma.", tags: ["IDH", "ATRX", "WORKFLOW", "ASTROCYTOMA"] },
            { id: "watanabe2009", authors: "Watanabe T, Nobusawa S, Kleihues P, Ohgaki H", year: 2009, title: "IDH1 mutations are early events in the development of astrocytomas and oligodendrogliomas", journal: "Am J Pathol. 2009;174(4):1149-1153", doi: "10.2353/ajpath.2009.080958", pmid: "19246647", abstract: "IDH mutation Ã¨ evento early in gliomi diffusi. ASSENTE in glioblastoma primario.", tags: ["IDH", "PATHOGENESIS", "ASTROCYTOMA"] }
        ]
    },
    "oligodendroglioma": {
        title: "Oligodendroglioma 1p/19q-codeleted",
        icon: "ðŸ”µ",
        references: [
            { id: "cairncross2013", authors: "Cairncross JG, Wang M, Jenkins RB, et al.", year: 2014, title: "Benefit from PCV in oligodendroglial tumors is associated with IDH mutation", journal: "J Clin Oncol. 2014;32(8):783-790", doi: "10.1200/JCO.2013.49.3726", pmid: "24516018", abstract: "Prognosi favorevole oligodendroglioma IDH-mut 1p/19q-codel. Risposta eccellente a chemioterapia PCV.", tags: ["OLIGODENDROGLIOMA", "1P/19Q", "PROGNOSIS", "THERAPY"] },
            { id: "kamoun2016", authors: "Kamoun A, Idbaih A, Dehais C, et al.", year: 2016, title: "Multi-omics analysis of oligodendroglial tumours: three subgroups of 1p/19q co-deleted gliomas", journal: "Nat Commun. 2016;7:11263", doi: "10.1038/ncomms11263", pmid: "27098550", abstract: "TP53 mutation Ã¨ RARA in oligodendroglioma (mutually exclusive con 1p/19q).", tags: ["OLIGODENDROGLIOMA", "TP53", "1P/19Q"] }
        ]
    },
    "glioblastoma": {
        title: "Glioblastoma IDH-wildtype & Pathway molecolari",
        icon: "ðŸ”´",
        references: [
            { id: "brennan2013", authors: "Brennan CW, Verhaak RG, McKenna A, et al. (TCGA)", year: 2013, title: "The somatic genomic landscape of glioblastoma", journal: "Cell. 2013;155(2):462-477", doi: "10.1016/j.cell.2013.09.034", pmid: "24120142", abstract: "TCGA GBM: EGFR amp, PTEN loss, TP53, TERT promoter. Subtypes molecolari Proneural/Classical/Mesenchymal.", tags: ["GLIOBLASTOMA", "EGFR", "PTEN", "TP53", "TERT", "TCGA"] },
            { id: "verhaak2010", authors: "Verhaak RG, Hoadley KA, Purdom E, et al.", year: 2010, title: "Integrated genomic analysis identifies clinically relevant subtypes of glioblastoma characterized by abnormalities in PDGFRA, IDH1, EGFR, and NF1", journal: "Cancer Cell. 2010;17(1):98-110", doi: "10.1016/j.ccr.2009.12.020", pmid: "20129251", abstract: "4 sottotipi GBM: Classical (EGFR amp), Mesenchymal (NF1 loss/PTEN loss), Proneural (IDH1/PDGFRA), Neural.", tags: ["GLIOBLASTOMA", "EGFR", "NF1", "PTEN", "MOLECULAR"] },
            { id: "killela2013", authors: "Killela PJ, Reitman ZJ, Jiao Y, et al.", year: 2013, title: "TERT promoter mutations occur frequently in gliomas and tumors with low self-renewal rates", journal: "Proc Natl Acad Sci USA. 2013;110(15):6021-6026", doi: "10.1073/pnas.1303607110", pmid: "23530248", abstract: "TERT promoter mutation (C228T, C250T) in 83% GBM primari. Correlata con prognosi sfavorevole.", tags: ["GLIOBLASTOMA", "TERT", "PROGNOSIS"] }
        ]
    },
    "h3_dmg": {
        title: "Diffuse Midline Glioma H3-altered",
        icon: "âš ï¸",
        references: [
            { id: "sturm2012", authors: "Sturm D, Witt H, Hovestadt V, et al.", year: 2012, title: "Hotspot mutations in H3F3A and IDH1 define distinct epigenetic and biological subgroups of glioblastoma", journal: "Cancer Cell. 2012;22(4):425-437", doi: "10.1016/j.ccr.2012.08.024", pmid: "23079654", abstract: "H3F3A K27M e G34R/W mutations definiscono sottogruppi molecolari distinti. G34: emisferico, giovane adulto; K27M: midline, pediatrico.", tags: ["DMG", "H3K27M", "H3G34", "PEDIATRIC", "PROGNOSIS"] },
            { id: "mackay2017", authors: "Mackay A, Burford A, Carvalho D, et al.", year: 2017, title: "Integrated Molecular Meta-Analysis of 1,000 Pediatric High-Grade and Diffuse Intrinsic Pontine Glioma", journal: "Cancer Cell. 2017;32(4):520-537", doi: "10.1016/j.ccell.2017.08.017", pmid: "28966033", abstract: "Classificazione molecolare integrata HGG pediatrici: H3K27M (DIPG/midline), H3G34R/W (emisferico), IDH-mut (adolescenti). Prognosi e biologia distinta per sottogruppo.", tags: ["DMG", "H3K27M", "H3G34", "PEDIATRIC", "GRADING"] },
            { id: "louis2018_cimpact", authors: "Louis DN, Giannini C, Capper D, et al.", year: 2018, title: "cIMPACT-NOW update 2: diagnostic clarifications for diffuse midline glioma, H3 K27M-mutant", journal: "Acta Neuropathol. 2018;135(4):639-642", doi: "10.1007/s00401-018-1826-y", pmid: "29497819", abstract: "DMG H3K27-altered sempre Grade 4, indipendentemente da morfologia. H3K27me3 IHC come surrogate marker.", tags: ["DMG", "H3K27M", "GRADING", "IHC"] }
        ]
    },
    "molecular_grading": {
        title: "NGS Panel & Grading Molecolare â€” CDKN2A",
        icon: "ðŸ”¬",
        references: [
            { id: "banan2020", authors: "Banan R, Hartmann C, Martinkova E, et al.", year: 2021, title: "CDKN2A/B homozygous deletion is a strong adverse prognostic factor in IDH-mutant glioma", journal: "Neuro Oncol. 2021;23(1):39-49", doi: "10.1093/neuonc/noaa253", pmid: "33141886", abstract: "CDKN2A/B hom del = Grade 4 automatico WHO CNS5. Outcome simile a GBM anche se morfologia low-grade.", tags: ["CDKN2A", "GRADING", "IDH", "PROGNOSIS"] },
            { id: "tcga2015", authors: "Cancer Genome Atlas Research Network", year: 2015, title: "Comprehensive, Integrative Genomic Analysis of Diffuse Lower-Grade Gliomas", journal: "N Engl J Med. 2015;372(26):2481-2498", doi: "10.1056/NEJMoa1402121", pmid: "26061751", abstract: "TCGA LGG: 3 gruppi prognostici molecolari. IDH-mut/1p19q-codel (best), IDH-mut/non-codel (intermediate), IDH-wt (worst).", tags: ["NGS", "IDH", "1P/19Q", "PROGNOSIS", "TCGA"] }
        ]
    },
    "actionable_fusions": {
        title: "Fusioni Actionable â€” NTRK Â· RET Â· ROS1 Â· FGFR",
        icon: "ðŸŽ¯",
        references: [
            { id: "hong2020", authors: "Hong DS, DuBois SG, Kummar S, et al.", year: 2020, title: "Larotrectinib in patients with TRK fusion-positive solid tumours: a pooled analysis of three phase 1/2 clinical trials", journal: "Lancet Oncol. 2020;21(4):531-540", doi: "10.1016/S1470-2045(19)30856-3", pmid: "32171426", abstract: "Larotrectinib: ORR 79% in NTRK-fusion tumori. Approvazione tumor-agnostic FDA/EMA. Include casi SNC.", tags: ["NTRK", "ACTIONABLE", "FUSION", "LAROTRECTINIB"] },
            { id: "doebele2020", authors: "Doebele RC, Drilon A, Paz-Ares L, et al.", year: 2020, title: "Entrectinib in patients with advanced or metastatic NTRK fusion-positive solid tumours", journal: "Lancet Oncol. 2020;21(2):271-282", doi: "10.1016/S1470-2045(19)30691-6", pmid: "31838007", abstract: "Entrectinib: approvato NTRK fusion (anche ROS1 NSCLC). Efficacia in metastasi SNC documentata.", tags: ["NTRK", "ROS1", "ACTIONABLE", "FUSION", "ENTRECTINIB"] },
            { id: "drilon2022", authors: "Drilon A, Oxnard GR, Tan DSW, et al.", year: 2020, title: "Efficacy of Selpercatinib in RET Fusion-Positive Non-Small-Cell Lung Cancer", journal: "N Engl J Med. 2020;383(9):813-824", doi: "10.1056/NEJMoa2005653", pmid: "32846060", abstract: "Selpercatinib: attivitÃ  in RET-fusion tumors. Dati SNC limitati ma penetrazione cerebrale documentata.", tags: ["RET", "ACTIONABLE", "FUSION", "SELPERCATINIB"] },
            { id: "wu2019", authors: "Wu YL, Yang JC, Kim DW, et al.", year: 2019, title: "Phase II Study of Crizotinib in East Asian Patients with ROS1-Positive Advanced Non-Small-Cell Lung Cancer", journal: "J Clin Oncol. 2018;36(14):1405-1411", doi: "10.1200/JCO.2017.75.6586", pmid: "29596060", abstract: "ROS1 fusion: target crizotinib/entrectinib. ROS1 fusioni rare nei gliomi ma clinicamente rilevanti.", tags: ["ROS1", "ACTIONABLE", "FUSION"] },
            { id: "bley2021", authors: "Bagley SJ, Kothari S, Rahman R, et al.", year: 2022, title: "Glioblastoma with FGFR-TACC gene fusions: sensitivity to FGFR inhibition and impact of acquired resistance mechanisms", journal: "Neuro Oncol. 2022;24(2):203-214", doi: "10.1093/neuonc/noab232", pmid: "34636900", abstract: "FGFR-TACC fusions in ~3% GBM IDH-wt. SensibilitÃ  a inibitori FGFR. Meccanismi di resistenza acquisita.", tags: ["FGFR", "FUSION", "GLIOBLASTOMA", "ACTIONABLE"] }
        ]
    },
    "pi3k_mtor": {
        title: "Pathway PI3K / PTEN / mTOR in GBM",
        icon: "âš™ï¸",
        references: [
            { id: "song2012", authors: "Song MS, Salmena L, Pandolfi PP", year: 2012, title: "The functions and regulation of the PTEN tumour suppressor", journal: "Nat Rev Mol Cell Biol. 2012;13(5):283-296", doi: "10.1038/nrm3330", pmid: "22473468", abstract: "PTEN: regolatore centrale via PI3K/AKT/mTOR. Loss in ~40% GBM primari. Target terapeutico indiretto.", tags: ["PTEN", "PI3K", "MTOR", "GLIOBLASTOMA"] },
            { id: "cloughesy2019", authors: "Cloughesy TF, Mochizuki AY, Orpilla JR, et al.", year: 2019, title: "Neoadjuvant anti-PD-1 immunotherapy promotes a survival benefit with intratumoral and systemic immune responses in recurrent GBM", journal: "Nat Med. 2019;25(3):477-486", doi: "10.1038/s41591-018-0337-7", pmid: "30742122", abstract: "Immunoterapia neoadiuvante in GBM recidivo. MSI-H/TMB-H come biomarcatori predittivi di risposta.", tags: ["GLIOBLASTOMA", "MSI", "TMB", "IMMUNOTHERAPY"] }
        ]
    },
    "msi_immunotherapy": {
        title: "MSI / MMR-deficiency & Immunoterapia",
        icon: "ðŸ”",
        references: [
            { id: "le2017", authors: "Le DT, Durham JN, Smith KN, et al.", year: 2017, title: "Mismatch repair deficiency predicts response of solid tumors to PD-1 blockade", journal: "Science. 2017;357(6349):409-413", doi: "10.1126/science.aan6733", pmid: "28596308", abstract: "MSI-H / dMMR: predittore universale di risposta a pembrolizumab. Base per approvazione tumor-agnostic FDA 2017.", tags: ["MSI", "MMR", "IMMUNOTHERAPY", "PEMBROLIZUMAB"] },
            { id: "touat2020", authors: "Touat M, Li YY, Boynton AN, et al.", year: 2020, title: "Mechanisms and therapeutic implications of hypermutation in gliomas", journal: "Nature. 2020;580(7804):517-523", doi: "10.1038/s41586-020-2209-9", pmid: "32322066", abstract: "Ipermutazione nei gliomi: POLE mut, MMR deficiency, acquisita post-TMZ. Implicazioni per immunoterapia.", tags: ["MSI", "POLE", "GLIOBLASTOMA", "HYPERMUTATION", "IMMUNOTHERAPY"] },
            { id: "bouffet2016", authors: "Bouffet E, Larouche V, Campbell BB, et al.", year: 2016, title: "Immune Checkpoint Inhibition for Hypermutant Glioblastoma Multiforme Resulting from Germline Biallelic Mismatch Repair Deficiency", journal: "J Clin Oncol. 2016;34(19):2206-2211", doi: "10.1200/JCO.2016.66.6552", pmid: "27001570", abstract: "Prima report: GBM con biallelic MMR deficiency (Lynch) risponde a nivolumab. Case report paradigmatico.", tags: ["MSI", "MMR", "LYNCH", "GLIOBLASTOMA", "IMMUNOTHERAPY"] }
        ]
    },
    "mgmt_predictive": {
        title: "MGMT & Marcatori Predittivi",
        icon: "ðŸ’Š",
        references: [
            { id: "hegi2005", authors: "Hegi ME, Diserens AC, Gorlia T, et al.", year: 2005, title: "MGMT gene silencing and benefit from temozolomide in glioblastoma", journal: "N Engl J Med. 2005;352(10):997-1003", doi: "10.1056/NEJMoa043331", pmid: "15758010", abstract: "MGMT promoter methylation predice risposta a temozolomide in GBM. Methylated = sopravvivenza mediana 21.7 vs 12.7 mesi.", tags: ["MGMT", "TEMOZOLOMIDE", "PROGNOSIS", "GLIOBLASTOMA"] }
        ]
    }
};

// ============================================================
// CASI PRECARICATI
// ============================================================
const cases = {
    case1: { age: 45, location: 'emisfero', imaging: 'heterogeneous', cellularity: 'high', atypia: 'moderate', mitosis: 6, celltype: 'astrocytic', gfap: 'positive', 'idh-ihc': 'positive', atrx: 'lost', p53: 20, olig2: 'negative', h3k27me3: 'retained', ki67: 20, 'idh-ngs': 'mut-r132h', 'tp53-ngs': 'mutato', '1p19q': 'not-codeleted', tert: 'not-done', h3f3a: 'wildtype', cdkn2a: 'wildtype', pik3ca: 'wildtype', pten: 'wildtype', nf1: 'wildtype', mtor: 'wildtype', mgmt: 'not-done', 'egfr-cnv': 'normal', 'egfr-snv': 'wildtype', 'erbb2-cnv': 'normal', 'met-cnv': 'normal', 'chr7-10': 'absent', braf: 'wildtype', 'ntrk-fusion': 'negative', 'ret-fusion': 'negative', 'ros1-fusion': 'negative', 'alk-fusion': 'negative', 'nrg1-fusion': 'negative', 'fgfr-fusion': 'negative', 'met-fusion': 'negative', 'msi-status': 'mss', 'mmr-ihc': 'intact', tmb: 2, pole: 'wildtype', lynch: 'no' },
    case2: { age: 52, location: 'emisfero', imaging: 'enhancement', cellularity: 'moderate', atypia: 'scarse', mitosis: 3, celltype: 'oligodendroglial', gfap: 'partial', 'idh-ihc': 'positive', atrx: 'retained', p53: 8, olig2: 'positive', h3k27me3: 'retained', ki67: 8, 'idh-ngs': 'mut-r132h', 'tp53-ngs': 'wildtype', '1p19q': 'codeleted', tert: 'wildtype', h3f3a: 'wildtype', cdkn2a: 'wildtype', pik3ca: 'wildtype', pten: 'wildtype', nf1: 'wildtype', mtor: 'wildtype', mgmt: 'not-done', 'egfr-cnv': 'normal', 'egfr-snv': 'wildtype', 'erbb2-cnv': 'normal', 'met-cnv': 'normal', 'chr7-10': 'absent', braf: 'wildtype', 'ntrk-fusion': 'negative', 'ret-fusion': 'negative', 'ros1-fusion': 'negative', 'alk-fusion': 'negative', 'nrg1-fusion': 'negative', 'fgfr-fusion': 'negative', 'met-fusion': 'negative', 'msi-status': 'mss', 'mmr-ihc': 'intact', tmb: 1, pole: 'wildtype', lynch: 'no' },
    case3: { age: 64, location: 'emisfero', imaging: 'ring', cellularity: 'high', atypia: 'numerose', mitosis: 16, celltype: 'glioblastic', gfap: 'partial', 'idh-ihc': 'negative', atrx: 'retained', p53: 70, olig2: 'negative', h3k27me3: 'retained', ki67: 45, 'idh-ngs': 'wildtype', 'tp53-ngs': 'mutato', '1p19q': 'not-codeleted', tert: 'mutato', h3f3a: 'wildtype', cdkn2a: 'wildtype', pik3ca: 'wildtype', pten: 'loss', nf1: 'mutato', mtor: 'wildtype', mgmt: 'unmethylated', 'egfr-cnv': 'amplified', 'egfr-snv': 'vIII', 'erbb2-cnv': 'normal', 'met-cnv': 'normal', 'chr7-10': 'present', braf: 'wildtype', 'ntrk-fusion': 'negative', 'ret-fusion': 'negative', 'ros1-fusion': 'negative', 'alk-fusion': 'negative', 'nrg1-fusion': 'negative', 'fgfr-fusion': 'negative', 'met-fusion': 'negative', 'msi-status': 'mss', 'mmr-ihc': 'intact', tmb: 4, pole: 'wildtype', lynch: 'no' },
    case4: { age: 8, location: 'linea-mediana', imaging: 'midline-diffuse', cellularity: 'high', atypia: 'numerose', mitosis: 12, celltype: 'glioblastic', gfap: 'partial', 'idh-ihc': 'negative', atrx: 'retained', p53: 50, olig2: 'negative', h3k27me3: 'lost', ki67: 50, 'idh-ngs': 'wildtype', 'tp53-ngs': 'mutato', '1p19q': 'not-codeleted', tert: 'wildtype', h3f3a: 'k27m', cdkn2a: 'homozygous-del', pik3ca: 'wildtype', pten: 'wildtype', nf1: 'wildtype', mtor: 'wildtype', mgmt: 'unmethylated', 'egfr-cnv': 'normal', 'egfr-snv': 'wildtype', 'erbb2-cnv': 'normal', 'met-cnv': 'normal', 'chr7-10': 'absent', braf: 'wildtype', 'ntrk-fusion': 'negative', 'ret-fusion': 'negative', 'ros1-fusion': 'negative', 'alk-fusion': 'negative', 'nrg1-fusion': 'negative', 'fgfr-fusion': 'negative', 'met-fusion': 'negative', 'msi-status': 'mss', 'mmr-ihc': 'intact', tmb: 2, pole: 'wildtype', lynch: 'no' },
    case5: { age: 35, location: 'emisfero', imaging: 'diffuse', cellularity: 'moderate', atypia: 'moderate', mitosis: 4, celltype: 'astrocytic', gfap: 'positive', 'idh-ihc': 'negative', atrx: 'retained', p53: 5, olig2: 'partial', h3k27me3: 'retained', ki67: 10, 'idh-ngs': 'wildtype', 'tp53-ngs': 'wildtype', '1p19q': 'not-codeleted', tert: 'wildtype', h3f3a: 'wildtype', cdkn2a: 'wildtype', pik3ca: 'wildtype', pten: 'wildtype', nf1: 'wildtype', mtor: 'wildtype', mgmt: 'not-done', 'egfr-cnv': 'normal', 'egfr-snv': 'wildtype', 'erbb2-cnv': 'normal', 'met-cnv': 'normal', 'chr7-10': 'absent', braf: 'wildtype', 'ntrk-fusion': 'ntrk3', 'ret-fusion': 'negative', 'ros1-fusion': 'negative', 'alk-fusion': 'negative', 'nrg1-fusion': 'negative', 'fgfr-fusion': 'negative', 'met-fusion': 'negative', 'msi-status': 'mss', 'mmr-ihc': 'intact', tmb: 2, pole: 'wildtype', lynch: 'no' }
};

function loadCase() {
    const caseId = document.getElementById('case-select').value;
    if (!caseId || !cases[caseId]) return;
    const d = cases[caseId];
    for (const [key, value] of Object.entries(d)) {
        const el = document.getElementById(key);
        if (!el) continue;
        if (el.type === 'checkbox') el.checked = !!value;
        else el.value = value;
    }
}

function resetForm() {
    document.querySelectorAll('input, select').forEach(el => {
        if (el.id === 'case-select') return;
        if (el.type === 'checkbox') el.checked = false;
        else if (!el.disabled) el.value = '';
    });
    document.getElementById('case-select').value = '';
    document.getElementById('report-container').innerHTML = '';
    resetBiblioHighlights();
}

// ============================================================
// CORE DIAGNOSIS ENGINE v3.10.1
// Per fusion fields: valori negativi attesi sono 'negative', 'not-done', ''
const isPosFusion = v => v && v !== 'negative' && v !== 'not-done' && v !== '';
// ============================================================
function getData() {
    const g = id => document.getElementById(id);
    return {
        age: parseInt(g('age').value) || 0,
        location: g('location').value,
        imaging: g('imaging').value,
        cellularity: g('cellularity').value,
        atypia: g('atypia').value,
        mitosis: parseInt(g('mitosis').value) || 0,
        celltype: g('celltype').value,
        gfap: g('gfap').value,
        'idh-ihc': g('idh-ihc').value,
        atrx: g('atrx').value,
        p53: parseInt(g('p53').value) || 0,
        olig2: g('olig2').value,
        h3k27me3: g('h3k27me3').value,
        ki67: parseInt(g('ki67').value) || 0,
        'idh-ngs': g('idh-ngs').value,
        'tp53-ngs': g('tp53-ngs').value,
        '1p19q': g('1p19q').value,
        tert: g('tert').value,
        h3f3a: g('h3f3a').value,
        cdkn2a: g('cdkn2a').value,
        pik3ca: g('pik3ca').value,
        pten: g('pten').value,
        nf1: g('nf1').value,
        mtor: g('mtor').value,
        mgmt: g('mgmt').value,
        'egfr-cnv': g('egfr-cnv').value,
        'egfr-snv': g('egfr-snv').value,
        'erbb2-cnv': g('erbb2-cnv').value,
        'met-cnv': g('met-cnv').value,
        'chr7-10': g('chr7-10').value,
        braf: g('braf').value,
        'ntrk-fusion': g('ntrk-fusion').value,
        'ret-fusion': g('ret-fusion').value,
        'ros1-fusion': g('ros1-fusion').value,
        'alk-fusion': g('alk-fusion').value,
        'nrg1-fusion': g('nrg1-fusion').value,
        'fgfr-fusion': g('fgfr-fusion').value,
        'met-fusion': g('met-fusion').value,
        'msi-status': g('msi-status').value,
        'mmr-ihc': g('mmr-ihc').value,
        tmb: parseInt(g('tmb').value) || 0,
        pole: g('pole').value,
        lynch: g('lynch').value,
        histFeatures: {
            necrosis: document.getElementById('hist-necrosis').checked,
            microvascular: document.getElementById('hist-microvascular').checked
        }
    };
}

function computeDiagnosis(data) {
    let alerts = [];
    let diagnosis = {};
    let scores = { astrocytoma: 0, oligodendroglioma: 0, glioblastoma: 0, dmg: 0, h3altered: 0, pilocytic: 0, other: 0 };
    let actionableAlerts = [];
    let msiAlerts = [];

    // ---- ACTIONABLE FUSIONS (indipendenti dalla diagnosi istologica) ----
    if (isPosFusion(data['ntrk-fusion'])) {
        const ntrk = data['ntrk-fusion'].toUpperCase();
        actionableAlerts.push({ gene: ntrk + ' fusion', drug: 'Larotrectinib (EMA/FDA approvato tumor-agnostic) | Entrectinib', note: 'Confermare con IHC pan-TRK (screening) prima di NGS in setting resource-limited. Efficacia documentata anche in metastasi SNC.' });
    }
    if (data['ret-fusion'] === 'positive') {
        actionableAlerts.push({ gene: 'RET fusion', drug: 'Selpercatinib | Pralsetinib (off-label SNC)', note: 'Dati di penetrazione cerebrale per selpercatinib. Counseling oncologico.' });
    }
    if (data['ros1-fusion'] === 'positive') {
        actionableAlerts.push({ gene: 'ROS1 fusion', drug: 'Entrectinib (attivitÃ  SNC) | Crizotinib', note: 'Entrectinib preferito per penetrazione cerebrale.' });
    }
    if (data['alk-fusion'] === 'positive') {
        actionableAlerts.push({ gene: 'ALK fusion', drug: 'Lorlatinib | Alectinib', note: 'ALK fusion nei gliomi: raro ma actionable. Discutere in tumor board.' });
    }
    if (isPosFusion(data['fgfr-fusion'])) {
        const isTACC = data['fgfr-fusion'] === 'fgfr1-tacc1' || data['fgfr-fusion'] === 'fgfr3-tacc3';
        if (isTACC) {
            actionableAlerts.push({ gene: `FGFR-TACC fusion (${data['fgfr-fusion'].toUpperCase()})`, drug: 'Inibitori FGFR sperimentali (infigratinib, erdafitinib)', note: 'âš ï¸ Fusione canonica FGFR-TACC: target sperimentale. Fusione â‰  amplificazione. Presente in ~3% GBM IDH-wt. Considerare trial clinico.' });
        } else {
            actionableAlerts.push({ gene: `FGFR fusion (non-TACC: ${data['fgfr-fusion']})`, drug: 'Nessuna terapia standard approvata', note: 'âš ï¸ Fusione FGFR non-TACC: evidenza terapeutica variabile e limitata. Non equiparabile a FGFR1-TACC1 o FGFR3-TACC3. Discussione tumor board prima di qualsiasi decisione terapeutica.' });
        }
        // No score impact: FGFR fusion non Ã¨ marker di entitÃ  specifica
    }
    if (data.braf === 'v600e') {
        actionableAlerts.push({ gene: 'BRAF V600E', drug: 'Dabrafenib + trametinib (FDA approvato BRAF V600E solid tumors)', note: 'Considerare in gliomi pediatrici o adulti con BRAF V600E. Contesto: ganglioglioma, PXA, epithelioid GBM â€” entitÃ  dipendente da morfologia. Tumor board.' });
    }
    if (data.braf === 'fusion') {
        scores.pilocytic += 40;
        if (data.age < 18 && data.location === 'cervelletto') scores.pilocytic += 20;
        alerts.push({ type: 'info', msg: 'â„¹ï¸ BRAF-KIAA1549 fusion: suggestivo di Astrocitoma Pilocitico, ma richiede conferma morfologica (pattern bifasico, fibre di Rosenthal) e contesto clinico. BRAF-KIAA si vede anche in altri LGG pediatrici â€” non Ã¨ criterio sufficiente da solo.' });
    }

    // ---- MSI / MMR / TMB â€” evidenza limitata nei gliomi primari ----
    if (data['msi-status'] === 'msi-h') {
        msiAlerts.push('ðŸ” MSI-H rilevato. Nei gliomi primari Ã¨ evento raro; escludere prima MMR-deficient glioma su base sindromica (Lynch) o iatrogena (post-TMZ). Evidenza per pembrolizumab nei gliomi limitata. Discussione obbligatoria in tumor board prima di qualsiasi decisione terapeutica.');
        if (data.lynch === 'yes') msiAlerts.push('âš ï¸ Sospetto Lynch: counseling genetico obbligatorio. Valutare test germline MMR.');
    }
    if (data['mmr-ihc'] && data['mmr-ihc'] !== 'intact' && data['mmr-ihc'] !== 'not-done' && data['mmr-ihc'] !== '') {
        const gene = data['mmr-ihc'].replace('-loss', '').toUpperCase();
        msiAlerts.push(`âš ï¸ Loss IHC ${gene}: verificare concordanza con PCR MSI. ${data['msi-status'] !== 'msi-h' ? 'Se MSI-H confermato: tumor board.' : ''}`);
    }
    if (data.pole === 'mutato') {
        msiAlerts.push('ðŸ§¬ POLE mutato: ultramutator phenotype. TMB molto alta attesa. Nei gliomi: spesso post-trattamento (TMZ). Evidenza per immunoterapia limitata â€” tumor board.');
    }
    if (data.tmb >= 10) {
        msiAlerts.push(`ðŸ“Š TMB: ${data.tmb} mut/Mb. Cut-off FDA pembrolizumab â‰¥10 mut/Mb (tumor-agnostic). Nei gliomi l'evidenza predittiva Ã¨ limitata rispetto ad altri tumori. Tumor board obbligatorio.`);
    }

    // ---- CDKN2A/B alert â€” gestito dentro il ramo IDH-mut dove ha significato biologico ----
    // L'alert viene generato nel ramo IDH-mut per evitare ridondanza e overgrading di entitÃ  non diffuse

    // ---- CONTROLLI DI INCOERENZA MOLECOLARE ----
    // Combinazioni biologicamente impossibili o altamente sospette da segnalare al patologo
    if (data.atrx === 'lost' && data['1p19q'] === 'codeleted') {
        alerts.push({ type: 'critical', msg: 'ðŸ”´ INCOERENZA MOLECOLARE: ATRX loss + 1p/19q codeleted sono mutualmente esclusivi nella biologia dei gliomi. Verificare qualitÃ  campione, eterogeneitÃ  tumorale, o errore tecnico (FISH/NGS).' });
    }
    if (data['idh-ngs'] === 'wildtype' && data.atrx === 'lost') {
        alerts.push({ type: 'warning', msg: 'âš ï¸ Red flag: ATRX loss in IDH-wt â€” raro e atipico. DDx: GBM con ATRX loss (esiste ma inusuale), campione misto, o artefatto IHC. Rivedere vetrino.' });
    }
    if (data['1p19q'] === 'codeleted' && data['tp53-ngs'] === 'mutato') {
        alerts.push({ type: 'warning', msg: 'âš ï¸ Red flag: 1p/19q codeleted + TP53 mutato â€” combinazione rara (TP53 mut Ã¨ quasi esclusiva del lineage astrocitario). Verificare sequenziamento e FISH.' });
    }
    if (data['egfr-cnv'] === 'amplified' && data['idh-ngs'] && data['idh-ngs'].startsWith('mut')) {
        alerts.push({ type: 'warning', msg: 'âš ï¸ Red flag: EGFR amplificazione in IDH-mutato â€” biologicamente molto raro. IDH-mut esclude quasi sempre EGFR amp. Verificare purezza campione o contaminazione.' });
    }

    // ---- H3K27me3 LOSS / H3F3A K27M â†’ DMG ----
    // H3F3A K27M mut = diagnostico. H3K27me3 loss IHC = surrogate marker (puÃ² avere altre cause).
    if (data.h3f3a === 'k27m') {
        alerts.push({ type: 'critical', msg: 'ðŸš¨ H3F3A K27M mutato: Diffuse Midline Glioma, H3 K27-altered â€” WHO Grade 4. Diagnosi definitiva.' });
        if (data.location === 'emisfero') alerts.push({ type: 'warning', msg: 'âš ï¸ Sede emisferica + H3K27M: escludere DMG emisferico vs DMG corticale (entitÃ  in revisione WHO CNS5+)' });
        diagnosis.grade = 'WHO Grade 4';
        diagnosis.entity = 'Diffuse Midline Glioma, H3 K27-altered';
        diagnosis.confidence = { astrocytoma: 0, oligodendroglioma: 0, glioblastoma: 0, dmg: 100, pilocytic: 0 };
        diagnosis.alerts = alerts;
        diagnosis.actionableAlerts = actionableAlerts;
        diagnosis.msiAlerts = msiAlerts;
        return diagnosis;
    }
    if (data.h3f3a === 'g34r' || data.h3f3a === 'g34w') {
        const g34var = data.h3f3a.toUpperCase();
        alerts.push({ type: 'critical', msg: `ðŸš¨ H3F3A ${g34var} mutato: Diffuse Hemispheric Glioma, H3 G34-mutant â€” WHO Grade 4 (WHO CNS5 2021, entitÃ  distinta da DMG). Tipicamente emisferico, giovane adulto (15-35 anni). ATRX loss e TP53 frequenti co-occorrenti.` });
        if (data.location !== 'emisfero') alerts.push({ type: 'warning', msg: `âš ï¸ H3F3A ${g34var} in sede non emisferica: atipico â€” rivedere classificazione e qualitÃ  campione.` });
        if (data.age > 40) alerts.push({ type: 'warning', msg: `âš ï¸ H3F3A G34 in paziente >40 anni: inusuale. Verificare sequenziamento.` });
        diagnosis.grade = 'WHO Grade 4';
        diagnosis.entity = `Diffuse Hemispheric Glioma, H3 G34-mutant (${g34var})`;
        diagnosis.confidence = { astrocytoma: 0, oligodendroglioma: 0, glioblastoma: 5, dmg: 0, h3altered: 95, pilocytic: 0 };
        diagnosis.alerts = alerts;
        diagnosis.actionableAlerts = actionableAlerts;
        diagnosis.msiAlerts = msiAlerts;
        return diagnosis;
    }
    if (data.h3k27me3 === 'lost' && data.h3f3a !== 'k27m') {
        const midlineLike = data.location === 'linea-mediana' || data.location === 'midline' || data.location === 'spinale';
        const dmgConf = midlineLike ? 90 : 60;
        alerts.push({ type: 'critical', msg: `ðŸš¨ H3K27me3 loss IHC (senza H3F3A K27M NGS): ${midlineLike ? 'sede midline â€” fortemente suggestivo di DMG H3K27-altered' : 'sede NON midline â€” confidenza DMG ridotta (DDx piÃ¹ ampia)'}. Confermare con NGS H3F3A/H3C. H3K27me3 loss non Ã¨ esclusivo di DMG: presente in PF-EPN-A e tumori con EZHIP overexpression.` });
        if (!midlineLike) alerts.push({ type: 'warning', msg: 'âš ï¸ H3K27me3 loss in sede non midline: allargare DDx (ependimoma PF-A, tumore con EZHIP). Peso diagnostico ridotto.' });
        if (data.location === 'emisfero') alerts.push({ type: 'warning', msg: 'âš ï¸ Sede emisferica + H3K27me3 loss: DDx piÃ¹ ampia â€” eseguire NGS H3F3A urgente' });
        diagnosis.grade = 'WHO Grade 4 (provvisorio â€” conferma NGS)';
        diagnosis.entity = 'Sospetto DMG, H3K27-altered (conferma NGS H3F3A obbligatoria)';
        diagnosis.confidence = { astrocytoma: 0, oligodendroglioma: 0, glioblastoma: midlineLike ? 0 : 20, dmg: dmgConf, h3altered: 0, pilocytic: 0 };
        diagnosis.alerts = alerts;
        diagnosis.actionableAlerts = actionableAlerts;
        diagnosis.msiAlerts = msiAlerts;
        return diagnosis;
    }

    // BRAF fusion: NON Ã¨ early return â€” serve morfologia pilocitica per diagnosi definitiva
    // L'alert Ã¨ giÃ  stato generato sopra, il score pilocytic Ã¨ giÃ  stato aggiunto

    // ---- IDH STATUS ----
    let idhStatus = data['idh-ngs'];
    if (!idhStatus || idhStatus === '' || idhStatus === 'not-done') {
        if (data['idh-ihc'] === 'positive') { idhStatus = 'mutato-ihc'; }
        else if (data['idh-ihc'] === 'negative') { idhStatus = 'wildtype-ihc'; }
        else {
            alerts.push({ type: 'warning', msg: 'â³ IDH status non determinato â€” diagnosi provvisoria' });
            diagnosis.entity = 'Glioma (tipo indeterminato)';
            diagnosis.grade = 'Indeterminato';
            diagnosis.alerts = alerts;
            diagnosis.actionableAlerts = actionableAlerts;
            diagnosis.msiAlerts = msiAlerts;
            return diagnosis;
        }
    }

    const isIDHMut = idhStatus.startsWith('mut') && idhStatus !== 'wildtype' && idhStatus !== 'wildtype-ihc';
    const isIDHWt = idhStatus === 'wildtype' || idhStatus === 'wildtype-ihc';
    // Hoisted for use outside IDH branches (MGMT, TERT warning, BRAF penalty)
    const egfrAmp = data['egfr-cnv'] === 'amplified';
    const tertMut = data.tert === 'mutato';
    const chr710 = data['chr7-10'] === 'present';

    if (isIDHMut) {
        // ---- IDH MUTATO ----
        scores.astrocytoma += 50; scores.oligodendroglioma += 40;

        // Discordanza IHC-/NGS+
        if (data['idh-ihc'] === 'negative' && idhStatus.includes('mut')) {
            alerts.push({ type: 'warning', msg: 'âš ï¸ Discordanza IHC IDH1 R132H negativo / NGS mutato â†’ Mutazione NON-R132H (R132C, R132G, IDH2) o errore tecnico' });
        } else {
            alerts.push({ type: 'success', msg: 'âœ“ IDH mutato confermato' });
        }

        const tp53Altered = (data.p53 > 10) || (data['tp53-ngs'] === 'mutato');
        const atypiaScore = { 'scarse': 1, 'moderate': 2, 'numerose': 3 }[data.atypia] || 0;
        // FIX: WHO CNS5 â€” necrosi OR MVP sono criteri indipendenti per Grade 4 (non richiedono entrambi)
        const hasNecrosis = data.histFeatures.necrosis;
        const hasMVP = data.histFeatures.microvascular;

        // TP53: marker di lineage astrocitario, evento precoce in IDH-mut astrocytoma
        // NON Ã¨ criterio di grading WHO â€” solo supporta l'identitÃ  astrocitaria
        if (tp53Altered) {
            alerts.push({ type: 'info', msg: 'â„¹ï¸ TP53 alterato: supporta lineage astrocitario. Non Ã¨ criterio di grading WHO CNS5.' });
        }

        // PI3K pathway in IDH-mut
        if (data.pik3ca === 'mutato') alerts.push({ type: 'info', msg: 'â„¹ï¸ PIK3CA mutato: attivazione pathway PI3K/AKT. Raro in IDH-mut; verificare purezza campione.' });
        if (data.pten === 'loss') alerts.push({ type: 'warning', msg: 'âš ï¸ PTEN loss: piÃ¹ frequente in IDH-wt GBM; in IDH-mut suggerisce progressione o diagnosi differenziale' });

        // Grading WHO CNS5 â€” basato su criteri morfologici + CDKN2A (TP53 escluso per WHO compliance)
        // Guard: criteri morfologici Grade 4 si applicano solo a pattern diffuso infiltrante
        const isDiffusePattern = !data.celltype || data.celltype === 'astrocytic' || data.celltype === 'mixed' || data.celltype === 'glioblastic';
        if (isDiffusePattern && (hasNecrosis || hasMVP || data.mitosis >= 10)) {
            diagnosis.grade = 'WHO Grade 4';
            // No glioblastoma score boost â€” in IDH-mut, Grade 4 = Astrocytoma IDH-mut Gr4, not GBM
            const criterioGr4 = [hasNecrosis ? 'Necrosi' : null, hasMVP ? 'Prolif. microvascolare' : null, data.mitosis >= 10 ? `Mitosi â‰¥10 (${data.mitosis}/HPF)` : null].filter(Boolean).join(' + ');
            alerts.push({ type: 'critical', msg: `ðŸš¨ Criterio morfologico Grade 4: ${criterioGr4}` });
            if (hasNecrosis || hasMVP) {
                alerts.push({ type: 'warning', msg: 'âš ï¸ Necrosi/MVP in IDH-mutato Ã¨ evento raro rispetto a CDKN2A del â†’ escludere sampling bias, sovradiagnosi morfologica, o campionamento di area necrotica non rappresentativa.' });
            }
        } else if (!isDiffusePattern && (hasNecrosis || hasMVP)) {
            alerts.push({ type: 'warning', msg: 'âš ï¸ Necrosi/MVP in celltype non diffuso: escludere necrosi artefattuale o campionamento di entitÃ  circoscritta. Non applicare criteri Grade 4 da soli.' });
        } else if (data.cdkn2a === 'homozygous-del') {
            // NOTA: CDKN2A/B hom-del come criterio Grade 4 Ã¨ specifico per Astrocytoma IDH-mutated (WHO CNS5)
            // Non applicare a entitÃ  IDH-wt (dove non cambia grading) nÃ© a oligodendroglioma (valore meno definito)
            diagnosis.grade = 'WHO Grade 4';
            alerts.push({ type: 'critical', msg: 'ðŸš¨ CDKN2A/B homozygous deletion: criterio WHO CNS5 per Astrocytoma IDH-mutated, WHO Grade 4 â€” anche in assenza di necrosi, MVP o mitosi elevate.' });
        } else if (atypiaScore === 3 || data.mitosis >= 4) {
            diagnosis.grade = 'WHO Grade 3'; scores.astrocytoma += 40;
            alerts.push({ type: 'warning', msg: `âš ï¸ Atipia numerosa e/o mitosi â‰¥4 (${data.mitosis}/HPF): Grade 3` });
        } else if (atypiaScore >= 2 || data.mitosis >= 2) {
            diagnosis.grade = 'WHO Grade indeterminato (tra 2 e 3 â€” borderline)'; scores.astrocytoma += 30;
            alerts.push({ type: 'warning', msg: 'âš ï¸ Morfologia borderline Gr.2/3: valutare campionamento e contesto clinico' });
        } else {
            diagnosis.grade = 'WHO Grade 2'; scores.astrocytoma += 20;
        }

        // Entity: Astrocytoma vs Oligodendroglioma
        if (data.atrx === 'lost') {
            diagnosis.entity = 'Astrocytoma, IDH-mutated (WHO CNS5 2021)';
            scores.astrocytoma += 60;
            alerts.push({ type: 'success', msg: 'âœ“ ATRX loss â†’ Astrocytoma (mutually exclusive con 1p/19q codeletion)' });
        } else if (data.atrx === 'retained' && data['1p19q'] === 'codeleted') {
            diagnosis.entity = 'Oligodendroglioma, IDH-mutated and 1p/19q-codeleted (WHO CNS5 2021)';
            scores.oligodendroglioma += 100;
            if (data.tert === 'mutato') { scores.oligodendroglioma += 30; alerts.push({ type: 'success', msg: 'âœ“ TERT mut + 1p/19q codel: pattern molecolare Oligodendroglioma confermato' }); }
            alerts.push({ type: 'success', msg: 'âœ“ 1p/19q codeleted + ATRX retained â†’ Oligodendroglioma definito' });
            if (data.mitosis >= 4 || atypiaScore >= 2) diagnosis.grade = 'WHO Grade 3';
        } else if (data.atrx === 'retained' && data['1p19q'] !== 'codeleted' && data['1p19q'] !== 'not-done') {
            diagnosis.entity = 'Astrocytoma, IDH-mutated (ATRX retained, 1p/19q non-codeleted)';
            scores.astrocytoma += 40;
            alerts.push({ type: 'info', msg: 'â„¹ï¸ ATRX retained + 1p/19q non-codel: fenotipo astrocitario inusuale. DDx: ATRX wt astrocytoma (raro) | artefatto FISH | campione non rappresentativo â€” valutare qualitÃ  pre-analitica e campionamento' });
        } else {
            diagnosis.entity = 'Glioma IDH-mutated (fenotipo da completare)';
            alerts.push({ type: 'warning', msg: 'âš ï¸ ATRX e/o 1p/19q non disponibili: fenotipo incompleto' });
        }

        // Append CDKN2A qualifier to entity if it drove Grade 4
        if (data.cdkn2a === 'homozygous-del' && diagnosis.entity) {
            diagnosis.entity = diagnosis.entity.replace(' (WHO CNS5 2021)', '') + ', WHO Grade 4 (CDKN2A/B homozygous deletion)';
        }

    } else if (isIDHWt) {
        // ---- IDH WILDTYPE ----
        alerts.push({ type: 'success', msg: 'âœ“ IDH wildtype confermato' });
        scores.glioblastoma += 40;

        const tp53Altered = (data.p53 > 10) || (data['tp53-ngs'] === 'mutato');
        // FIX: WHO CNS5 â€” necrosi OR MVP indipendenti
        const hasNecrosis = data.histFeatures.necrosis;
        const hasMVP = data.histFeatures.microvascular;

        // GBM molecolare (cIMPACT-NOW update 3): IDH-wt + UNO dei seguenti = Grade 4
        // egfrAmp, tertMut, chr710 hoisted to function scope above
        const molecularGBM = egfrAmp || chr710 || tertMut;  // OR, non AND â€” un solo criterio Ã¨ sufficiente
        // Guard: cIMPACT-NOW vale per "IDH-wt diffuse astrocytic glioma" â€” non per tumori circoscritti
        const isDiffusePatternWt = !data.celltype || data.celltype === 'astrocytic' || data.celltype === 'mixed' || data.celltype === 'glioblastic';

        if (molecularGBM) {
            const criteria = [egfrAmp ? 'EGFR amp' : null, chr710 ? '+7/-10' : null, tertMut ? 'TERT mut' : null].filter(Boolean).join(' + ');
            if (isDiffusePatternWt) {
                alerts.push({ type: 'critical', msg: `ðŸš¨ GBM molecolare (cIMPACT-NOW update 3): ${criteria} â†’ Grade 4 in glioma diffuso IDH-wt, anche senza criteri morfologici` });
            } else {
                alerts.push({ type: 'warning', msg: `âš ï¸ Criteri molecolari GBM (${criteria}) in pattern non diffuso: cIMPACT-NOW si applica a glioma diffuso astrocitario â€” escludere tumore circoscritto IDH-wt con queste alterazioni prima di classificare GBM.` });
            }
        }

        if (isDiffusePatternWt && (data.mitosis >= 10 || hasNecrosis || hasMVP || molecularGBM)) {
            diagnosis.grade = 'WHO Grade 4';
            diagnosis.entity = 'Glioblastoma, IDH-wildtype (WHO CNS5 2021)';
            scores.glioblastoma += 80;
            if (hasNecrosis || hasMVP) {
                const crit = [hasNecrosis ? 'Necrosi' : null, hasMVP ? 'MVP' : null].filter(Boolean).join(' + ');
                alerts.push({ type: 'critical', msg: `ðŸš¨ Criteri morfologici Grade 4: ${crit}` });
            }
        } else if (!isDiffusePatternWt && molecularGBM) {
            diagnosis.grade = 'WHO Grade indeterminato (pattern non diffuso)';
            diagnosis.entity = 'Glioma IDH-wildtype, pattern circoscritto (tipo da determinare)';
            scores.glioblastoma += 20;
            alerts.push({ type: 'warning', msg: 'âš ï¸ Alterazioni molecolari GBM in tumore non diffuso: classificazione WHO richiede conferma di pattern infiltrante. Rivalutare morfologia.' });
        } else {
            diagnosis.grade = 'Grading indeterminato (pannello incompleto / possibile sottocampionamento)';
            diagnosis.entity = 'Glioma diffuso, IDH-wildtype (tipo da determinare)';
            scores.glioblastoma += 30;
            alerts.push({ type: 'warning', msg: 'âš ï¸ Glioma IDH-wt senza criteri GBM morfologici nÃ© molecolari completi: pannello completo obbligatorio' });
            if (data.age > 50) {
                alerts.push({ type: 'warning', msg: `âš ï¸ Realismo clinico: adulto ${data.age} anni, IDH-wt, senza criteri GBM â†’ altissima probabilitÃ  di GBM sottocampionato. Considerare re-biopsia stereotassica o rivalutazione imaging (enhancement rimasto fuori campo?).` });
            }
        }

        // Molecular markers GBM
        if (egfrAmp) { scores.glioblastoma += 30; alerts.push({ type: 'warning', msg: 'âš ï¸ EGFR amplificato: Classical subtype GBM. Prognosticamente sfavorevole.' }); }
        if (data['egfr-snv'] === 'vIII') { scores.glioblastoma += 20; alerts.push({ type: 'info', msg: 'â„¹ï¸ EGFRvIII: marker prognostico sfavorevole. Target sperimentale (vaccini, ADC). Non predittivo risposta a TKI standard.' }); }
        if (tertMut) { scores.glioblastoma += 20; alerts.push({ type: 'info', msg: 'â„¹ï¸ TERT promoter mutato: favorisce GBM primario IDH-wt. Prognosi sfavorevole.' }); }
        if (chr710) { scores.glioblastoma += 25; alerts.push({ type: 'warning', msg: 'âš ï¸ +7/-10 presente: pattern cromosomico GBM.' }); }
        if (data['met-cnv'] === 'amplified') alerts.push({ type: 'critical', msg: 'ðŸš¨ MET amplificato: prognosi molto sfavorevole in GBM. Target sperimentale (cabozantinib, tepotinib). Discutere trial.' });
        if (data.pten === 'loss') { scores.glioblastoma += 20; alerts.push({ type: 'info', msg: 'â„¹ï¸ PTEN loss: attivazione pathway PI3K/AKT/mTOR. Presente in ~40% GBM. Associato a mesenchymal subtype.' }); }
        if (data.nf1 === 'mutato') alerts.push({ type: 'info', msg: 'â„¹ï¸ NF1 loss: Mesenchymal subtype GBM. Prognosi peggiore rispetto a Classical.' });
        if (data.mtor === 'mutato') alerts.push({ type: 'info', msg: 'â„¹ï¸ mTOR mutato (gain-of-function): target rapamicina/everolimus. Dati clinici limitati in gliomi.' });
        if (data['nrg1-fusion'] === 'positive') alerts.push({ type: 'warning', msg: 'âš ï¸ NRG1 fusion: entitÃ  emergente nei gliomi IDH-wt. Verificare con letteratura aggiornata (WHO review in corso).' });
        if (tp53Altered) alerts.push({ type: 'info', msg: 'â„¹ï¸ TP53 alterato: presente in subset di GBM IDH-wt, piÃ¹ frequente nei casi proneural-like.' });

    }

    // ============================================================
    // MGMT â€” fuori da entrambi i rami IDH per simmetria
    // Il messaggio si adatta a isIDHMut per correttezza biologica
    // ============================================================
    if (data.mgmt === 'methylated') {
        if (isIDHMut) {
            alerts.push({ type: 'info', msg: 'âœ“ MGMT metilato. In IDH-mutato la metilazione Ã¨ frequente per ipermetilazione globale G-CIMP â€” il valore predittivo per TMZ Ã¨ meno discriminante rispetto a GBM IDH-wt.' });
        } else {
            alerts.push({ type: 'success', msg: 'âœ“ MGMT metilato: predittore favorevole risposta a temozolomide in GBM IDH-wt. Beneficio documentato (Hegi 2005, Stupp protocol). Impatto su OS +9 mesi mediana.' });
        }
    } else if (data.mgmt === 'unmethylated') {
        alerts.push({ type: 'warning', msg: 'âš ï¸ MGMT non metilato: ridotta risposta a TMZ. Considerare alternative terapeutiche (CCNU, bevacizumab, trial clinici).' });
    }

    // FIX 3: TERT mut isolato in giovane adulto IDH-wt â€” cIMPACT valido ma raffinamento senior
    if (isIDHWt && tertMut && !egfrAmp && !chr710 && data.age < 40) {
        alerts.push({ type: 'warning', msg: `âš ï¸ TERT mut isolato in giovane adulto (${data.age} anni) IDH-wt senza EGFR amp nÃ© +7/-10: raro pattern. Escludere tumore circoscritto IDH-wt con TERT mut (es. LGG circoscritto, tumori non GBM) prima di classificare GBM molecolare.` });
    }

    // FIX 4: BRAF fusion â€” penalizza score pilocitico se morfologia high-grade
    if (data.braf === 'fusion' && (data.mitosis >= 10 || data.histFeatures.necrosis)) {
        scores.pilocytic = Math.max(scores.pilocytic - 40, 0);
        alerts.push({ type: 'warning', msg: 'âš ï¸ BRAF fusion con morfologia high-grade (necrosi / mitosi â‰¥10): profilo incompatibile con astrocitoma pilocitico classico. Considerare LGG trasformato o entitÃ  diversa.' });
    }

    // Normalizza scores
    const maxScore = Math.max(...Object.values(scores), 1);
    const confidence = {};
    for (const k in scores) confidence[k] = Math.round((scores[k] / maxScore) * 100);

    // ============================================================
    // RAGIONAMENTO DIAGNOSTICO â€” Step-by-step + gerarchia criteri
    // ============================================================
    const idhMut = data['idh-ngs'] ? data['idh-ngs'].startsWith('mut') : (data['idh-ihc'] === 'positive');
    const idhWt  = data['idh-ngs'] === 'wildtype' || (!idhMut && data['idh-ihc'] === 'negative');
    const has1p19q = data['1p19q'] === 'codeleted';
    const atrxLost = data.atrx === 'lost';

    // Step 1 â€” Morfologia
    const stepMorfologia = [];
    if (data.celltype) stepMorfologia.push({ status: 'âœ”', label: `CellularitÃ : ${data.cellularity || 'â€”'}, tipo: ${data.celltype}` });
    if (data.mitosis > 0) stepMorfologia.push({ status: data.mitosis >= 4 ? 'âš ' : 'âœ”', label: `Mitosi: ${data.mitosis}/10HPF ${data.mitosis >= 20 ? '(â†’ Gr.4)' : data.mitosis >= 4 ? '(â†’ Gr.3)' : '(Gr.2)'}` });
    if (data.histFeatures.necrosis) stepMorfologia.push({ status: 'âš ', label: 'Necrosi: presente' });
    if (data.histFeatures.microvascular) stepMorfologia.push({ status: 'âš ', label: 'Proliferazione microvascolare: presente' });
    if (!data.histFeatures.necrosis && !data.histFeatures.microvascular) stepMorfologia.push({ status: 'âœ”', label: 'Nessuna necrosi / MVP' });

    // Step 2 â€” IHC
    const stepIHC = [];
    if (data['idh-ihc']) stepIHC.push({ status: 'âœ”', label: `IDH IHC: ${data['idh-ihc']}` });
    if (data.atrx) stepIHC.push({ status: 'âœ”', label: `ATRX: ${data.atrx}` });
    if (data.p53 > 0) stepIHC.push({ status: 'âœ”', label: `p53: ${data.p53}% (${data.p53 > 10 ? 'overespresso / mut pattern' : 'WT'})` });

    // Step 3 â€” Molecolare
    const stepMol = [];
    if (data['idh-ngs']) stepMol.push({ status: 'âœ”', label: `IDH NGS: ${data['idh-ngs']}` });
    if (data['1p19q']) stepMol.push({ status: 'âœ”', label: `1p/19q: ${data['1p19q']}` });
    if (data.tert && data.tert !== 'not-done') stepMol.push({ status: data.tert === 'mutato' ? 'âš ' : 'âœ”', label: `TERT: ${data.tert}` });
    if (data.cdkn2a && data.cdkn2a !== 'not-done') stepMol.push({ status: data.cdkn2a === 'homozygous-del' ? 'âš ' : 'âœ”', label: `CDKN2A: ${data.cdkn2a}` });
    if (data['egfr-cnv'] && data['egfr-cnv'] !== 'not-done') stepMol.push({ status: data['egfr-cnv'] === 'amplified' ? 'âš ' : 'âœ”', label: `EGFR CNV: ${data['egfr-cnv']}${data['egfr-snv'] ? ' / SNV: ' + data['egfr-snv'] : ''}` });
    if (data['chr7-10'] && data['chr7-10'] !== 'not-done') stepMol.push({ status: data['chr7-10'] === 'present' ? 'âš ' : 'âœ”', label: `+7/-10: ${data['chr7-10']}` });
    if (data.h3f3a && data.h3f3a !== 'wildtype' && data.h3f3a !== 'not-done') stepMol.push({ status: 'âš ', label: `H3F3A: ${data.h3f3a}` });
    if (data.mgmt && data.mgmt !== 'not-done') stepMol.push({ status: 'ðŸ§¬', label: `MGMT: ${data.mgmt} (supporto, non determinante per entitÃ )` });

    // Step 4 â€” Criterio WHO soddisfatto
    const stepWHO = [];
    if (diagnosis.entity) {
        stepWHO.push({ status: 'âœ”', label: `EntitÃ  classificabile: ${diagnosis.entity}` });
        if (diagnosis.grade) stepWHO.push({ status: 'âœ”', label: `Grade assegnato: ${diagnosis.grade}` });
    } else {
        stepWHO.push({ status: 'âŒ', label: 'EntitÃ  non classificabile con i dati inseriti â€” criteri WHO insufficienti' });
    }

    // Elementi molecolari di supporto (non determinanti)
    const supportOnly = [];
    if (data.mgmt && data.mgmt !== 'not-done') supportOnly.push(`MGMT metilazione (risposta TMZ â€” non criterio entitÃ )`);
    if (data.pten && data.pten !== 'wildtype' && data.pten !== 'not-done') supportOnly.push(`PTEN loss (segnalazione PI3K â€” non criterio primario)`);
    if (data.nf1 && data.nf1 !== 'wildtype' && data.nf1 !== 'not-done') supportOnly.push(`NF1 mut (subtype mesenchymal â€” non criterio entitÃ )`);

    // ============================================================
    // ESCLUSIONI RAGIONATE
    // ============================================================
    const exclusions = [];
    const entity = diagnosis.entity || '';

    if (!entity.includes('Oligodendroglioma')) {
        if (!idhMut)       exclusions.push({ entity: 'Oligodendroglioma', reason: 'IDH wildtype (IDH-mut richiesto per definizione)' });
        else if (!has1p19q) exclusions.push({ entity: 'Oligodendroglioma', reason: '1p/19q non codeleta (codelezione richiesta per definizione WHO CNS5)' });
    }
    if (!entity.includes('Astrocytoma, IDH-mutated')) {
        if (!idhMut) exclusions.push({ entity: 'Astrocytoma IDH-mutated', reason: 'IDH wildtype' });
        else if (has1p19q) exclusions.push({ entity: 'Astrocytoma IDH-mutated', reason: '1p/19q codeleta â†’ diagnosi preferenziale oligodendroglioma' });
    }
    if (!entity.includes('Glioblastoma')) {
        if (idhMut) {
            exclusions.push({ entity: 'Glioblastoma IDH-wildtype', reason: 'IDH mutato (GBM IDH-wt richiede IDH wildtype per definizione WHO CNS5)' });
        } else {
            const missingGBMcrit = [];
            if (!data.histFeatures.necrosis && !data.histFeatures.microvascular) missingGBMcrit.push('assenza necrosi/MVP morfologica');
            const egfrAmpC = data['egfr-cnv'] === 'amplified';
            const tertMutC = data.tert === 'mutato';
            const chr710C  = data['chr7-10'] === 'present';
            if (!egfrAmpC && !tertMutC && !chr710C) missingGBMcrit.push('assenza criteri molecolari cIMPACT (EGFR amp, TERT mut, +7/-10)');
            if (missingGBMcrit.length > 0) exclusions.push({ entity: 'Glioblastoma IDH-wildtype', reason: missingGBMcrit.join('; ') });
        }
    }
    if (!entity.includes('Midline') && !entity.includes('DMG')) {
        if (data.h3f3a !== 'k27m') exclusions.push({ entity: 'Diffuse Midline Glioma H3 K27-altered', reason: 'H3 K27M non rilevato (o NGS non eseguito)' });
        else if (!['linea-mediana','midline','spinale'].some(l => data.location === l)) exclusions.push({ entity: 'Diffuse Midline Glioma', reason: 'Sede non midline (richiesta per definizione: talamo, ponte, midollo)' });
    }
    if (!entity.includes('Pilocitico') && !entity.includes('Pilocytic')) {
        if (data.braf !== 'fusion') exclusions.push({ entity: 'Astrocitoma Pilocitico', reason: 'Assenza BRAF-KIAA1549 fusion (principale marker molecolare)' });
    }

    // Missing fields (ceiling soft)
    const missingRequired = [];
    if (!data['idh-ngs'] && !data['idh-ihc']) missingRequired.push({ status: 'âŒ', label: 'IDH: nessun dato (IHC o NGS) â€” criterio obbligatorio per classificazione diffuse glioma' });
    if (!data.atrx) missingRequired.push({ status: 'âŒ', label: 'ATRX IHC: non inserito' });
    if (!data['1p19q']) missingRequired.push({ status: 'âŒ', label: '1p/19q: non inserito (necessario per DDx oligodendroglioma)' });
    if (!data.tert || data.tert === 'not-done') missingRequired.push({ status: 'âš ', label: 'TERT: non eseguito â€” rilevante per GBM molecolare IDH-wt e meningiomi' });

    diagnosis.confidence   = confidence;
    diagnosis.alerts       = alerts;
    diagnosis.actionableAlerts = actionableAlerts;
    diagnosis.msiAlerts    = msiAlerts;
    diagnosis.reasoning    = { stepMorfologia, stepIHC, stepMol, stepWHO, supportOnly };
    diagnosis.exclusions   = exclusions;
    diagnosis.missingRequired = missingRequired;
    return diagnosis;
}

// ============================================================
// DISPLAY
// ============================================================
function generateDiagnosis() {
    const data = getData();
    const diagnosis = computeDiagnosis(data);
    displayDiagnosis(diagnosis, data);
    highlightRelevantReferences(diagnosis, data);
    setTimeout(() => document.querySelector('.biblio-section').scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 600);
}

function displayDiagnosis(diagnosis, data) {
    let html = '';

    // ACTIONABLE BANNER
    if (diagnosis.actionableAlerts && diagnosis.actionableAlerts.length > 0) {
        html += '<div style="margin-bottom:16px;">';
        for (const a of diagnosis.actionableAlerts) {
            html += `<div class="actionable-banner">
                <div class="title">ðŸŽ¯ Alterazione Actionable: ${a.gene}</div>
                <div class="content"><strong>Target therapy:</strong> ${a.drug}<br><span style="font-size:11px;color:var(--text-dim);">${a.note}</span></div>
            </div>`;
        }
        html += '</div>';
    }

    // MSI ALERTS
    if (diagnosis.msiAlerts && diagnosis.msiAlerts.length > 0) {
        for (const m of diagnosis.msiAlerts) {
            html += `<div class="alert alert-info" style="border-color:#b0308a;background:#fdf0f8;color:#7a1a5a;">${m}</div>`;
        }
    }

    // ALERTS DIAGNOSTICI
    if (diagnosis.alerts) {
        for (const a of diagnosis.alerts) {
            const cls = {warning:'alert-warning',success:'alert-success',info:'alert-info',critical:'alert-critical'}[a.type]||'alert-info';
            html += `<div class="alert ${cls}">${a.msg}</div>`;
        }
    }

    // ENTITÃ€ + GRADE BOX
    if (diagnosis.entity) {
        html += `<div class="diagnosis-box">
            <h3>Ipotesi classificativa WHO CNS5 2021</h3>
            <div class="diagnosis-entity">${diagnosis.entity}</div>
            <div class="diagnosis-grade">${diagnosis.grade || ''}</div>
        </div>`;
    }

    // RAGIONAMENTO DIAGNOSTICO
    const R = diagnosis.reasoning;
    if (R) {
        const stepColor = s => ({'âœ”':'var(--green)','âš ':'var(--amber)','âŒ':'var(--red)','ðŸ§¬':'var(--purple)'}[s]||'var(--text-dim)');
        const renderStep = rows => rows.map(r => `
            <div style="display:flex;gap:10px;align-items:flex-start;padding:5px 0;border-bottom:1px solid var(--border);font-size:12px;">
                <span style="font-size:13px;width:20px;flex-shrink:0;color:${stepColor(r.status)}">${r.status}</span>
                <span style="color:var(--text)">${r.label}</span>
            </div>`).join('');

        const sectionLabel = t => `<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-dim);margin-bottom:6px">${t}</div>`;

        html += `<div class="diagnosis-box" style="margin-top:12px">
            <h3 style="margin-bottom:4px">ðŸ§  Ragionamento Diagnostico</h3>
            <div class="help-text" style="margin-bottom:12px">Percorso logico: morfologia â†’ IHC â†’ molecolare â†’ criterio WHO. Legenda: âœ” soddisfatto Â· âš  borderline/alterato Â· âŒ mancante/negativo Â· ðŸ§¬ supporto non determinante</div>`;

        html += `<div style="margin-bottom:14px">${sectionLabel('Step 1 â€” Morfologia EE')}`;
        html += R.stepMorfologia.length ? renderStep(R.stepMorfologia) : '<div style="font-size:12px;color:var(--text-dim)">Dati morfologici insufficienti</div>';
        html += '</div>';

        html += `<div style="margin-bottom:14px">${sectionLabel('Step 2 â€” IHC')}`;
        html += R.stepIHC.length ? renderStep(R.stepIHC) : '<div style="font-size:12px;color:var(--text-dim)">Nessun dato IHC</div>';
        html += '</div>';

        html += `<div style="margin-bottom:14px">${sectionLabel('Step 3 â€” Molecolare (NGS)')}`;
        html += R.stepMol.length ? renderStep(R.stepMol) : '<div style="font-size:12px;color:var(--text-dim)">Nessun dato molecolare</div>';
        html += '</div>';

        html += `<div style="margin-bottom:14px">${sectionLabel('Step 4 â€” Criterio WHO CNS5 soddisfatto')}`;
        html += renderStep(R.stepWHO);
        html += '</div>';

        if (R.supportOnly && R.supportOnly.length) {
            html += `<div style="background:var(--purple-dim);border-radius:6px;padding:8px 12px;margin-top:4px">
                <div style="font-size:11px;font-weight:700;color:var(--purple);margin-bottom:4px">ðŸ§¬ Elementi molecolari di supporto (non determinanti per entitÃ )</div>
                ${R.supportOnly.map(s=>`<div style="font-size:12px;color:var(--text-dim);padding:2px 0">Â· ${s}</div>`).join('')}
            </div>`;
        }

        if (diagnosis.missingRequired && diagnosis.missingRequired.length) {
            html += `<div style="background:var(--red-dim);border:1px solid var(--red);border-radius:6px;padding:8px 12px;margin-top:10px">
                <div style="font-size:11px;font-weight:700;color:var(--red);margin-bottom:4px">âŒ Criteri mancanti o non eseguiti</div>
                ${diagnosis.missingRequired.map(r=>`<div style="font-size:12px;color:var(--red);padding:2px 0">${r.status} ${r.label}</div>`).join('')}
            </div>`;
        }
        html += '</div>';
    }

    // ESCLUSIONI RAGIONATE
    if (diagnosis.exclusions && diagnosis.exclusions.length > 0) {
        html += `<div class="diagnosis-box" style="margin-top:12px">
            <h3 style="margin-bottom:8px">âŒ EntitÃ  escluse â€” perchÃ© no</h3>
            <div class="help-text" style="margin-bottom:10px">Criterio determinante dell'esclusione per ogni entitÃ  del pannello diagnostico differenziale.</div>`;
        for (const ex of diagnosis.exclusions) {
            html += `<div style="display:flex;gap:10px;align-items:flex-start;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px;">
                <span style="color:var(--red);flex-shrink:0;font-weight:700">âŒ</span>
                <div><span style="font-weight:600;color:var(--text)">${ex.entity}</span>
                <span style="color:var(--text-dim)"> â€” ${ex.reason}</span></div>
            </div>`;
        }
        html += '</div>';
    }

    // SCORING (in basso, rinominato)
    if (diagnosis.confidence) {
        const allowed = new Set(['astrocytoma','oligodendroglioma','glioblastoma','dmg','h3altered','pilocytic']);
        const colors  = {astrocytoma:'#1a5cc8',oligodendroglioma:'#6b35cc',glioblastoma:'#c02828',dmg:'#c07010',h3altered:'#0d8a94',pilocytic:'#1a9954'};
        const labels  = {astrocytoma:'Astrocytoma, IDH-mutated',oligodendroglioma:'Oligodendroglioma, IDH-mut 1p/19q-codel',glioblastoma:'Glioblastoma, IDH-wildtype',dmg:'DMG, H3 K27-altered',h3altered:'Diffuse Hemispheric Glioma, H3 G34-mutant',pilocytic:'Astrocytoma Pilocitico'};
        const filtered = Object.entries(diagnosis.confidence).filter(([k,v])=>allowed.has(k)&&v>0).sort((a,b)=>b[1]-a[1]).slice(0,3);
        if (filtered.length) {
            html += '<div class="scoring-container" style="margin-top:12px"><h3>Indice di compatibilitÃ  morfo-molecolare</h3>';
            html += '<div class="help-text" style="margin-bottom:12px">Allineamento qualitativo pre-ragionamento â€” non Ã¨ probabilitÃ  bayesiana, non confrontabile tra casi, non usare per scelta terapeutica.</div>';
            for (const [key,pct] of filtered) {
                html += `<div class="scoring-row">
                    <div class="scoring-label"><span>${labels[key]}</span><span style="font-family:var(--font-mono);color:${colors[key]}">${pct}%</span></div>
                    <div class="scoring-bar-bg"><div class="scoring-bar-fill" style="width:${pct}%;background:${colors[key]};"></div></div>
                </div>`;
            }
            html += '</div>';
        }
    }

    // SUMMARY TABLE
    html += `<div class="diagnosis-box" style="margin-top:12px"><h3>Riepilogo findings</h3>
        <table class="summary-table">
            <tr><td>EtÃ  / Sede</td><td>${data.age}a. / ${data.location||'â€”'}</td></tr>
            <tr><td>Mitosi / Ki-67</td><td>${data.mitosis}/10 HPF / ${data.ki67}%</td></tr>
            <tr><td>Necrosi / MVP</td><td>${data.histFeatures.necrosis?'SÃ¬':'No'} / ${data.histFeatures.microvascular?'SÃ¬':'No'}</td></tr>
            <tr><td>IDH (IHC / NGS)</td><td>${data['idh-ihc']||'â€”'} / ${data['idh-ngs']||'â€”'}</td></tr>
            <tr><td>ATRX / 1p-19q</td><td>${data.atrx||'â€”'} / ${data['1p19q']||'â€”'}</td></tr>
            <tr><td>TERT / H3F3A</td><td>${data.tert||'â€”'} / ${data.h3f3a||'â€”'}</td></tr>
            <tr><td>CDKN2A/B / EGFR</td><td>${data.cdkn2a||'â€”'} / ${data['egfr-cnv']||'â€”'}</td></tr>
            <tr><td>+7/-10 / PTEN</td><td>${data['chr7-10']||'â€”'} / ${data.pten||'â€”'}</td></tr>
            <tr><td>MSI / TMB</td><td>${data['msi-status']||'â€”'} / ${data.tmb||'â€”'} mut/Mb</td></tr>
            <tr><td>MGMT / BRAF</td><td>${data.mgmt||'â€”'} / ${data.braf||'â€”'}</td></tr>
        </table>
    </div>
    <div style="background:var(--blue-dim);border:1px solid var(--blue);border-radius:8px;padding:10px 14px;font-size:11px;color:var(--blue);margin-top:12px;line-height:1.6">
        <strong>Nota epistemica:</strong> Questo output Ã¨ il risultato di <em>pattern matching su regole discrete</em> (WHO CNS5 2021). Non incorpora la variabilitÃ  morfologica del vetrino, la qualitÃ  pre-analitica del campione, nÃ© l'esperienza clinico-patologica contestuale. Ogni ipotesi classificativa richiede correlazione con morfologia EE, imaging e giudizio di un neuropatologo. <em>Il tool non diagnostica â€” il patologo sÃ¬.</em>
    </div>`;

    document.getElementById('report-container').innerHTML = html;
}


// ============================================================
// BIBLIOGRAPHY
// ============================================================
function renderBibliography() {
    const container = document.getElementById('biblio-container');
    let html = '';
    for (const [catId, cat] of Object.entries(bibliography)) {
        html += `<div class="biblio-category" id="cat-${catId}">
            <div class="biblio-category-header" onclick="toggleCategory('${catId}')">
                <div class="biblio-category-title">${cat.icon} ${cat.title} <span style="font-family:var(--font-mono); font-size:9px; color:var(--text-dim); margin-left:8px;">${cat.references.length} refs</span></div>
                <span class="biblio-category-toggle">â–¼</span>
            </div>
            <div class="biblio-category-content">`;
        for (const ref of cat.references) {
            html += `<div class="biblio-reference" id="ref-${ref.id}">
                <div class="biblio-reference-authors">${ref.authors} <span style="font-family:var(--font-mono); font-size:10px; color:var(--text-dim); margin-left:8px;">${ref.year}</span></div>
                <div class="biblio-reference-title">${ref.title}</div>
                <div class="biblio-reference-journal">${ref.journal}</div>
                <div class="biblio-reference-abstract"><strong>Takeaway:</strong> ${ref.abstract}</div>
                <div class="biblio-reference-actions">
                    <a href="https://doi.org/${ref.doi}" target="_blank" class="biblio-doi-link">DOI â†’</a>
                    ${ref.pmid ? `<a href="https://pubmed.ncbi.nlm.nih.gov/${ref.pmid}/" target="_blank" class="biblio-pmid-link">PMID ${ref.pmid}</a>` : ''}
                    <button class="abstract-toggle" onclick="toggleAbstract(event, '${ref.id}')">Mostra abstract</button>
                </div>
                <div class="biblio-tags">${ref.tags.map(t => `<span class="biblio-tag">${t}</span>`).join('')}</div>
            </div>`;
        }
        html += `</div></div>`;
    }
    container.innerHTML = html;
}

function toggleCategory(catId) { document.getElementById('cat-' + catId).classList.toggle('expanded'); }

function toggleAbstract(e, refId) {
    if (e) e.stopPropagation();
    const ref = document.getElementById('ref-' + refId);
    const btn = ref.querySelector('.abstract-toggle');
    const showing = ref.classList.toggle('show-abstract');
    btn.textContent = showing ? 'Nascondi abstract' : 'Mostra abstract';
}

function highlightRelevantReferences(diagnosis, data) {
    resetBiblioHighlights();
    let relevantTags = new Set(['WHO', 'GRADING']);
    const idhNgs = data['idh-ngs'] || '';
    const idhMut = idhNgs.includes('mut') && idhNgs !== 'wildtype';
    const idhIhcPos = data['idh-ihc'] === 'positive';
    if (idhMut || idhIhcPos) relevantTags.add('IDH');
    const ent = (diagnosis.entity || '').toLowerCase();
    if (ent.includes('astrocytoma')) { relevantTags.add('ASTROCYTOMA'); relevantTags.add('ATRX'); }
    if (ent.includes('oligodendroglioma')) { relevantTags.add('OLIGODENDROGLIOMA'); relevantTags.add('1P/19Q'); }
    if (ent.includes('glioblastoma')) { relevantTags.add('GLIOBLASTOMA'); relevantTags.add('EGFR'); relevantTags.add('TERT'); }
    if (ent.includes('diffuse midline glioma') || ent.includes('h3 k27')) { relevantTags.add('DMG'); relevantTags.add('H3K27M'); }
    if (ent.includes('h3 g34') || ent.includes('hemispheric glioma')) { relevantTags.add('H3G34'); relevantTags.add('GRADING'); relevantTags.add('PEDIATRIC'); }
    if (data['tp53-ngs'] === 'mutato' || data.p53 > 10) relevantTags.add('TP53');
    if (data.cdkn2a === 'homozygous-del') relevantTags.add('CDKN2A');
    if (data['1p19q'] === 'codeleted') relevantTags.add('1P/19Q');
    if (data.tert === 'mutato') relevantTags.add('TERT');
    if (data['egfr-cnv'] === 'amplified') relevantTags.add('EGFR');
    if (data.pten === 'loss') relevantTags.add('PTEN');
    if (data.nf1 === 'mutato') relevantTags.add('NF1');
    if (isPosFusion(data['ntrk-fusion'])) { relevantTags.add('NTRK'); relevantTags.add('ACTIONABLE'); relevantTags.add('LAROTRECTINIB'); }
    if (data['ret-fusion'] === 'positive') { relevantTags.add('RET'); relevantTags.add('ACTIONABLE'); }
    if (data['ros1-fusion'] === 'positive') { relevantTags.add('ROS1'); relevantTags.add('ACTIONABLE'); }
    if (isPosFusion(data['fgfr-fusion'])) { relevantTags.add('FGFR'); relevantTags.add('ACTIONABLE'); }
    if (data['msi-status'] === 'msi-h' || data.pole === 'mutato' || data.tmb >= 10) { relevantTags.add('MSI'); relevantTags.add('IMMUNOTHERAPY'); }
    if (data.mgmt !== '' && data.mgmt !== 'not-done') relevantTags.add('MGMT');

    let count = 0;
    for (const [catId, cat] of Object.entries(bibliography)) {
        let catRelevant = false;
        for (const ref of cat.references) {
            const match = ref.tags.some(t => relevantTags.has(t));
            if (match) {
                const el = document.getElementById('ref-' + ref.id);
                el.classList.add('relevant');
                const actions = el.querySelector('.biblio-reference-actions');
                const badge = document.createElement('span');
                badge.className = 'biblio-relevance-badge';
                badge.textContent = 'âœ“ rilevante';
                actions.insertBefore(badge, actions.firstChild);
                count++;
                catRelevant = true;
            }
        }
        if (catRelevant) {
            document.getElementById('cat-' + catId).classList.add('has-relevant');
            document.getElementById('cat-' + catId).classList.add('expanded');
        }
    }

    const badge = document.getElementById('relevance-badge');
    if (count > 0) { badge.textContent = count + ' riferimenti pertinenti'; badge.style.display = 'inline-block'; }
    else badge.style.display = 'none';
}

function resetBiblioHighlights() {
    document.querySelectorAll('.biblio-reference.relevant').forEach(el => {
        el.classList.remove('relevant');
        const b = el.querySelector('.biblio-relevance-badge');
        if (b) b.remove();
    });
    document.querySelectorAll('.biblio-category.has-relevant').forEach(el => el.classList.remove('has-relevant'));
    document.querySelectorAll('.biblio-category.expanded').forEach(el => el.classList.remove('expanded'));
    document.getElementById('relevance-badge').style.display = 'none';
}

function exportPDF() {
    const rc = document.getElementById('report-container');
    if (!rc || !rc.innerHTML.trim()) { alert('Genera prima una diagnosi'); return; }
    const opt = { margin: 10, filename: 'Report_Glioma_v3_' + new Date().toISOString().split('T')[0] + '.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' } };
    const pdfContent = document.createElement('div');
    pdfContent.style.cssText = 'font-family: sans-serif; color:#111; background:white; padding:20px;';
    pdfContent.innerHTML = `
        <style>
            body{font-family:Arial,sans-serif;color:#111;font-size:12px}
            h2,h3{color:#1a2030}
            .alert{border-left:3px solid #999;padding:8px 10px;margin:6px 0;border-radius:4px;font-size:11px}
            .alert-critical{border-color:#c02828;background:#fdeaea}
            .alert-warning{border-color:#c07010;background:#fff8e8}
            .alert-success{border-color:#1a9954;background:#edfaf4}
            .alert-info{border-color:#1a5cc8;background:#eef4ff}
            .diagnosis-box{border:1px solid #ddd;padding:12px;border-radius:8px;margin:10px 0}
            .diagnosis-entity{font-size:18px;font-weight:700;color:#1a2030;margin-bottom:4px}
            .diagnosis-grade{font-size:13px;color:#c07010;font-family:monospace}
            .actionable-banner{border:1px solid #c0aaee;background:#f4eeff;padding:10px;border-radius:8px;margin:8px 0}
            .scoring-container{border:1px solid #ddd;padding:12px;border-radius:8px;margin:10px 0}
            .scoring-bar-bg{background:#eee;height:6px;border-radius:3px;margin:4px 0 10px}
            .scoring-bar-fill{height:6px;border-radius:3px}
            .scoring-label{display:flex;justify-content:space-between;font-size:11px}
            .summary-table{width:100%;border-collapse:collapse;font-size:11px}
            .summary-table td{padding:5px 8px;border-bottom:1px solid #eee}
            .summary-table td:first-child{font-weight:600;color:#5a6478;width:40%}
            hr{border:none;border-top:1px solid #ddd;margin:12px 0}
        </style>
        <h2 style="text-align:center;margin-bottom:4px">REPORT DIAGNOSTICO GLIOMI SNC â€” v3.10.1</h2>
        <p style="text-align:center;font-size:11px;color:#666">Data: ${new Date().toLocaleDateString('it-IT')} | WHO CNS5 2021 | Pannello Diatech Extended</p>
        <p style="text-align:center;font-size:10px;color:#c02828;font-style:italic">SOLO USO DIDATTICO â€” Non sostituisce la diagnosi anatomo-patologica</p>
        <hr>
        ${rc.innerHTML}
    `;
    html2pdf().set(opt).from(pdfContent).save();
}

// ============================================================
// FIX 1 â€” MODAL CONSENSO
// ============================================================
function checkConsent() {
    const all = ['chk1','chk2','chk3'].every(id => document.getElementById(id).checked);
    const btn = document.getElementById('consent-btn');
    btn.classList.toggle('active', all);
}
function acceptConsent() {
    document.getElementById('consent-modal').style.display = 'none';
    sessionStorage.setItem('cnc-consent', '1');
}
document.addEventListener('DOMContentLoaded', () => {
    if (sessionStorage.getItem('cnc-consent') === '1') {
        document.getElementById('consent-modal').style.display = 'none';
    }
});

// ============================================================
// FIX 2 â€” CONFIDENCE CEILING (dati minimi obbligatori)
// ============================================================
function checkGliomaCeiling() {
    const d = getData();
    const missing = [];
    if (!d['idh-ngs'] && d['idh-ihc'] === '') missing.push('IDH (NGS o IHC)');
    if (!d.atrx || d.atrx === '') missing.push('ATRX (IHC)');
    if (d.cellularity === '') missing.push('CellularitÃ ');
    const gate = document.getElementById('glioma-gate');
    if (missing.length > 0) {
        gate.textContent = `âš  Dati insufficienti per procedere â€” campi obbligatori mancanti: ${missing.join(', ')}. Inserire o selezionare N.E. se non eseguito.`;
        gate.classList.add('visible');
        return false;
    }
    gate.classList.remove('visible');
    return true;
}

function checkMeningiomaCeiling() {
    const g = i => document.getElementById(i);
    const missing = [];
    if (!parseInt(g('men-mitosis').value) && g('men-mitosis').value === '') missing.push('Mitosi/10HPF');
    if (!g('men-subtype').value) missing.push('Sottotipo (o "Non specificato")');
    const gate = document.getElementById('menin-gate');
    if (missing.length > 0) {
        gate.textContent = `âš  Dati insufficienti: ${missing.join(', ')} obbligatori.`;
        gate.classList.add('visible');
        return false;
    }
    gate.classList.remove('visible');
    return true;
}

// ============================================================
// FIX 2 â€” GUARDED GENERATE (warning pre-report)
// ============================================================
function guardedGenerate() {
    if (!checkGliomaCeiling()) return;
    const confirmed = confirm(
        'ATTENZIONE\n\n' +
        'Stai per generare un\'ipotesi classificativa basata sui dati inseriti.\n\n' +
        'Questo output:\n' +
        'â€¢ NON Ã¨ una diagnosi anatomo-patologica\n' +
        'â€¢ NON sostituisce l\'osservazione morfologica al microscopio\n' +
        'â€¢ NON deve essere inserito in referti o cartelle cliniche\n\n' +
        'Continuare solo a scopo didattico/formativo?'
    );
    if (confirmed) generateDiagnosis();
}

function guardedGenerateMen() {
    if (!checkMeningiomaCeiling()) return;
    const confirmed = confirm(
        'ATTENZIONE\n\n' +
        'Stai per generare un\'ipotesi classificativa per meningioma.\n\n' +
        'Questo output:\n' +
        'â€¢ NON Ã¨ una diagnosi anatomo-patologica\n' +
        'â€¢ NON sostituisce l\'osservazione morfologica al microscopio\n' +
        'â€¢ NON deve essere inserito in referti o cartelle cliniche\n\n' +
        'Continuare solo a scopo didattico/formativo?'
    );
    if (confirmed) computeMeningioma();
}

// ============================================================
// FIX 3 â€” nota epistemica nell'output (aggiunta al report)
// Applicata direttamente nel displayDiagnosis e computeMeningioma

// Init
document.addEventListener('DOMContentLoaded', renderBibliography);

// ============================================================
// TUMOR SELECTOR
// ============================================================
function switchTumor(type) {
    const glioma = document.getElementById('glioma-section');
    const menin  = document.getElementById('meningioma-section');
    const btnG   = document.getElementById('btn-glioma');
    const btnM   = document.getElementById('btn-meningioma');
    if (type === 'glioma') {
        glioma.style.display = 'block'; menin.style.display = 'none';
        btnG.className = 'tumor-btn active-glioma'; btnM.className = 'tumor-btn';
    } else {
        glioma.style.display = 'none'; menin.style.display = 'block';
        btnG.className = 'tumor-btn'; btnM.className = 'tumor-btn active-meningioma';
    }
}

// ============================================================
// MENINGIOMA â€” SUBTYPE HINT + MINOR CRITERIA COUNTER
// ============================================================
const subtypeHints = {
    rhabdoide:'â˜… WHO CNS5: Grade 3 per definizione', papillare:'â˜… WHO CNS5: Grade 3 per definizione',
    cordoide:'â˜… WHO CNS5: Grade 2 per definizione', 'clear-cell':'â˜… WHO CNS5: Grade 2 per definizione',
    secretorio:'Frequente IHC: CEA/EMA+; CK+', meningoteliomatoso:'PiÃ¹ comune; whorls e corpi psammomatosi',
    fibroso:'NF2 mut frequente; collagene abbondante', psammomatoso:'Ricco in psammomi; tipico spinale',
    angiomatoso:'Ricco in vasi; DDx angioma SNC'
};
function updateMenSubtypeHint() {
    const v = document.getElementById('men-subtype').value;
    document.getElementById('men-subtype-hint').textContent = subtypeHints[v] || '';
}
function updateMinorCount() {
    const count = ['men-hypercell','men-small-cells','men-nucleoli','men-sheet']
        .filter(id => document.getElementById(id)?.checked).length;
    const el = document.getElementById('men-minor-count');
    if (!el) return;
    el.textContent = `Criteri minori: ${count}/4`;
    el.style.background = count >= 3 ? 'var(--red-dim)' : count >= 2 ? 'var(--amber-dim)' : 'var(--surface2)';
    el.style.borderColor = count >= 3 ? 'var(--red)' : count >= 2 ? 'var(--amber)' : 'var(--border)';
    el.style.color       = count >= 3 ? 'var(--red)' : count >= 2 ? 'var(--amber)' : 'var(--text-dim)';
}
document.addEventListener('DOMContentLoaded', () => {
    ['men-hypercell','men-small-cells','men-nucleoli','men-sheet'].forEach(id => {
        document.getElementById(id)?.addEventListener('change', updateMinorCount);
    });
});

// ============================================================
// MENINGIOMA â€” MOLECOLARE TOGGLE
// ============================================================
function toggleMolecolare() {
    const fields = document.getElementById('men-mol-fields');
    const btn = document.getElementById('mol-toggle-btn');
    const visible = fields.classList.toggle('visible');
    btn.textContent = visible ? 'â–¼ Nascondi molecolare' : 'â–¶ Espandi molecolare (opzionale)';
}

// ============================================================
// MENINGIOMA â€” PRELOADED CASES
// ============================================================
const meningiomaCases = {
    men1:{ age:62, sex:'F', location:'convessita', nf2Clinical:'no', recurrence:'',
           subtype:'meningoteliomatoso', mitosis:1, brainInvasion:'assente', necrosis:'assente',
           hypercell:false, smallCells:false, nucleoli:false, sheet:false, frankMalig:'',
           ki67:2, ema:'positive', pr:'positive', p53:'wild', sstr2a:'positive', h3k27me3:'retained',
           tert:'wildtype', cdkn2a:'wildtype', nf2:'mutato', bap1:'retained', chr22q:'loss' },
    men2:{ age:55, sex:'M', location:'falx', nf2Clinical:'no', recurrence:'I',
           subtype:'transizionale', mitosis:6, brainInvasion:'present', necrosis:'assente',
           hypercell:true, smallCells:true, nucleoli:false, sheet:false, frankMalig:'',
           ki67:10, ema:'positive', pr:'negative', p53:'overexp', sstr2a:'positive', h3k27me3:'lost',
           tert:'wildtype', cdkn2a:'heterozygous', nf2:'mutato', bap1:'retained', chr22q:'loss' },
    men3:{ age:68, sex:'M', location:'convessita', nf2Clinical:'no', recurrence:'II',
           subtype:'fibroso', mitosis:24, brainInvasion:'present', necrosis:'presente',
           hypercell:true, smallCells:true, nucleoli:true, sheet:true, frankMalig:'sarcoma-like',
           ki67:35, ema:'partial', pr:'negative', p53:'overexp', sstr2a:'negative', h3k27me3:'lost',
           tert:'wildtype', cdkn2a:'homozygous-del', nf2:'mutato', bap1:'lost', chr22q:'loss' },
    men4:{ age:50, sex:'F', location:'base-cranica', nf2Clinical:'no', recurrence:'',
           subtype:'rhabdoide', mitosis:8, brainInvasion:'assente', necrosis:'presente',
           hypercell:true, smallCells:false, nucleoli:true, sheet:false, frankMalig:'',
           ki67:18, ema:'partial', pr:'negative', p53:'overexp', sstr2a:'weak', h3k27me3:'lost',
           tert:'wildtype', cdkn2a:'wildtype', nf2:'wildtype', bap1:'lost', chr22q:'intact' },
    men5:{ age:48, sex:'M', location:'falx', nf2Clinical:'no', recurrence:'',
           subtype:'transizionale', mitosis:3, brainInvasion:'assente', necrosis:'assente',
           hypercell:false, smallCells:false, nucleoli:true, sheet:false, frankMalig:'',
           ki67:6, ema:'positive', pr:'positive', p53:'wild', sstr2a:'positive', h3k27me3:'retained',
           tert:'mutato', cdkn2a:'homozygous-del', nf2:'mutato', bap1:'retained', chr22q:'loss' }
};

function loadMenCase() {
    const id = document.getElementById('men-case-select').value;
    if (!id) return;
    const c = meningiomaCases[id];
    if (!c) return;
    const g = i => document.getElementById(i);
    g('men-age').value=c.age; g('men-sex').value=c.sex; g('men-location').value=c.location;
    g('men-nf2-clinical').value=c.nf2Clinical; g('men-recurrence').value=c.recurrence;
    g('men-subtype').value=c.subtype; updateMenSubtypeHint();
    g('men-mitosis').value=c.mitosis; g('men-brain-invasion').value=c.brainInvasion;
    g('men-necrosis').value=c.necrosis;
    g('men-hypercell').checked=c.hypercell; g('men-small-cells').checked=c.smallCells;
    g('men-nucleoli').checked=c.nucleoli; g('men-sheet').checked=c.sheet;
    g('men-frank-malignancy').value=c.frankMalig;
    g('men-ki67').value=c.ki67; g('men-ema').value=c.ema; g('men-pr').value=c.pr;
    g('men-p53').value=c.p53; g('men-sstr2a').value=c.sstr2a; g('men-h3k27me3').value=c.h3k27me3;
    const mol = document.getElementById('men-mol-fields');
    if (!mol.classList.contains('visible')) toggleMolecolare();
    g('men-tert').value=c.tert; g('men-cdkn2a').value=c.cdkn2a;
    g('men-nf2').value=c.nf2; g('men-bap1').value=c.bap1; g('men-chr22q').value=c.chr22q;
    updateMinorCount();
    g('men-report-container').innerHTML = '';
}

function resetMenForm() {
    document.querySelectorAll('#meningioma-section input, #meningioma-section select').forEach(el => {
        if (el.id === 'men-case-select') return;
        if (el.type === 'checkbox') el.checked = false; else el.value = '';
    });
    document.getElementById('men-case-select').value = '';
    document.getElementById('men-report-container').innerHTML = '';
    updateMinorCount();
    document.getElementById('men-subtype-hint').textContent = '';
}

// ============================================================
// MENINGIOMA â€” DIAGNOSIS ENGINE
// ============================================================
function getMenData() {
    const g = i => document.getElementById(i);
    return {
        age:parseInt(g('men-age').value)||0, sex:g('men-sex').value,
        location:g('men-location').value, nf2Clinical:g('men-nf2-clinical').value,
        recurrence:g('men-recurrence').value, subtype:g('men-subtype').value,
        mitosis:parseInt(g('men-mitosis').value)||0,
        brainInvasion:g('men-brain-invasion').value, necrosis:g('men-necrosis').value,
        hypercell:g('men-hypercell').checked, smallCells:g('men-small-cells').checked,
        nucleoli:g('men-nucleoli').checked, sheet:g('men-sheet').checked,
        frankMalig:g('men-frank-malignancy').value,
        ki67:parseInt(g('men-ki67').value)||0, ema:g('men-ema').value,
        pr:g('men-pr').value, p53:g('men-p53').value,
        sstr2a:g('men-sstr2a').value, h3k27me3:g('men-h3k27me3').value,
        tert:g('men-tert').value, cdkn2a:g('men-cdkn2a').value,
        nf2:g('men-nf2').value, bap1:g('men-bap1').value, chr22q:g('men-chr22q').value
    };
}

function computeMeningiomaDiagnosis(d) {
    const alerts = [];
    let grade = null;
    let gradeReason = [];
    let recidiveRisk = null;

    // STEP 1 â€” Sottotipo con grading implicito (WHO CNS5)
    const gr3Sub = ['rhabdoide','papillare'];
    const gr2Sub = ['cordoide','clear-cell'];
    if (gr3Sub.includes(d.subtype)) {
        grade = 'WHO Grade 3';
        gradeReason.push(`Sottotipo ${d.subtype} â†’ Gr.3 per definizione WHO CNS5`);
        alerts.push({ type:'critical', msg:`ðŸš¨ Sottotipo ${d.subtype}: WHO Grade 3 per definizione (WHO CNS5 2021) â€” indipendentemente dal numero di mitosi.` });
        if (d.subtype==='rhabdoide') alerts.push({ type:'warning', msg:'âš ï¸ Rhabdoide: verificare BAP1 (loss/mut frequente). H3K27me3 loss comune. Prognosi sfavorevole.' });
        if (d.subtype==='papillare') alerts.push({ type:'info', msg:'â„¹ï¸ Papillare: architettura pseudo-papillare perivascolare. Recidiva frequente.' });
    } else if (gr2Sub.includes(d.subtype)) {
        grade = 'WHO Grade 2';
        gradeReason.push(`Sottotipo ${d.subtype} â†’ Gr.2 per definizione WHO CNS5`);
        alerts.push({ type:'warning', msg:`âš ï¸ Sottotipo ${d.subtype}: WHO Grade 2 per definizione (WHO CNS5 2021).` });
        if (d.subtype==='clear-cell') alerts.push({ type:'info', msg:'â„¹ï¸ Clear cell: freq. in fossa posteriore e spinale; associato a mut SMARCE1.' });
        if (d.subtype==='cordoide') alerts.push({ type:'info', msg:'â„¹ï¸ Cordoide: simil-cordoma con mucina. IHC: S100+, EMA+.' });
    }

    // STEP 2 â€” Upgrade molecolare
    if (d.cdkn2a === 'homozygous-del') {
        const prev = grade;
        grade = 'WHO Grade 3';
        gradeReason.push('CDKN2A/B hom-del â†’ Gr.3 molecolare');
        const note = prev === 'WHO Grade 3' ? 'conferma molecolare Grade 3' : 'upgrading molecolare a Grade 3';
        alerts.push({ type:'critical', msg:`ðŸš¨ CDKN2A/B homozygous deletion: ${note} (WHO CNS5 2021).` });
    } else if (d.cdkn2a === 'heterozygous') {
        alerts.push({ type:'warning', msg:'âš ï¸ CDKN2A/B delezione eterozigote: non criterio Gr.3, ma associata a prognosi sfavorevole. Monitoraggio stretto.' });
    }
    if (d.tert === 'mutato') {
        if (!grade || grade === 'WHO Grade 1') {
            grade = 'WHO Grade 2';
            gradeReason.push('TERT mut â†’ upgrading Gr.2 molecolare');
            alerts.push({ type:'critical', msg:'ðŸš¨ TERT promoter mutato: upgrading a WHO Grade 2 per criterio molecolare (WHO CNS5 2021) â€” anche in assenza di criteri morfologici sufficienti.' });
        } else {
            alerts.push({ type:'warning', msg:`âš ï¸ TERT promoter mutato: fattore prognostico sfavorevole (grading giÃ  ${grade}).` });
        }
    }

    // STEP 3 â€” Grading morfologico
    const minorCount = [d.hypercell, d.smallCells, d.nucleoli, d.sheet].filter(Boolean).length;
    if (grade !== 'WHO Grade 3') {
        if (d.mitosis >= 20) {
            grade = 'WHO Grade 3'; gradeReason.push(`Mitosi â‰¥20 (${d.mitosis}/10HPF)`);
            alerts.push({ type:'critical', msg:`ðŸš¨ Mitosi ${d.mitosis}/10HPF (â‰¥20): criterio morfologico WHO Grade 3.` });
        } else if (d.frankMalig && d.frankMalig !== 'assente' && d.frankMalig !== '') {
            grade = 'WHO Grade 3'; gradeReason.push(`Morfologia maligna franca (${d.frankMalig})`);
            alerts.push({ type:'critical', msg:`ðŸš¨ Morfologia maligna franca (${d.frankMalig}): criterio WHO Grade 3.` });
        }
    }
    if (grade !== 'WHO Grade 3') {
        const gr2crit = [];
        if (d.mitosis >= 4) gr2crit.push(`Mitosi â‰¥4 (${d.mitosis}/10HPF)`);
        if (d.brainInvasion === 'present') gr2crit.push('Invasione cerebrale confermata');
        if (minorCount >= 3) gr2crit.push(`Criteri minori â‰¥3 (${minorCount}/4)`);
        if (gr2crit.length) {
            grade = 'WHO Grade 2'; gradeReason = gradeReason.concat(gr2crit);
            alerts.push({ type:'warning', msg:`âš ï¸ Criterio/i WHO Grade 2: ${gr2crit.join(' | ')}` });
        }
    }
    if (d.brainInvasion === 'sospetta') {
        alerts.push({ type:'warning', msg:'âš ï¸ Invasione cerebrale sospetta ma non confermata: campionamento aggiuntivo raccomandato. Se confermata â†’ Grade 2 isolato (WHO CNS5).' });
    }
    if (!grade) {
        grade = 'WHO Grade 1';
        gradeReason.push('Nessun criterio di upgrading identificato');
    }

    // STEP 4 â€” IHC alerts
    if (d.ki67 > 0) {
        const ctx = d.ki67 < 4 ? 'compatibile Gr.1' : d.ki67 <= 20 ? 'range Gr.2' : 'elevato â€” range Gr.3';
        alerts.push({ type: d.ki67 > 20 ? 'warning' : 'info', msg:`â„¹ï¸ Ki67: ${d.ki67}% (${ctx}) â€” orientativo, non criterio WHO per grading.` });
    }
    if (d.pr === 'negative' && grade === 'WHO Grade 1') {
        alerts.push({ type:'warning', msg:'âš ï¸ PR negativo in morfologia Gr.1: atipico â€” riconsiderare campionamento o criteri minori.' });
    }
    if (d.sstr2a === 'negative') {
        alerts.push({ type:'info', msg:'â„¹ï¸ SSTR2A negativo: esclude eligibilitÃ  PRRT standard. Frequente in Gr.3 e meningiomi NF2-wt (base cranica).' });
    } else if (d.sstr2a === 'positive') {
        alerts.push({ type:'success', msg:'âœ“ SSTR2A positivo: eligibile per dotatate PET-CT e potenzialmente PRRT in setting di recidiva/non resecabile.' });
    }
    if (d.h3k27me3 === 'lost') {
        alerts.push({ type:'warning', msg:'âš ï¸ H3K27me3 loss: nei meningiomi associata a Gr.2/3 e prognosi sfavorevole â€” non implica mutazione H3 (diverso dal contesto gliomi).' });
    }
    if (d.p53 === 'overexp' || d.p53 === 'null') {
        alerts.push({ type:'info', msg:`â„¹ï¸ p53 ${d.p53 === 'null' ? 'pattern null' : 'overespresso'}: marker instabilitÃ  genomica â€” correlato a grading elevato e recidiva.` });
    }

    // STEP 5 â€” Molecolare alerts
    if (d.bap1 === 'lost' || d.bap1 === 'mutato') {
        alerts.push({ type:'warning', msg:`âš ï¸ BAP1 ${d.bap1}: rischio elevato recidiva. Frequente in morfologia rhabdoide/aggressiva. Sorveglianza imaging ravvicinata.` });
        recidiveRisk = 'ALTO';
    }
    if (d.nf2 === 'mutato') {
        alerts.push({ type:'info', msg:'â„¹ï¸ NF2 mutato: freq. in fibrosi/transizionali; correlato a chr22q loss. In giovane â†’ escludere NF2 sindromico.' });
    }
    if (d.nf2Clinical === 'sospetto' || d.nf2Clinical === 'confermato') {
        alerts.push({ type:'warning', msg:`âš ï¸ NF2 sindromico (${d.nf2Clinical}): counseling genetico. Meningiomi multipli attesi. Screening familiare.` });
    }
    if (d.chr22q === 'loss' && d.nf2 === 'wildtype') {
        alerts.push({ type:'info', msg:'â„¹ï¸ Chr22q loss con NF2 wt: raro â€” considerare NF2 non rilevata (mosaicismo) o altre alterazioni 22q.' });
    }

    // STEP 6 â€” Recidiva
    if (d.recurrence) {
        alerts.push({ type:'warning', msg:`âš ï¸ ${d.recurrence==='II'?'II+ recidiva':'I recidiva'}: rischio upgrading al momento della recidiva (~15â€“30% studi). Rivalutare criteri morfologici e molecolari.` });
        if (!recidiveRisk) recidiveRisk = d.recurrence === 'II' ? 'ALTO' : 'INTERMEDIO';
    }

    const subtypeLbl = d.subtype ? ` (${d.subtype.charAt(0).toUpperCase()+d.subtype.slice(1)})` : '';
    const entity = `Meningioma${subtypeLbl}, ${grade} (WHO CNS5 2021)`;
    return { grade, entity, gradeReason, recidiveRisk, alerts };
}

// ============================================================
// MENINGIOMA â€” DISPLAY
// ============================================================
function computeMeningioma() {
    const d = getMenData();
    const dx = computeMeningiomaDiagnosis(d);
    const rc = document.getElementById('men-report-container');
    const gradeColor = {'WHO Grade 1':'var(--green)','WHO Grade 2':'var(--amber)','WHO Grade 3':'var(--red)'}[dx.grade] || 'var(--text)';
    let html = '';

    for (const a of dx.alerts) {
        const cls = {warning:'alert-warning',success:'alert-success',info:'alert-info',critical:'alert-critical'}[a.type]||'alert-info';
        html += `<div class="alert ${cls}">${a.msg}</div>`;
    }

    html += `<div class="diagnosis-box">
        <h3>Ipotesi classificativa WHO CNS5 2021 â€” Meningioma</h3>
        <div class="diagnosis-entity">${dx.entity}</div>
        <div class="diagnosis-grade" style="color:${gradeColor}">${dx.grade}</div>`;
    if (dx.gradeReason.length) {
        html += `<div style="margin-top:10px;font-size:12px;color:var(--text-dim)"><strong>Criteri determinanti:</strong> ${dx.gradeReason.join(' Â· ')}</div>`;
    }
    if (dx.recidiveRisk) {
        const rc2 = dx.recidiveRisk==='ALTO'?'var(--red)':'var(--amber)';
        html += `<div style="margin-top:8px;font-size:12px"><span style="background:${rc2};color:#fff;border-radius:4px;padding:2px 8px;font-family:var(--font-mono);font-weight:700">Rischio recidiva: ${dx.recidiveRisk}</span></div>`;
    }
    html += '</div>';

    html += `<div class="diagnosis-box" style="margin-top:10px">
        <h3 style="margin-bottom:8px">Dati inseriti</h3>
        <table style="width:100%;border-collapse:collapse;font-size:11px">
        ${[
            ['EtÃ  / Sesso', `${d.age||'â€”'} / ${d.sex||'â€”'}`],
            ['Sede', d.location||'â€”'],
            ['Sottotipo', d.subtype||'Non specificato'],
            ['Mitosi/10HPF', d.mitosis],
            ['Invasione cerebrale', d.brainInvasion||'â€”'],
            ['Criteri minori', [d.hypercell?'Ipercell.':null,d.smallCells?'Piccole cellule':null,d.nucleoli?'Nucleoli':null,d.sheet?'Sheet-like':null].filter(Boolean).join(', ')||'Nessuno'],
            ['Ki67', d.ki67?d.ki67+'%':'â€”'],
            ['PR / SSTR2A', `${d.pr||'â€”'} / ${d.sstr2a||'â€”'}`],
            ['TERT / CDKN2A', `${d.tert||'â€”'} / ${d.cdkn2a||'â€”'}`],
            ['BAP1 / NF2', `${d.bap1||'â€”'} / ${d.nf2||'â€”'}`]
        ].map(([k,v],i,arr)=>`<tr><td style="padding:4px 8px;${i<arr.length-1?'border-bottom:1px solid var(--border);':''}color:var(--text-dim);width:40%">${k}</td><td style="padding:4px 8px;${i<arr.length-1?'border-bottom:1px solid var(--border);':''}">${v}</td></tr>`).join('')}
        </table>
    </div>
    <div style="font-size:10px;color:var(--text-dim);margin-top:8px;font-style:italic">âš  Solo uso didattico â€” WHO CNS5 2021 Â· Perry et al. 2016 Â· Louis et al. 2021</div>
    <div style="background:var(--blue-dim);border:1px solid var(--blue);border-radius:8px;padding:10px 14px;font-size:11px;color:var(--blue);margin-top:8px;line-height:1.6">
        <strong>Nota epistemica:</strong> Questo output Ã¨ il risultato di <em>pattern matching su regole discrete</em> (WHO CNS5 2021). Non incorpora la variabilitÃ  morfologica del vetrino, la qualitÃ  pre-analitica del campione, nÃ© l'esperienza contestuale. Ogni ipotesi classificativa richiede correlazione con morfologia EE, imaging e giudizio di un neuropatologo. <em>Il tool non diagnostica â€” il patologo sÃ¬.</em>
    </div>`;

    rc.innerHTML = html;
    rc.scrollIntoView({ behavior:'smooth', block:'nearest' });
}
</script>
</body>
</html>
