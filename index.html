<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Diagnostico Gliomi SNC - Workflow Patologo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .workflow-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            padding: 30px;
            background: #f8f9fa;
            min-height: 600px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        @media (max-width: 1200px) {
            .workflow-container { grid-template-columns: 1fr 1fr; }
        }
        
        @media (max-width: 768px) {
            .workflow-container { grid-template-columns: 1fr; }
        }
        
        .column {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .column.clinica { border-left: 4px solid #3498db; }
        .column.istologia { border-left: 4px solid #e74c3c; }
        .column.ihc { border-left: 4px solid #f39c12; }
        .column.molecolare { border-left: 4px solid #27ae60; }
        
        .column h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .col-icon {
            font-size: 20px;
        }
        
        .field-group {
            margin-bottom: 14px;
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            font-size: 12px;
            color: #555;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        select, input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            color: #333;
            font-family: inherit;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        
        input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }
        
        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
            text-transform: none;
        }
        
        .help-text {
            font-size: 11px;
            color: #999;
            margin-top: 3px;
            font-style: italic;
        }
        
        .diagnosis-section {
            padding: 30px;
            background: white;
        }
        
        .diagnosis-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .diagnosis-box {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .diagnosis-box h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .diagnosis-text {
            color: #333;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .evidence-list {
            background: white;
            border-left: 3px solid #667eea;
            padding: 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #555;
        }
        
        .evidence-list li {
            margin-bottom: 5px;
            list-style-position: inside;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            flex: 1;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-generate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-reset {
            background: #ecf0f1;
            color: #333;
        }
        
        .btn-reset:hover {
            background: #d5dbdb;
        }
        
        .case-loader {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .case-loader label {
            font-weight: 600;
            font-size: 12px;
            margin: 0;
        }
        
        .case-loader select {
            flex: 1;
            min-width: 200px;
        }
        
        .case-loader button {
            padding: 8px 16px;
            font-size: 12px;
            background: #667eea;
            color: white;
        }
        
        .report-output {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-size: 12px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
        }
        
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 12px;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ§  Tool Diagnostico Gliomi SNC</h1>
            <p>Workflow integrato: Clinica â†’ Istologia â†’ IHC â†’ Molecolare â†’ Diagnosi WHO CNS5</p>
        </div>
        
        <div class="case-loader">
            <label for="case-select">Carica caso precaricato:</label>
            <select id="case-select">
                <option value="">-- Seleziona caso --</option>
                <option value="case1">Caso 1: Astrocitoma IDH-mutato Gr.3</option>
                <option value="case2">Caso 2: Oligodendroglioma IDH-mut 1p/19q-codel</option>
                <option value="case3">Caso 3: Glioblastoma IDH-wildtype Gr.4</option>
                <option value="case4">Caso 4: Diffuse midline glioma H3K27-mut (ped)</option>
            </select>
            <button onclick="loadCase()">Carica</button>
        </div>
        
        <div class="workflow-container">
            <!-- COLONNA 1: CLINICA -->
            <div class="column clinica">
                <h3><span class="col-icon">ðŸ‘¤</span> CLINICA</h3>
                
                <div class="field-group">
                    <label for="age">EtÃ </label>
                    <input type="number" id="age" placeholder="es. 45" min="0" max="100">
                </div>
                
                <div class="field-group">
                    <label for="location">Sede tumorale</label>
                    <select id="location">
                        <option value="">-- Seleziona --</option>
                        <option value="emisfero">Emisfero cerebrale</option>
                        <option value="linea-mediana">Linea mediana/ponte</option>
                        <option value="midline">Midline (tectum, III ventricolo)</option>
                        <option value="cervelletto">Cervelletto/fossa posteriore</option>
                        <option value="spinale">Midollo spinale</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label>Presentazione clinica</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="clin-seizures" value="seizures">
                            <label for="clin-seizures">Crisi</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="clin-deficit" value="deficit">
                            <label for="clin-deficit">Deficit focale</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="clin-headache" value="headache">
                            <label for="clin-headache">Cefalea</label>
                        </div>
                    </div>
                </div>
                
                <div class="field-group">
                    <label for="imaging">Imaging (MRI pattern)</label>
                    <select id="imaging">
                        <option value="">-- Seleziona --</option>
                        <option value="enhancement">Enhancement omogeneo</option>
                        <option value="heterogeneous">Enhancement eterogeneo</option>
                        <option value="ring">Impronta ad anello + necrosi</option>
                        <option value="diffuse">Infiltrante diffuso</option>
                        <option value="midline-diffuse">Diffuso linea mediana</option>
                    </select>
                </div>
            </div>
            
            <!-- COLONNA 2: ISTOLOGIA -->
            <div class="column istologia">
                <h3><span class="col-icon">ðŸ”¬</span> ISTOLOGIA + EE</h3>
                
                <div class="field-group">
                    <label for="cellularity">CellularitÃ </label>
                    <select id="cellularity">
                        <option value="">-- Seleziona --</option>
                        <option value="low">Bassa</option>
                        <option value="moderate">Moderata</option>
                        <option value="high">Alta</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="mitosis">Mitosi per 10 HPF</label>
                    <input type="number" id="mitosis" placeholder="es. 5" min="0" max="100">
                    <span class="help-text">Gr.2: &lt;4 | Gr.3: 4-9 | Gr.4: â‰¥10</span>
                </div>
                
                <div class="field-group">
                    <label>Architettura/Pattern</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="hist-perivascular" value="perivascular">
                            <label for="hist-perivascular">Iperplasia perivascolare</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="hist-necrosis" value="necrosis">
                            <label for="hist-necrosis">Necrosi</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="hist-microvascular" value="microvascular">
                            <label for="hist-microvascular">Proliferazione microvascolare</label>
                        </div>
                    </div>
                </div>
                
                <div class="field-group">
                    <label for="celltype">Tipo cellulare prevalente</label>
                    <select id="celltype">
                        <option value="">-- Seleziona --</option>
                        <option value="astrocytic">Astrocitario</option>
                        <option value="oligodendroglial">Oligodendroglia</option>
                        <option value="mixed">Misto</option>
                        <option value="glioblastic">Glioblastoma (pleomorfo)</option>
                    </select>
                </div>
            </div>
            
            <!-- COLONNA 3: IHC -->
            <div class="column ihc">
                <h3><span class="col-icon">ðŸ”µ</span> IHC</h3>
                
                <div class="field-group">
                    <label for="gfap">GFAP (IHC)</label>
                    <select id="gfap">
                        <option value="">-- Seleziona --</option>
                        <option value="positive">Positivo</option>
                        <option value="negative">Negativo</option>
                        <option value="partial">Positivo focale/debole</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                    <span class="help-text">Marcatore di differenziazione gliale</span>
                </div>
                
                <div class="field-group">
                    <label for="s100">S100 (IHC)</label>
                    <select id="s100">
                        <option value="">-- Seleziona --</option>
                        <option value="positive">Positivo</option>
                        <option value="negative">Negativo</option>
                        <option value="partial">Positivo focale/debole</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                    <span class="help-text">Marcatore di origine gliale (puÃ² mancare in gliomi alti)</span>
                </div>
                
                <div class="field-group">
                    <label for="idh">IDH1 R132H (IHC)</label>
                    <select id="idh">
                        <option value="">-- Seleziona --</option>
                        <option value="positive">Positivo</option>
                        <option value="negative">Negativo</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                    <span class="help-text">Se negativo â†’ NGS per IDH rare</span>
                </div>
                
                <div class="field-group">
                    <label for="atrx">ATRX (IHC)</label>
                    <select id="atrx">
                        <option value="">-- Seleziona --</option>
                        <option value="retained">Conservato (wild-type)</option>
                        <option value="lost">Perso (mutato)</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="p53">p53 (IHC)</label>
                    <select id="p53">
                        <option value="">-- Seleziona --</option>
                        <option value="normal">Labeling normale (&lt;10%)</option>
                        <option value="increased">Labeling aumentato (&gt;10%)</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="olig2">OLIG2 (IHC)</label>
                    <select id="olig2">
                        <option value="">-- Seleziona --</option>
                        <option value="positive">Positivo</option>
                        <option value="negative">Negativo</option>
                        <option value="partial">Positivo focale/debole</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                    <span class="help-text">Positivo in oligodendroglioma e alcuni astrocitomi IDH-mut</span>
                </div>
                
                <div class="field-group">
                    <label for="ki67">Ki-67 (%)</label>
                    <input type="number" id="ki67" placeholder="es. 15" min="0" max="100">
                    <span class="help-text">Fattore prognostico, non diagnostico</span>
                </div>
            </div>
            
            <!-- COLONNA 4: MOLECOLARE -->
            <div class="column molecolare">
                <h3><span class="col-icon">ðŸ§¬</span> MOLECOLARE (NGS)</h3>
                <span style="font-size: 11px; color: #999; font-style: italic; display: block; margin-bottom: 15px;">Attuale: IDH1/2 | Gennaio 2026: +TERT, +TP53</span>
                
                <div class="field-group">
                    <label for="idh-ngs">IDH1/2 (NGS)</label>
                    <select id="idh-ngs">
                        <option value="">-- Seleziona --</option>
                        <option value="mut-r132h">Mutato: R132H</option>
                        <option value="mut-other">Mutato: altro</option>
                        <option value="wildtype">Wild-type</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="atrx">ATRX (NGS)</label>
                    <select id="atrx" disabled style="opacity: 0.6; cursor: not-allowed;">
                        <option value="not-available">NON DISPONIBILE</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="1p19q">1p/19q (NGS/FISH)</label>
                    <select id="1p19q" disabled style="opacity: 0.6; cursor: not-allowed;">
                        <option value="not-available">NON DISPONIBILE</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="tp53">TP53 (NGS)</label>
                    <select id="tp53" disabled style="opacity: 0.6; cursor: not-allowed;">
                        <option value="not-available">NON DISPONIBILE - Disponibile da gennaio 2026</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="tert">TERT promoter (NGS)</label>
                    <select id="tert" disabled style="opacity: 0.6; cursor: not-allowed;">
                        <option value="not-available">NON DISPONIBILE - Disponibile da gennaio 2026</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="egfr">EGFR (NGS)</label>
                    <select id="egfr" disabled style="opacity: 0.6; cursor: not-allowed;">
                        <option value="not-available">NON DISPONIBILE</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="chr7-10">Chr 7 gain / Chr 10 loss (NGS)</label>
                    <select id="chr7-10" disabled style="opacity: 0.6; cursor: not-allowed;">
                        <option value="not-available">NON DISPONIBILE</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div style="padding: 30px; background: #fafafa; border-bottom: 2px solid #e0e0e0;">
            <h3 style="margin-bottom: 15px; color: #333;">ðŸ”¬ MARCATORI PREDITTIVI (test opzionale)</h3>
            <div style="background: white; border: 2px solid #ddd; border-left: 4px solid #9b59b6; border-radius: 8px; padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label for="mgmt" style="font-weight: 600; font-size: 12px; color: #555; margin-bottom: 5px; display: block; text-transform: uppercase; letter-spacing: 0.5px;">MGMT Promoter Metilazione</label>
                    <select id="mgmt" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: white; color: #333; font-family: inherit; width: 100%; max-width: 300px;">
                        <option value="">-- Seleziona --</option>
                        <option value="not-done">Non eseguito</option>
                        <option value="methylated">Metilato (promoter metilato)</option>
                        <option value="unmethylated">Non metilato (promoter non metilato)</option>
                        <option value="undetermined">Non determinabile</option>
                    </select>
                    <span style="font-size: 11px; color: #999; margin-top: 5px; display: block; font-style: italic;">Predittivo di risposta a temozolomide. Non influenza la diagnosi WHO, ma la prognosi.</span>
                </div>
            </div>
        </div>
        
        <div class="diagnosis-section">
            <h2>ðŸ“‹ Diagnosi WHO CNS5 & Report</h2>
            
            <div class="button-group">
                <button class="btn-generate" onclick="generateDiagnosis()">Genera Diagnosi</button>
                <button class="btn-reset" onclick="resetForm()">Reset</button>
                <button style="background: #27ae60; color: white; padding: 12px 20px; font-size: 14px; font-weight: 600; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;" onclick="exportPDF()" title="Esporta il report come PDF">ðŸ“¥ Esporta PDF</button>
            </div>
            
            <div id="report-container"></div>
        </div>
        <div style="padding: 30px; background: #f0f4ff; border-top: 2px solid #667eea;">
            <h3 style="margin-bottom: 15px; color: #333;">ðŸ“š Riferimenti Bibliografici</h3>
            <div style="font-size: 12px; line-height: 1.8; color: #555;">
                <p><strong>Classificazione:</strong></p>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>Louis DN, et al. WHO Classification of Tumours of the Central Nervous System (5th edition). IARC, 2021.</li>
                </ul>
                
                <p><strong>NGS Panel e Workflow Diagnostico:</strong></p>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>Suzuki H, et al. Mutational landscape and clonal architecture in grade II and III gliomas. Nat Genet. 2015;47(5):458-468.</li>
                    <li>Cancer Genome Atlas Research Network. Comprehensive, Integrative Genomic Analysis of Diffuse Lower-Grade Gliomas. N Engl J Med. 2015;372(26):2481-2498.</li>
                </ul>
                
                <p><strong>MGMT Metilazione (Predittivo):</strong></p>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>Hegi ME, et al. MGMT gene silencing and benefit from temozolomide in glioblastoma. N Engl J Med. 2005;352(10):997-1003.</li>
                </ul>
                
                <p><strong>IDH e Gliomi:</strong></p>
                <ul style="margin-left: 20px;">
                    <li>Yan H, et al. IDH1 and IDH2 mutations in gliomas. N Engl J Med. 2009;360(8):765-773.</li>
                </ul>
            </div>
        </div>
        const cases = {
            case1: {
                age: 45,
                location: 'emisfero',
                imaging: 'heterogeneous',
                cellularity: 'high',
                mitosis: 6,
                celltype: 'astrocytic',
                gfap: 'positive',
                s100: 'positive',
                olig2: 'negative',
                idh: 'positive',
                atrx: 'lost',
                p53: 'increased',
                ki67: 20,
                'idh-ngs': 'mut-r132h',
                mgmt: 'not-done',
                clinicalData: {
                    seizures: true,
                    deficit: true
                },
                histData: {
                    perivascular: false,
                    necrosis: false,
                    microvascular: true
                }
            },
            case2: {
                age: 52,
                location: 'emisfero',
                imaging: 'enhancement',
                cellularity: 'moderate',
                mitosis: 3,
                celltype: 'oligodendroglial',
                gfap: 'partial',
                s100: 'positive',
                olig2: 'positive',
                idh: 'positive',
                atrx: 'retained',
                p53: 'normal',
                ki67: 8,
                'idh-ngs': 'mut-r132h',
                mgmt: 'not-done',
                clinicalData: {
                    seizures: true,
                    deficit: false
                },
                histData: {
                    perivascular: true,
                    necrosis: false,
                    microvascular: false
                }
            },
            case3: {
                age: 62,
                location: 'emisfero',
                imaging: 'ring',
                cellularity: 'high',
                mitosis: 15,
                celltype: 'glioblastic',
                gfap: 'partial',
                s100: 'negative',
                olig2: 'negative',
                idh: 'negative',
                atrx: 'retained',
                p53: 'increased',
                ki67: 45,
                'idh-ngs': 'wildtype',
                mgmt: 'methylated',
                clinicalData: {
                    seizures: false,
                    deficit: true,
                    headache: true
                },
                histData: {
                    perivascular: true,
                    necrosis: true,
                    microvascular: true
                }
            },
            case4: {
                age: 8,
                location: 'linea-mediana',
                imaging: 'midline-diffuse',
                cellularity: 'high',
                mitosis: 12,
                celltype: 'glioblastic',
                gfap: 'partial',
                s100: 'negative',
                olig2: 'negative',
                idh: 'negative',
                atrx: 'retained',
                p53: 'normal',
                ki67: 50,
                'idh-ngs': 'wildtype',
                mgmt: 'unmethylated',
                clinicalData: {
                    headache: true,
                    deficit: true
                },
                histData: {
                    perivascular: false,
                    necrosis: true,
                    microvascular: true
                }
            }
        };
        
        function loadCase() {
            const caseId = document.getElementById('case-select').value;
            if (!caseId || !cases[caseId]) return;
            
            const caseData = cases[caseId];
            
            document.getElementById('age').value = caseData.age;
            document.getElementById('location').value = caseData.location;
            document.getElementById('imaging').value = caseData.imaging;
            document.getElementById('cellularity').value = caseData.cellularity;
            document.getElementById('mitosis').value = caseData.mitosis;
            document.getElementById('celltype').value = caseData.celltype;
            document.getElementById('gfap').value = caseData.gfap;
            document.getElementById('s100').value = caseData.s100;
            document.getElementById('olig2').value = caseData.olig2;
            document.getElementById('idh').value = caseData.idh;
            document.getElementById('ki67').value = caseData.ki67;
            document.getElementById('idh-ngs').value = caseData['idh-ngs'];
            document.getElementById('1p19q').value = caseData['1p19q'];
            document.getElementById('tp53').value = caseData.tp53;
            document.getElementById('tert').value = caseData.tert;
            document.getElementById('egfr').value = caseData.egfr;
            document.getElementById('chr7-10').value = caseData['chr7-10'];
            
            if (caseData.mgmt) {
                document.getElementById('mgmt').value = caseData.mgmt;
            }
            
            if (caseData.clinicalData) {
                if (caseData.clinicalData.seizures) document.getElementById('clin-seizures').checked = true;
                if (caseData.clinicalData.deficit) document.getElementById('clin-deficit').checked = true;
                if (caseData.clinicalData.headache) document.getElementById('clin-headache').checked = true;
            }
            
            if (caseData.histData) {
                if (caseData.histData.perivascular) document.getElementById('hist-perivascular').checked = true;
                if (caseData.histData.necrosis) document.getElementById('hist-necrosis').checked = true;
                if (caseData.histData.microvascular) document.getElementById('hist-microvascular').checked = true;
            }
        }
        
        function resetForm() {
            document.querySelectorAll('input, select').forEach(el => {
                if (el.type === 'checkbox' || el.type === 'radio') {
                    el.checked = false;
                } else {
                    el.value = '';
                }
            });
            document.getElementById('report-container').innerHTML = '';
            document.getElementById('case-select').value = '';
        }
        
        function exportPDF() {
            const reportElement = document.getElementById('report-container');
            
            if (!reportElement || reportElement.innerHTML.trim() === '') {
                alert('Genera prima una diagnosi per esportare il PDF');
                return;
            }
            
            const opt = {
                margin: 10,
                filename: 'Report_Glioma_' + new Date().toISOString().split('T')[0] + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };
            
            // Crea contenuto PDF con header
            const pdfContent = document.createElement('div');
            pdfContent.style.fontSize = '12px';
            pdfContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2>REPORT DIAGNOSTICO GLIOMI SNC</h2>
                    <p>Data: ${new Date().toLocaleDateString('it-IT')}</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <h3>Dati Clinici e Strumentali</h3>
                    <p><strong>EtÃ :</strong> ${document.getElementById('age').value || 'N/A'}</p>
                    <p><strong>Sede:</strong> ${document.getElementById('location').value || 'N/A'}</p>
                    <p><strong>Imaging:</strong> ${document.getElementById('imaging').value || 'N/A'}</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <h3>Pannello IHC</h3>
                    <p>GFAP: ${document.getElementById('gfap').value} | S100: ${document.getElementById('s100').value} | OLIG2: ${document.getElementById('olig2').value}</p>
                    <p>IDH1 R132H: ${document.getElementById('idh').value} | ATRX: ${document.getElementById('atrx').value} | p53: ${document.getElementById('p53').value}</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <h3>NGS Panel</h3>
                    <p>IDH1/2: ${document.getElementById('idh-ngs').value}</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <h3>Istologia</h3>
                    <p>Mitosi/10 HPF: ${document.getElementById('mitosis').value} | Ki-67: ${document.getElementById('ki67').value}%</p>
                </div>
                <div style="margin-bottom: 20px;">
                    <h3>MGMT (Predittivo)</h3>
                    <p>${document.getElementById('mgmt').value || 'Non eseguito'}</p>
                </div>
                <hr>
                ${reportElement.innerHTML}
            `;
            
            html2pdf().set(opt).from(pdfContent).save();
        }
            const data = {
                age: parseInt(document.getElementById('age').value),
                location: document.getElementById('location').value,
                imaging: document.getElementById('imaging').value,
                cellularity: document.getElementById('cellularity').value,
                mitosis: parseInt(document.getElementById('mitosis').value) || 0,
                celltype: document.getElementById('celltype').value,
                gfap: document.getElementById('gfap').value,
                s100: document.getElementById('s100').value,
                olig2: document.getElementById('olig2').value,
                idh: document.getElementById('idh').value,
                atrx: document.getElementById('atrx').value,
                p53: document.getElementById('p53').value,
                ki67: parseInt(document.getElementById('ki67').value) || 0,
                'idh-ngs': document.getElementById('idh-ngs').value,
                '1p19q': document.getElementById('1p19q').value,
                tp53: document.getElementById('tp53').value,
                tert: document.getElementById('tert').value,
                egfr: document.getElementById('egfr').value,
                'chr7-10': document.getElementById('chr7-10').value
            };
            
            const diagnosis = computeDiagnosis(data);
            displayDiagnosis(diagnosis, data);
        }
        
        function computeDiagnosis(data) {
            let alerts = [];
            let diagnosis = {};
            
            // AVVERTIMENTO: solo IDH disponibile attualmente
            alerts.push({type: 'warning', msg: 'âš  NOTA: Pannello NGS attuale limita la classificazione. Da gennaio 2026 disponibili TERT e TP53 per profilo completo.'});
            
            // PEDIATRIC PATTERNS - senza H3K27me3 IHC
            if (data.age < 18) {
                if (data.location === 'linea-mediana' || data.location === 'midline') {
                    diagnosis.entity = 'Glioma diffuso linea mediana (richiedere methylation profiling per conferma H3-altered)';
                    diagnosis.grade = 'Grade 4 (probabile)';
                    diagnosis.confidence = 'Basso senza methylation profiling';
                    alerts.push({type: 'warning', msg: 'âš  Pediatrico linea mediana: consigliare methylation profiling per distinguere H3K27-altered vs altre alterazioni'});
                }
            }
            
            // ADULT IDH-MUTATED PATTERNS
            if (data['idh-ngs'] === 'mut-r132h' || data['idh-ngs'] === 'mut-other') {
                // Con IDH mutato, ma SENZA 1p/19q disponibile, non puoi distinguere astrocitoma da oligodendroglioma solo da NGS
                diagnosis.entity = 'Glioma diffuso, IDH-mutated (classificazione incompleta)';
                diagnosis.confidence = 'Basso - manca 1p/19q';
                
                // Grading da istologia
                if (data.mitosis < 4) {
                    diagnosis.grade = 'WHO Grade 2 (probabile)';
                } else if (data.mitosis <= 9) {
                    diagnosis.grade = 'WHO Grade 3 (probabile)';
                } else {
                    diagnosis.grade = 'WHO Grade 4';
                }
                
                // Supporto da IHC
                if (data.atrx === 'lost') {
                    diagnosis.entity = 'Astrocytoma, IDH-mutated (ATRX loss suggestivo)';
                    alerts.push({type: 'success', msg: 'âœ“ ATRX loss all\'IHC favorisce astrocitoma IDH-mutato. Confermare con 1p/19q da gennaio 2026.'});
                } else if (data.atrx === 'retained' && data.olig2 === 'positive') {
                    diagnosis.entity = 'Oligodendroglioma IDH-mutato (pattern favorevole, ma confermare 1p/19q)';
                    alerts.push({type: 'success', msg: 'âœ“ ATRX retained + OLIG2+ favorisce oligodendroglioma. Confermare con 1p/19q da gennaio 2026.'});
                }
            }
            
            // ADULT IDH-WILDTYPE PATTERNS
            if (data['idh-ngs'] === 'wildtype' && data.age >= 18) {
                diagnosis.entity = 'Glioma diffuso, IDH-wildtype';
                diagnosis.confidence = 'Basso senza EGFR/+7/-10';
                
                // Grading prevalentemente da istologia
                if (data.mitosis > 10) {
                    diagnosis.grade = 'WHO Grade 4 (Glioblastoma probabile)';
                    diagnosis.entity = 'Glioblastoma, IDH-wildtype (da morfologia)';
                    alerts.push({type: 'success', msg: 'âœ“ Mitosi elevate + IDH-wt: GBM probabile. Molecular profiling (EGFR, +7/-10) disponibili gennaio 2026.'});
                } else {
                    diagnosis.grade = 'Grade 2-3 (incerto senza marker molecolari)';
                    alerts.push({type: 'warning', msg: 'âš  IDH-wildtype a basso grado istologico: richiedere methylation profiling o ripetere staging.'});
                }
            }
            
            // VALIDATION CHECKS
            if (data['idh-ngs'] === '') {
                alerts.push({type: 'warning', msg: 'âš  IDH status mancante: fondamentale per classificazione'});
            }
            
            diagnosis.alerts = alerts;
            return diagnosis;
        }
        
        function checkHistFeatures(data, features) {
            for (let f of features) {
                const cb = document.getElementById('hist-' + f);
                if (cb && cb.checked) return true;
            }
            return false;
        }
        
        function displayDiagnosis(diagnosis, data) {
            let html = '';
            
            if (diagnosis.alerts.length > 0) {
                for (let alert of diagnosis.alerts) {
                    const cls = alert.type === 'warning' ? 'alert-warning' : 'alert-success';
                    html += '<div class="alert ' + cls + '">' + alert.msg + '</div>';
                }
            }
            
            if (diagnosis.entity) {
                html += '<div class="diagnosis-box">';
                html += '<h3>Diagnosi Finale WHO CNS5</h3>';
                html += '<div class="diagnosis-text"><strong>' + diagnosis.entity + '</strong></div>';
                html += '<div class="diagnosis-text">' + diagnosis.grade + '</div>';
                
                if (diagnosis.icdO) {
                    html += '<div class="diagnosis-text">ICD-O: ' + diagnosis.icdO + '</div>';
                }
                
                html += '<div class="diagnosis-text"><strong>Livello di confidenza:</strong> ' + diagnosis.confidence + '</div>';
                
                if (diagnosis.gbmEvidence) {
                    html += '<div class="diagnosis-text"><strong>Evidenze supportive:</strong></div>';
                    html += '<ul class="evidence-list">';
                    for (let ev of diagnosis.gbmEvidence) {
                        html += '<li>' + ev + '</li>';
                    }
                    html += '</ul>';
                }
                
                html += '</div>';
            } else {
                html += '<div class="alert alert-warning">Insufficient data for definitive diagnosis. Review clinical and molecular findings.</div>';
            }
            
            // Summary table
            html += '<div class="diagnosis-box" style="margin-top: 20px;">';
            html += '<h3>Riepilogo Findings</h3>';
            html += '<table style="width:100%; font-size: 12px; border-collapse: collapse;">';
            html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px; width: 50%;"><strong>EtÃ  / Sede</strong></td><td style="padding: 8px;">' + (data.age || 'N/A') + ' a. / ' + data.location + '</td></tr>';
            html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>GFAP / S100 / OLIG2</strong></td><td style="padding: 8px;">' + data.gfap + ' / ' + data.s100 + ' / ' + data.olig2 + '</td></tr>';
            html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>IDH (IHC + NGS)</strong></td><td style="padding: 8px;">' + data.idh + ' / ' + data['idh-ngs'] + '</td></tr>';
            html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>ATRX / 1p19q</strong></td><td style="padding: 8px;">' + data.atrx + ' / ' + data['1p19q'] + '</td></tr>';
            html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>TP53 / TERT</strong></td><td style="padding: 8px;">' + data.tp53 + ' / ' + data.tert + '</td></tr>';
            html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>Mitosi / Ki-67</strong></td><td style="padding: 8px;">' + data.mitosis + ' / ' + data.ki67 + '%</td></tr>';
            html += '<tr><td style="padding: 8px;"><strong>EGFR / +7/-10</strong></td><td style="padding: 8px;">' + data.egfr + ' / ' + data['chr7-10'] + '</td></tr>';
            html += '<tr style="border-top: 2px solid #ddd; font-weight: bold; background: #fff9e6;"><td style="padding: 8px;"><strong>MGMT (Predittivo)</strong></td><td style="padding: 8px;">' + (document.getElementById('mgmt').value || 'Non eseguito') + '</td></tr>';
            html += '</table>';
            html += '</div>';
            
            document.getElementById('report-container').innerHTML = html;
        }
    </script>
</body>
</html>
