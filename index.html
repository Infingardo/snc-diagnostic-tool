<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Diagnostico Gliomi SNC - Workflow Patologo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .header p {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .workflow-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            padding: 30px;
            background: #f8f9fa;
            min-height: 600px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        @media (max-width: 1200px) {
            .workflow-container { grid-template-columns: 1fr 1fr; }
        }
        
        @media (max-width: 768px) {
            .workflow-container { grid-template-columns: 1fr; }
        }
        
        .column {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .column.clinica { border-left: 4px solid #3498db; }
        .column.istologia { border-left: 4px solid #e74c3c; }
        .column.ihc { border-left: 4px solid #f39c12; }
        .column.molecolare { border-left: 4px solid #27ae60; }
        
        .column h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .col-icon { font-size: 20px; }
        
        .field-group {
            margin-bottom: 14px;
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            font-size: 12px;
            color: #555;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        select, input {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: white;
            color: #333;
            font-family: inherit;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .help-text {
            font-size: 11px;
            color: #999;
            margin-top: 3px;
            font-style: italic;
        }
        
        .diagnosis-section {
            padding: 30px;
            background: white;
        }
        
        .diagnosis-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .diagnosis-box {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .diagnosis-box h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .diagnosis-text {
            color: #333;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .evidence-list {
            background: white;
            border-left: 3px solid #667eea;
            padding: 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #555;
        }
        
        .evidence-list li {
            margin-bottom: 5px;
            list-style-position: inside;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-generate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
            min-width: 150px;
        }
        
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-reset {
            background: #ecf0f1;
            color: #333;
            flex: 1;
            min-width: 100px;
        }
        
        .btn-reset:hover {
            background: #d5dbdb;
        }
        
        .btn-export {
            background: #27ae60;
            color: white;
            flex: 1;
            min-width: 150px;
        }
        
        .btn-export:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
        }
        
        .case-loader {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .case-loader label {
            font-weight: 600;
            font-size: 12px;
            margin: 0;
        }
        
        .case-loader select {
            flex: 1;
            min-width: 200px;
        }
        
        .case-loader button {
            padding: 8px 16px;
            font-size: 12px;
            background: #667eea;
            color: white;
        }
        
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 12px;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }
        
        .alert-success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }
        
        .biblio-section {
            padding: 30px;
            background: #f0f4ff;
            border-top: 2px solid #667eea;
        }
        
        .biblio-section h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .biblio-section ul {
            margin-left: 20px;
            margin-bottom: 15px;
            font-size: 12px;
            line-height: 1.8;
            color: #555;
        }
        
        .biblio-section p {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 Tool Diagnostico Gliomi SNC</h1>
            <p>Workflow integrato: Clinica → Istologia → IHC → Molecolare → Diagnosi WHO CNS5</p>
        </div>
        
        <div class="case-loader">
            <label for="case-select">Carica caso precaricato:</label>
            <select id="case-select">
                <option value="">-- Seleziona caso --</option>
                <option value="case1">Caso 1: Astrocitoma IDH-mutato Gr.3</option>
                <option value="case2">Caso 2: Oligodendroglioma IDH-mut 1p/19q-codel</option>
                <option value="case3">Caso 3: Glioblastoma IDH-wildtype Gr.4</option>
                <option value="case4">Caso 4: Glioma linea mediana pediatrico</option>
            </select>
            <button onclick="loadCase()">Carica</button>
        </div>
        
        <div class="workflow-container">
            <!-- COLONNA 1: CLINICA -->
            <div class="column clinica">
                <h3><span class="col-icon">👤</span> CLINICA</h3>
                
                <div class="field-group">
                    <label for="age">Età</label>
                    <input type="number" id="age" placeholder="es. 45" min="0" max="100">
                </div>
                
                <div class="field-group">
                    <label for="location">Sede tumorale</label>
                    <select id="location">
                        <option value="">-- Seleziona --</option>
                        <option value="emisfero">Emisfero cerebrale</option>
                        <option value="linea-mediana">Linea mediana/ponte</option>
                        <option value="midline">Midline (tectum, III ventricolo)</option>
                        <option value="cervelletto">Cervelletto/fossa posteriore</option>
                        <option value="spinale">Midollo spinale</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="imaging">Imaging (MRI pattern)</label>
                    <select id="imaging">
                        <option value="">-- Seleziona --</option>
                        <option value="enhancement">Enhancement omogeneo</option>
                        <option value="heterogeneous">Enhancement eterogeneo</option>
                        <option value="ring">Impronta ad anello + necrosi</option>
                        <option value="diffuse">Infiltrante diffuso</option>
                        <option value="midline-diffuse">Diffuso linea mediana</option>
                    </select>
                </div>
            </div>
            
            <!-- COLONNA 2: ISTOLOGIA -->
            <div class="column istologia">
                <h3><span class="col-icon">🔬</span> ISTOLOGIA + EE</h3>
                
                <div class="field-group">
                    <label for="cellularity">Cellularità</label>
                    <select id="cellularity">
                        <option value="">-- Seleziona --</option>
                        <option value="low">Bassa</option>
                        <option value="moderate">Moderata</option>
                        <option value="high">Alta</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="mitosis">Mitosi per 10 HPF</label>
                    <input type="number" id="mitosis" placeholder="es. 5" min="0" max="100">
                    <span class="help-text">Gr.2: &lt;4 | Gr.3: 4-9 | Gr.4: ≥10</span>
                </div>
                
                <div class="field-group">
                    <label>Architettura/Pattern</label>
                    <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 6px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="hist-perivascular">
                            <label for="hist-perivascular" style="margin: 0; font-weight: normal; text-transform: none; font-size: 12px;">Iperplasia perivascolare</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="hist-necrosis">
                            <label for="hist-necrosis" style="margin: 0; font-weight: normal; text-transform: none; font-size: 12px;">Necrosi</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="hist-microvascular">
                            <label for="hist-microvascular" style="margin: 0; font-weight: normal; text-transform: none; font-size: 12px;">Proliferazione microvascolare</label>
                        </div>
                    </div>
                </div>
                    <select id="celltype">
                        <option value="">-- Seleziona --</option>
                        <option value="astrocytic">Astrocitario</option>
                        <option value="oligodendroglial">Oligodendroglia</option>
                        <option value="mixed">Misto</option>
                        <option value="glioblastic">Glioblastoma (pleomorfo)</option>
                    </select>
                </div>
            </div>
            
            <!-- COLONNA 3: IHC -->
            <div class="column ihc">
                <h3><span class="col-icon">🔵</span> IHC</h3>
                
                <div class="field-group">
                    <label for="gfap">GFAP (IHC)</label>
                    <select id="gfap">
                        <option value="">-- Seleziona --</option>
                        <option value="positive">Positivo</option>
                        <option value="negative">Negativo</option>
                        <option value="partial">Positivo focale/debole</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="s100">S100 (IHC)</label>
                    <select id="s100">
                        <option value="">-- Seleziona --</option>
                        <option value="positive">Positivo</option>
                        <option value="negative">Negativo</option>
                        <option value="partial">Positivo focale/debole</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="idh">IDH1 R132H (IHC)</label>
                    <select id="idh">
                        <option value="">-- Seleziona --</option>
                        <option value="positive">Positivo</option>
                        <option value="negative">Negativo</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="atrx">ATRX (IHC)</label>
                    <select id="atrx">
                        <option value="">-- Seleziona --</option>
                        <option value="retained">Conservato (wild-type)</option>
                        <option value="lost">Perso (mutato)</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="p53">p53 (IHC)</label>
                    <select id="p53">
                        <option value="">-- Seleziona --</option>
                        <option value="normal">Labeling normale (&lt;10%)</option>
                        <option value="increased">Labeling aumentato (&gt;10%)</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="olig2">OLIG2 (IHC)</label>
                    <select id="olig2">
                        <option value="">-- Seleziona --</option>
                        <option value="positive">Positivo</option>
                        <option value="negative">Negativo</option>
                        <option value="partial">Positivo focale/debole</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="ki67">Ki-67 (%)</label>
                    <input type="number" id="ki67" placeholder="es. 15" min="0" max="100">
                </div>
            </div>
            
            <!-- COLONNA 4: MOLECOLARE -->
            <div class="column molecolare">
                <h3><span class="col-icon">🧬</span> MOLECOLARE (NGS)</h3>
                <span style="font-size: 11px; color: #999; font-style: italic; display: block; margin-bottom: 15px;">Attuale: IDH1/2 | Gennaio 2026: +TERT, +TP53</span>
                
                <div class="field-group">
                    <label for="idh-ngs">IDH1/2 (NGS)</label>
                    <select id="idh-ngs">
                        <option value="">-- Seleziona --</option>
                        <option value="mut-r132h">Mutato: R132H</option>
                        <option value="mut-other">Mutato: altro</option>
                        <option value="wildtype">Wild-type</option>
                        <option value="not-done">Non eseguito</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="atrx-ngs">ATRX (NGS)</label>
                    <select id="atrx-ngs" disabled style="opacity: 0.6; cursor: not-allowed;">
                        <option value="not-available">NON DISPONIBILE</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="1p19q">1p/19q (NGS/FISH)</label>
                    <select id="1p19q" disabled style="opacity: 0.6; cursor: not-allowed;">
                        <option value="not-available">NON DISPONIBILE</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="tp53-ngs">TP53 (NGS)</label>
                    <select id="tp53-ngs" disabled style="opacity: 0.6; cursor: not-allowed;">
                        <option value="not-available">NON DISPONIBILE - Disponibile da gennaio 2026</option>
                    </select>
                </div>
                
                <div class="field-group">
                    <label for="tert">TERT promoter (NGS)</label>
                    <select id="tert" disabled style="opacity: 0.6; cursor: not-allowed;">
                        <option value="not-available">NON DISPONIBILE - Disponibile da gennaio 2026</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div style="padding: 30px; background: #fafafa; border-bottom: 2px solid #e0e0e0;">
            <h3 style="margin-bottom: 15px; color: #333;">🔬 MARCATORI PREDITTIVI (test opzionale)</h3>
            <div style="background: white; border: 2px solid #ddd; border-left: 4px solid #9b59b6; border-radius: 8px; padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label for="mgmt" style="font-weight: 600; font-size: 12px; color: #555; margin-bottom: 5px; display: block; text-transform: uppercase; letter-spacing: 0.5px;">MGMT Promoter Metilazione</label>
                    <select id="mgmt" style="padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; background: white; color: #333; font-family: inherit; width: 100%; max-width: 300px;">
                        <option value="">-- Seleziona --</option>
                        <option value="not-done">Non eseguito</option>
                        <option value="methylated">Metilato (promoter metilato)</option>
                        <option value="unmethylated">Non metilato (promoter non metilato)</option>
                        <option value="undetermined">Non determinabile</option>
                    </select>
                    <span style="font-size: 11px; color: #999; margin-top: 5px; display: block; font-style: italic;">Predittivo di risposta a temozolomide. Non influenza la diagnosi WHO, ma la prognosi.</span>
                </div>
            </div>
        </div>
        
        <div class="diagnosis-section">
            <h2>📋 Diagnosi WHO CNS5 & Report</h2>
            
            <div class="button-group">
                <button class="btn-generate" onclick="generateDiagnosis()">Genera Diagnosi</button>
                <button class="btn-reset" onclick="resetForm()">Reset</button>
                <button class="btn-export" onclick="exportPDF()">📥 Esporta PDF</button>
            </div>
            
            <div id="report-container"></div>
        </div>
        
        <div class="biblio-section">
            <h3>📚 Riferimenti Bibliografici</h3>
            <p>Classificazione:</p>
            <ul>
                <li>Louis DN, et al. WHO Classification of Tumours of the Central Nervous System (5th edition). IARC, 2021.</li>
            </ul>
            
            <p>NGS Panel e Workflow Diagnostico:</p>
            <ul>
                <li>Suzuki H, et al. Mutational landscape and clonal architecture in grade II and III gliomas. Nat Genet. 2015;47(5):458-468.</li>
                <li>Cancer Genome Atlas Research Network. Comprehensive, Integrative Genomic Analysis of Diffuse Lower-Grade Gliomas. N Engl J Med. 2015;372(26):2481-2498.</li>
            </ul>
            
            <p>MGMT Metilazione (Predittivo):</p>
            <ul>
                <li>Hegi ME, et al. MGMT gene silencing and benefit from temozolomide in glioblastoma. N Engl J Med. 2005;352(10):997-1003.</li>
            </ul>
            
            <p>IDH e Gliomi:</p>
            <ul>
                <li>Yan H, et al. IDH1 and IDH2 mutations in gliomas. N Engl J Med. 2009;360(8):765-773.</li>
            </ul>
        </div>
    </div>
    
    <script>
        const cases = {
            case1: {
                age: 45,
                location: 'emisfero',
                imaging: 'heterogeneous',
                cellularity: 'high',
                mitosis: 6,
                celltype: 'astrocytic',
                gfap: 'positive',
                s100: 'positive',
                idh: 'positive',
                atrx: 'lost',
                p53: 'increased',
                olig2: 'negative',
                ki67: 20,
                'idh-ngs': 'mut-r132h',
                mgmt: 'not-done'
            },
            case2: {
                age: 52,
                location: 'emisfero',
                imaging: 'enhancement',
                cellularity: 'moderate',
                mitosis: 3,
                celltype: 'oligodendroglial',
                gfap: 'partial',
                s100: 'positive',
                idh: 'positive',
                atrx: 'retained',
                p53: 'normal',
                olig2: 'positive',
                ki67: 8,
                'idh-ngs': 'mut-r132h',
                mgmt: 'not-done'
            },
            case3: {
                age: 62,
                location: 'emisfero',
                imaging: 'ring',
                cellularity: 'high',
                mitosis: 15,
                celltype: 'glioblastic',
                gfap: 'partial',
                s100: 'negative',
                idh: 'negative',
                atrx: 'retained',
                p53: 'increased',
                olig2: 'negative',
                ki67: 45,
                'idh-ngs': 'wildtype',
                mgmt: 'methylated'
            },
            case4: {
                age: 8,
                location: 'linea-mediana',
                imaging: 'midline-diffuse',
                cellularity: 'high',
                mitosis: 12,
                celltype: 'glioblastic',
                gfap: 'partial',
                s100: 'negative',
                idh: 'negative',
                atrx: 'retained',
                p53: 'normal',
                olig2: 'negative',
                ki67: 50,
                'idh-ngs': 'wildtype',
                mgmt: 'unmethylated'
            }
        };
        
        function loadCase() {
            const caseId = document.getElementById('case-select').value;
            if (!caseId || !cases[caseId]) return;
            
            const caseData = cases[caseId];
            
            document.getElementById('age').value = caseData.age;
            document.getElementById('location').value = caseData.location;
            document.getElementById('imaging').value = caseData.imaging;
            document.getElementById('cellularity').value = caseData.cellularity;
            document.getElementById('mitosis').value = caseData.mitosis;
            document.getElementById('celltype').value = caseData.celltype;
            document.getElementById('gfap').value = caseData.gfap;
            document.getElementById('s100').value = caseData.s100;
            document.getElementById('idh').value = caseData.idh;
            document.getElementById('atrx').value = caseData.atrx;
            document.getElementById('p53').value = caseData.p53;
            document.getElementById('olig2').value = caseData.olig2;
            document.getElementById('ki67').value = caseData.ki67;
            document.getElementById('idh-ngs').value = caseData['idh-ngs'];
            document.getElementById('mgmt').value = caseData.mgmt;
        }
        
        function resetForm() {
            document.querySelectorAll('input, select').forEach(el => {
                if (el.type === 'checkbox' || el.type === 'radio') {
                    el.checked = false;
                } else if (!el.disabled) {
                    el.value = '';
                }
            });
            document.getElementById('report-container').innerHTML = '';
            document.getElementById('case-select').value = '';
        }
        
        function generateDiagnosis() {
            const data = {
                age: parseInt(document.getElementById('age').value) || 0,
                location: document.getElementById('location').value,
                imaging: document.getElementById('imaging').value,
                cellularity: document.getElementById('cellularity').value,
                mitosis: parseInt(document.getElementById('mitosis').value) || 0,
                celltype: document.getElementById('celltype').value,
                gfap: document.getElementById('gfap').value,
                s100: document.getElementById('s100').value,
                idh: document.getElementById('idh').value,
                atrx: document.getElementById('atrx').value,
                p53: document.getElementById('p53').value,
                olig2: document.getElementById('olig2').value,
                ki67: parseInt(document.getElementById('ki67').value) || 0,
                'idh-ngs': document.getElementById('idh-ngs').value,
                histFeatures: {
                    perivascular: document.getElementById('hist-perivascular').checked,
                    necrosis: document.getElementById('hist-necrosis').checked,
                    microvascular: document.getElementById('hist-microvascular').checked
                }
            };
            
            const diagnosis = computeDiagnosis(data);
            displayDiagnosis(diagnosis, data);
        }
        
        function computeDiagnosis(data) {
            let alerts = [];
            let diagnosis = {};
            
            // Determina IDH status: priorità a NGS, ma se non disponibile usa IHC
            let idhStatus = data['idh-ngs'];
            let idhFromIHC = false;
            let idhPendingRare = false;
            
            if (!idhStatus || idhStatus === '' || idhStatus === 'not-done') {
                // IDH NGS non disponibile, usa IHC
                if (data.idh === 'positive') {
                    idhStatus = 'mut-from-ihc';
                    idhFromIHC = true;
                    // IDH IHC positivo = diagnosi già fatta, non serve NGS per IDH
                } else if (data.idh === 'negative') {
                    idhStatus = 'wildtype-from-ihc';
                    idhFromIHC = true;
                    idhPendingRare = true; // Bisogna fare NGS per escludere rare
                }
            }
            
            // CHECK: IDH status ancora non disponibile - DIAGNOSI PROVVISORIA
            if (!idhStatus || idhStatus === '' || idhStatus === 'not-done') {
                alerts.push({type: 'warning', msg: '🕐 DIAGNOSI PROVVISORIA - IN ATTESA IDH STATUS (IHC e/o NGS)'});
                alerts.push({type: 'warning', msg: '⚠ IDH IHC e NGS sono FONDAMENTALI per classificazione WHO'});
                
                diagnosis.provisional = true;
                diagnosis.entity = 'Glioma diffuso (tipo da determinare - in attesa IDH)';
                diagnosis.grade = 'Grade indeterminato';
                diagnosis.confidence = 'PROVVISORIA - Pendente IDH status';
                diagnosis.alerts = alerts;
                return diagnosis;
            }
            
            // Se IDH IHC positivo: diagnosi già fatta, non serve avvertimento su NGS IDH
            if (idhFromIHC && data.idh === 'positive') {
                alerts.push({type: 'success', msg: '✓ IDH1 R132H positivo all\'IHC: mutazione confermata. NGS IDH non necessario.'});
            }
            
            // Se IDH IHC negativo: BISOGNA fare NGS per escludere rare mutazioni
            if (idhPendingRare) {
                alerts.push({type: 'warning', msg: '🕐 DIAGNOSI PROVVISORIA - IN ATTESA NGS IDH PER ESCLUDERE MUTAZIONI RARE'});
                alerts.push({type: 'warning', msg: '⚠ IDH1 R132H negativo: necessario NGS per confermare se è veramente wildtype o mutato (rare: IDH2, IDH1 non-R132H)'});
                alerts.push({type: 'warning', msg: '⚠ La classificazione WHO definitiva seguirà con ADDENDUM una volta disponibili i risultati NGS IDH1/2'});
            }
            
            alerts.push({type: 'warning', msg: '⚠ NOTA: Pannello NGS attuale limita la classificazione. Da gennaio 2026 disponibili TERT e TP53.'});
            
            // PEDIATRIC
            if (data.age < 18) {
                if (data.location === 'linea-mediana' || data.location === 'midline') {
                    diagnosis.entity = 'Glioma diffuso linea mediana (richiedere methylation profiling)';
                    diagnosis.grade = 'Grade 4 (probabile)';
                    diagnosis.confidence = 'Basso senza methylation profiling';
                    alerts.push({type: 'warning', msg: '⚠ Pediatrico linea mediana: consigliare methylation profiling per conferma H3-altered'});
                }
            }
            
            // ADULT IDH-MUTATED
            if (idhStatus === 'mut-r132h' || idhStatus === 'mut-other' || idhStatus === 'mut-from-ihc') {
                diagnosis.entity = 'Glioma diffuso, IDH-mutated (classificazione incompleta)';
                diagnosis.confidence = 'Basso - manca 1p/19q';
                
                // GRADING: mitosi + features istologiche + cellularità
                let hasAggressive = data.histFeatures && (data.histFeatures.necrosis || data.histFeatures.microvascular);
                let hasNecrosisMicro = data.histFeatures && data.histFeatures.necrosis && data.histFeatures.microvascular;
                let highCellularity = data.cellularity === 'high';
                
                // Gr. 4: necrosi + proliferazione microvascolare (anche con mitosi basse)
                if (hasNecrosisMicro) {
                    diagnosis.grade = 'WHO Grade 4';
                }
                // Gr. 3: mitosi 4-9, oppure cellularità alta, oppure features aggressive (necrosi o microvascolare)
                else if (data.mitosis >= 4 && data.mitosis <= 9 || hasAggressive || highCellularity) {
                    diagnosis.grade = 'WHO Grade 3';
                }
                // Gr. 2: mitosi <4 + cellularità bassa/moderata + nessun pattern aggressivo
                else if (data.mitosis < 4 && !hasAggressive && data.cellularity !== 'high') {
                    diagnosis.grade = 'WHO Grade 2';
                } else {
                    diagnosis.grade = 'WHO Grade 2-3';
                }
                
                if (data.atrx === 'lost') {
                    diagnosis.entity = 'Astrocytoma, IDH-mutated (ATRX loss suggestivo)';
                    alerts.push({type: 'success', msg: '✓ ATRX loss favorisce astrocitoma IDH-mut. Confermare con 1p/19q da gennaio 2026'});
                } else if (data.atrx === 'retained' && data.olig2 === 'positive') {
                    diagnosis.entity = 'Oligodendroglioma IDH-mutato (pattern favorevole)';
                    alerts.push({type: 'success', msg: '✓ ATRX retained + OLIG2+ favorisce oligodendroglioma. Confermare con 1p/19q da gennaio 2026'});
                }
            }
            
            // ADULT IDH-WILDTYPE (confermato da NGS)
            if ((idhStatus === 'wildtype') && data.age >= 18) {
                diagnosis.entity = 'Glioma diffuso, IDH-wildtype';
                diagnosis.confidence = 'Basso senza marker molecolari completi';
                
                if (data.mitosis > 10) {
                    diagnosis.grade = 'WHO Grade 4 (Glioblastoma probabile)';
                    diagnosis.entity = 'Glioblastoma, IDH-wildtype (da morfologia)';
                    alerts.push({type: 'success', msg: '✓ Mitosi elevate + IDH-wt confermato NGS: GBM probabile'});
                } else {
                    diagnosis.grade = 'Grade 2-3 (incerto senza marker molecolari)';
                    alerts.push({type: 'warning', msg: '⚠ IDH-wt a basso grado: richiedere methylation profiling'});
                }
            }
            
            diagnosis.alerts = alerts;
            return diagnosis;
        }
        
        function displayDiagnosis(diagnosis, data) {
            let html = '';
            
            if (diagnosis.alerts && diagnosis.alerts.length > 0) {
                for (let alert of diagnosis.alerts) {
                    const cls = alert.type === 'warning' ? 'alert-warning' : 'alert-success';
                    html += '<div class="alert ' + cls + '">' + alert.msg + '</div>';
                }
            }
            
            if (diagnosis.entity) {
                html += '<div class="diagnosis-box">';
                html += '<h3>Diagnosi Finale WHO CNS5</h3>';
                html += '<div class="diagnosis-text"><strong>' + diagnosis.entity + '</strong></div>';
                html += '<div class="diagnosis-text">' + diagnosis.grade + '</div>';
                html += '<div class="diagnosis-text"><strong>Livello di confidenza:</strong> ' + diagnosis.confidence + '</div>';
                html += '</div>';
            }
            
            html += '<div class="diagnosis-box" style="margin-top: 20px;">';
            html += '<h3>Riepilogo Findings</h3>';
            html += '<table style="width:100%; font-size: 12px; border-collapse: collapse;">';
            html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px; width: 50%;"><strong>Età / Sede</strong></td><td>' + (data.age || 'N/A') + ' a. / ' + data.location + '</td></tr>';
            html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>GFAP / S100 / OLIG2</strong></td><td>' + data.gfap + ' / ' + data.s100 + ' / ' + data.olig2 + '</td></tr>';
            html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>IDH (IHC+NGS)</strong></td><td>' + data.idh + ' / ' + data['idh-ngs'] + '</td></tr>';
            html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px; width: 50%;"><strong>ATRX / p53</strong></td><td>' + data.atrx + ' / ' + data.p53 + '</td></tr>';
            html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>Pattern istologico</strong></td><td>' + 
                (data.histFeatures.necrosis ? '✓ Necrosi' : '') + 
                (data.histFeatures.microvascular ? ' | ✓ Prolif. microvasc.' : '') + 
                (data.histFeatures.perivascular ? ' | ✓ Ipepl. perivascolare' : '') + 
                (!data.histFeatures.necrosis && !data.histFeatures.microvascular && !data.histFeatures.perivascular ? 'Nessuno' : '') + 
                '</td></tr>';
            html += '<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 8px;"><strong>Mitosi / Ki-67</strong></td><td>' + data.mitosis + ' / ' + data.ki67 + '%</td></tr>';
            html += '<tr style="border-top: 2px solid #ddd; background: #fff9e6;"><td style="padding: 8px;"><strong>MGMT</strong></td><td><strong>' + (document.getElementById('mgmt').value || 'Non eseguito') + '</strong></td></tr>';
            html += '</table>';
            html += '</div>';
            
            document.getElementById('report-container').innerHTML = html;
        }
        
        function exportPDF() {
            const reportElement = document.getElementById('report-container');
            
            if (!reportElement || reportElement.innerHTML.trim() === '') {
                alert('Genera prima una diagnosi per esportare il PDF');
                return;
            }
            
            const opt = {
                margin: 10,
                filename: 'Report_Glioma_' + new Date().toISOString().split('T')[0] + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
            };
            
            const pdfContent = document.createElement('div');
            pdfContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2>REPORT DIAGNOSTICO GLIOMI SNC</h2>
                    <p>Data: ${new Date().toLocaleDateString('it-IT')}</p>
                </div>
                <div style="margin-bottom: 20px; font-size: 12px;">
                    <p><strong>Età:</strong> ${document.getElementById('age').value || 'N/A'}</p>
                    <p><strong>Sede:</strong> ${document.getElementById('location').value || 'N/A'}</p>
                    <p><strong>IDH1/2 (NGS):</strong> ${document.getElementById('idh-ngs').value}</p>
                    <p><strong>Mitosi/10 HPF:</strong> ${document.getElementById('mitosis').value}</p>
                    <p><strong>MGMT:</strong> ${document.getElementById('mgmt').value || 'Non eseguito'}</p>
                </div>
                <hr>
                ${reportElement.innerHTML}
            `;
            
            html2pdf().set(opt).from(pdfContent).save();
        }
    </script>
</body>
</html>
